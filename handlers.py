from aiogram import Router, F
from aiogram.types import Message, CallbackQuery
from aiogram.filters import Command
from aiogram.exceptions import TelegramForbiddenError, TelegramBadRequest
import asyncio
import logging
import random

from keyboards import get_main_menu_keyboard, get_back_keyboard, get_new_game_keyboard, get_test_game_control_keyboard, get_lobby_keyboard, get_player_selection_keyboard, get_voting_keyboard, get_game_control_keyboard
from game_logic import game_manager
from models import GamePhase, PlayerRole
from config import MAX_PLAYERS, NIGHT_TIMEOUT_SECS, DAY_DISCUSS_TIMEOUT_SECS, VOTING_TIMEOUT_SECS
from config import BROADCAST_CHAT_ID, BROADCAST_THREAD_ID

router = Router()

# –§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ –∞–≤—Ç–æ–ø–∏–ª–æ—Ç–∞ –ø–æ chat_key
_autopilot_tasks: dict[str, asyncio.Task] = {}

logger = logging.getLogger(__name__)

# ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞/—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ –¥–ª—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –∫–æ–º–∞–Ω–¥
ADMIN_USER_ID = 833357704

# –û–∂–∏–¥–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Ä–∞—Å—Å—ã–ª–∫–∏ –≤ –õ–°: user_id -> True
_broadcast_waiting: dict[int, bool] = {}

# –ö–æ–º–∞–Ω–¥–∞ /broadcast: –∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å —Ç–µ–∫—Å—Ç–∞ —Ä–∞—Å—Å—ã–ª–∫–∏ (—Ç–æ–ª—å–∫–æ –õ–° –∏ —Ç–æ–ª—å–∫–æ ADMIN_USER_ID)
@router.message(Command("broadcast"))
async def cmd_broadcast(message: Message):
    # –¢–æ–ª—å–∫–æ –≤ –õ–°
    if message.chat.type != "private":
        return
    # –¢–æ–ª—å–∫–æ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    if message.from_user.id != ADMIN_USER_ID:
        return

    _broadcast_waiting[message.from_user.id] = True
    await message.answer(
        "‚úçÔ∏è –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç —Ä–∞—Å—Å—ã–ª–∫–∏ –æ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º. –î–ª—è –æ—Ç–º–µ–Ω—ã ‚Äî /cancel"
    )

# –û—Ç–º–µ–Ω–∞ —Ä–µ–∂–∏–º–∞ —Ä–∞—Å—Å—ã–ª–∫–∏
@router.message(Command("cancel"))
async def cmd_cancel_broadcast(message: Message):
    if message.chat.type != "private":
        return
    if message.from_user.id != ADMIN_USER_ID:
        return
    if _broadcast_waiting.pop(message.from_user.id, None):
        await message.answer("‚ùå –†–µ–∂–∏–º —Ä–∞—Å—Å—ã–ª–∫–∏ –æ—Ç–º–µ–Ω—ë–Ω")
    else:
        await message.answer("‚ÑπÔ∏è –ù–µ—á–µ–≥–æ –æ—Ç–º–µ–Ω—è—Ç—å: —Ä–µ–∂–∏–º —Ä–∞—Å—Å—ã–ª–∫–∏ –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω")

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –õ–° –≤ —Ä–µ–∂–∏–º–µ –æ–∂–∏–¥–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ —Ä–∞—Å—Å—ã–ª–∫–∏ (—Å—Ç–∞–≤–∏–º —Ä–∞–Ω—å—à–µ –æ–±—â–µ–≥–æ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–≤–∞—Ç—á–∏–∫–∞)
@router.message(F.chat.type == "private")
async def handle_broadcast_input(message: Message):
    # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—ã –∑–¥–µ—Å—å, –∏–º–∏ –∑–∞–Ω–∏–º–∞—é—Ç—Å—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Ö–µ–Ω–¥–ª–µ—Ä—ã
    if not message.text or message.text.startswith("/"):
        return
    user_id = message.from_user.id
    if user_id != ADMIN_USER_ID:
        return
    if not _broadcast_waiting.get(user_id):
        return

    # –ü–æ–ª—É—á–∏–ª–∏ —Ç–µ–∫—Å—Ç —Ä–∞—Å—Å—ã–ª–∫–∏
    content = message.text
    # –í—ã—Ö–æ–¥–∏–º –∏–∑ —Ä–µ–∂–∏–º–∞ –æ–∂–∏–¥–∞–Ω–∏—è –¥–æ –Ω–∞—á–∞–ª–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏
    _broadcast_waiting.pop(user_id, None)

    # –°–±–æ—Ä —Ü–µ–ª–µ–π: –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –∏–≥—Ä—ã (–ø–æ chat_key –≤–∏–¥–∞ chatId_threadId)
    try:
        active_keys = list(game_manager.active_games.keys())
    except Exception:
        active_keys = []

    if not active_keys:
        # –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ —Ä–µ–∑–µ—Ä–≤–Ω—É—é —Ç–µ–º—É, –µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞
        if BROADCAST_CHAT_ID != 0:
            try:
                message_thread_id = None if BROADCAST_THREAD_ID == 0 else BROADCAST_THREAD_ID
                await message.bot.send_message(
                    BROADCAST_CHAT_ID,
                    content,
                    message_thread_id=message_thread_id
                )
                await message.answer("‚úÖ –†–∞–∑–æ—Å–ª–∞–Ω–æ –≤ —Ä–µ–∑–µ—Ä–≤–Ω—É—é —Ç–µ–º—É")
                return
            except Exception as e:
                logger.warning(f"broadcast: –æ—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ —Ä–µ–∑–µ—Ä–≤–Ω—É—é —Ç–µ–º—É: {e}")
        await message.answer("‚ö†Ô∏è –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç–µ–º –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏")
        return

    sent = 0
    failed = 0
    for chat_key in active_keys:
        try:
            chat_id = get_chat_id_from_key(chat_key)
            thread_id = get_thread_id_from_key(chat_key)
            message_thread_id = None if thread_id == 0 else thread_id
            await message.bot.send_message(
                chat_id,
                content,
                message_thread_id=message_thread_id
            )
            sent += 1
            await asyncio.sleep(0.05)  # –ª–µ–≥–∫–æ–µ —Ä–∞–∑–º–µ–∂–µ–≤–∞–Ω–∏–µ, —á—Ç–æ–±—ã –Ω–µ —Å–ª–æ–≤–∏—Ç—å –ª–∏–º–∏—Ç—ã
        except TelegramForbiddenError:
            failed += 1
        except TelegramBadRequest:
            failed += 1
        except Exception as e:
            failed += 1
            logger.warning(f"broadcast: –æ—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ {chat_key}: {e}")

    await message.answer(f"‚úÖ –†–∞–∑–æ—Å–ª–∞–Ω–æ: {sent}. –û—à–∏–±–æ–∫: {failed}.")

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
@router.message(Command("start"))
async def start_command(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start - —Ç–æ–ª—å–∫–æ –¥–ª—è –õ–°, –ø–æ–ª—É—á–µ–Ω–∏–µ —Ä–æ–ª–∏"""
    user_id = message.from_user.id
    first_name = message.from_user.first_name or "–ò–≥—Ä–æ–∫"
    
    logger.info(f"start_command: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {first_name} (ID: {user_id}) –Ω–∞–ø–∏—Å–∞–ª /start")
    
    # –ö–æ–º–∞–Ω–¥–∞ /start —Ä–∞–±–æ—Ç–∞–µ—Ç –¢–û–õ–¨–ö–û –≤ –õ–°
    if message.chat.type != "private":
        # –í –≥—Ä—É–ø–ø–æ–≤—ã—Ö —á–∞—Ç–∞—Ö –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—É /start
        return
    
    # –í –õ–° –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ä–æ–ª–∏
    role_message = (
        "üé≠ Buonasera, —Å–∏–Ω—å–æ—Ä! üé≠\n\n"
        "–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ–ª—É—á–∏—Ç—å —Å–≤–æ—é —Ä–æ–ª—å –≤ –∏–≥—Ä–µ!\n\n"
        "üìã –ß—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ:\n"
        "1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –≥—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç\n"
        "2. –ù–∞–π–¥–∏—Ç–µ —Ç–µ–º—É ¬´–ò–≥—Ä–∞ –≤ ¬´–ú–∞—Ñ–∏—é¬ª¬ª\n"
        "3. –ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É /mafia\n"
        "4. –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç–µ—Å—å –∫ –∏–≥—Ä–µ\n\n"
        "‚ö†Ô∏è –í–∞–∂–Ω–æ: —Ä–æ–ª—å –≤—ã –ø–æ–ª—É—á–∏—Ç–µ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ –∏–≥—Ä–µ –≤ –≥—Ä—É–ø–ø–æ–≤–æ–º —á–∞—Ç–µ!"
    )
    
    await message.answer(role_message)

# –ü–µ—Ä–µ—Å—ã–ª–∫–∞ –õ–° –º–∞—Ñ–∏–∏ –∏—Ö —Å–æ–æ–±—â–Ω–∏–∫–∞–º –≤–æ –≤—Ä–µ–º—è –Ω–æ—á–∏
@router.message(F.chat.type == "private")
async def relay_mafia_private_chat(message: Message):
    user_id = message.from_user.id
    text = message.text or ""
    # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—ã
    if not text or text.startswith("/"):
        return
    chat_key = game_manager.get_chat_key_for_mafia_user(user_id)
    if not chat_key:
        return
    game = game_manager.get_game(chat_key)
    if not game or game.phase != GamePhase.NIGHT:
        return
    player = game.players.get(user_id)
    if not player or not player.is_alive or player.role != PlayerRole.MAFIA:
        return
    peers = game_manager.get_mafia_peers(chat_key, exclude_user_id=user_id)
    if not peers:
        return
    try:
        sender_name = message.from_user.first_name or "–ú–∞—Ñ–∏—è"
        forwarded = 0
        for peer in peers:
            try:
                await message.bot.send_message(peer.user_id, f"üòà {sender_name}: {text}")
                forwarded += 1
            except Exception as e:
                logger.debug(f"relay_mafia_private_chat: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ—Å–ª–∞—Ç—å –º–∞—Ñ–∏–∏ {peer.user_id}: {e}")
        if forwarded:
            try:
                await message.reply("üì® –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–Ω–∏–∫–∞–º")
            except Exception:
                pass
    except Exception as e:
        logger.exception(f"relay_mafia_private_chat: –æ—à–∏–±–∫–∞ –ø–µ—Ä–µ—Å—ã–ª–∫–∏: {e}")

# –†–∞–Ω–¥–æ–º–Ω—ã–µ —Ñ—Ä–∞–∑—ã –≤ –¥—É—Ö–µ –º–∞—Ñ–∏–æ–∑–∏
DON_VITTE_GREETINGS = [
    "üé≠ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, —Å–∏–Ω—å–æ—Ä—ã –∏ —Å–∏–Ω—å–æ—Ä–∏—Ç—ã. üé≠\n\n"
    "       –Ø ‚Äî –î–æ–Ω –í–∏—Ç—Ç–µ, —Ö–æ–∑—è–∏–Ω —ç—Ç–æ–≥–æ —Å—Ç–æ–ª–∞ –∏ —Ö—Ä–∞–Ω–∏—Ç–µ–ª—å —Ç–∞–π–Ω—ã—Ö –ø—Ä–∞–≤–∏–ª –≥–æ—Ä–æ–¥–∞.\n"
    "–í —ç—Ç–æ—Ç –≤–µ—á–µ—Ä –∫–∞–∂–¥—ã–π –∏–∑ –≤–∞—Å –Ω–∞–¥–µ–Ω–µ—Ç –º–∞—Å–∫—É. –ù–æ –±—É–¥—å—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã: –∑–∞ —É–ª—ã–±–∫–æ–π –º–æ–∂–µ—Ç –ø—Ä—è—Ç–∞—Ç—å—Å—è –Ω–æ–∂, "
    "–∞ –∑–∞ –¥—Ä—É–∂–µ—Å–∫–∏–º —Å–ª–æ–≤–æ–º ‚Äî —Å–º–µ—Ä—Ç–Ω—ã–π –ø—Ä–∏–≥–æ–≤–æ—Ä.\n\n"
    "üåô –ù–æ—á—å—é —É–ª–∏—Ü—ã –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—Ç –º–∞—Ñ–∏–∏. –û–Ω–∏ —Ä–µ—à–∞—é—Ç, —á—å—é –∂–∏–∑–Ω—å –æ–±–æ—Ä–≤—ë—Ç—Å—è.\n"
    "ü©∫ –î–æ–∫—Ç–æ—Ä –±—Ä–æ–¥–∏—Ç –ø–æ –ø–µ—Ä–µ—É–ª–∫–∞–º, –Ω–∞–¥–µ—è—Å—å —Å–ø–∞—Å—Ç–∏ —Ç–æ–≥–æ, –∫—Ç–æ –µ—â—ë –º–æ–∂–µ—Ç –¥—ã—à–∞—Ç—å.\n"
    "üëÆ –ö–æ–º–∏—Å—Å–∞—Ä –∏—â–µ—Ç –ø—Ä–∞–≤–¥—É, –Ω–æ –ø—Ä–∞–≤–¥–∞ —Ä–µ–¥–∫–æ –∂–∏–≤—ë—Ç –¥–æ–ª—å—à–µ —Ä–∞—Å—Å–≤–µ—Ç–∞.\n"
    "üíÉ –ê –Ω–æ—á–Ω–∞—è –±–∞–±–æ—á–∫–∞‚Ä¶ –æ–Ω–∞ –º–æ–∂–µ—Ç —Å–ø—É—Ç–∞—Ç—å –∫–∞—Ä—Ç—ã –¥–∞–∂–µ —Å–∞–º—ã–º —Å–∏–ª—å–Ω—ã–º –∏–≥—Ä–æ–∫–∞–º.\n"
    "üëî –ú–∏—Ä–Ω—ã–µ –∂–∏—Ç–µ–ª–∏ —Å–ø—è—Ç, –≤–µ—Ä—è, —á—Ç–æ –∏—Ö –¥–æ–º ‚Äî –∫—Ä–µ–ø–æ—Å—Ç—å. –ù–æ –≤ —ç—Ç–æ–º –≥–æ—Ä–æ–¥–µ –∫—Ä–µ–ø–æ—Å—Ç–µ–π –Ω–µ—Ç.\n\n"
    "‚òÄÔ∏è –î–Ω—ë–º –∂–µ –≤–∞—Å –∂–¥—É—Ç –≥—Ä–æ–º–∫–∏–µ —Ä–µ—á–∏, –æ–±–≤–∏–Ω–µ–Ω–∏—è –∏ —Ç—è–∂—ë–ª—ã–π –≤—ã–±–æ—Ä. "
    "–ö–∞–∂–¥–æ–µ —Å–ª–æ–≤–æ –º–æ–∂–µ—Ç —Å—Ç–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–º –≥–≤–æ–∑–¥—ë–º –≤ —á—É–∂–æ–π –≥—Ä–æ–±, "
    "–∏–ª–∏ ‚Äî –≤ –≤–∞—à —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π.\n\n"
    "üíº –ó–¥–µ—Å—å –≤—ã–∂–∏–≤–µ—Ç –Ω–µ —Ç–æ—Ç, –∫—Ç–æ —á–µ—Å—Ç–µ–Ω, –∞ —Ç–æ—Ç, –∫—Ç–æ —Ö–∏—Ç—ë—Ä. "
    "–¢–æ—Ç, –∫—Ç–æ —Å—É–º–µ–µ—Ç —É–±–µ–¥–∏—Ç—å –¥—Ä—É–≥–∏—Ö –≤ —Å–≤–æ–µ–π –ø—Ä–∞–≤–æ—Ç–µ‚Ä¶ –¥–∞–∂–µ –µ—Å–ª–∏ –µ–≥–æ —Ä—É–∫–∏ –≤ –∫—Ä–æ–≤–∏.\n\n"
    "       –ù—É —á—Ç–æ, –≥–æ—Ç–æ–≤—ã —Å—ã–≥—Ä–∞—Ç—å –≤ —ç—Ç—É –º–∞–ª–µ–Ω—å–∫—É—é –∏–≥—Ä—É —Å—É–¥—å–±—ã? –î–ª—è –Ω–∞—á–∞–ª–∞ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ –Ω–∞–ø–∏—Å–∞–ª–∏ –º–Ω–µ /start, –∏–Ω–∞—á–µ –Ω–µ –ø–æ–ª—É—á–∏—Ç–µ —Ä–æ–ª—å, –∞ –±–µ–∑ —Ä–æ–ª–∏ –≤—ã ‚Äî –Ω–∏–∫—Ç–æ.\n"
    "       ‚ö†Ô∏è –ò –ø–æ–º–Ω–∏—Ç–µ, –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ–π–¥—ë—Ç –Ω–µ —Ç–∞–∫ –∏–ª–∏ –≤–æ–∑–Ω–∏–∫–Ω—É—Ç –≤–æ–ø—Ä–æ—Å—ã –ø–æ –∏–≥—Ä–µ ‚Äî –º–æ—ë –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ–µ —É—Ö–æ –≥–æ—Ç–æ–≤–æ –ø–æ–º–æ—á—å: @gazonokosilkins.\n"
    "       –û–Ω —Å–ª–µ–¥–∏—Ç, —á—Ç–æ–±—ã –≤—Å—ë —à–ª–æ –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º, –Ω–æ –ø—Ä–∏ —ç—Ç–æ–º –æ—Å—Ç–∞—ë—Ç—Å—è –≤ —Ç–µ–Ω–∏, –∫–∞–∫ –∏ –ø–æ–¥–æ–±–∞–µ—Ç –Ω–∞—Å—Ç–æ—è—â–µ–º—É —Å–∏–Ω—å–æ—Ä—É.\n\n"
    "–¢–µ–ø–µ—Ä—å –≤—ã–±–∏—Ä–∞–π—Ç–µ —Å–≤–æ—ë –¥–µ–π—Å—Ç–≤–∏–µ:",

    "üé≠ –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é –≤–∞—Å, —É–≤–∞–∂–∞–µ–º—ã–µ —Å–∏–Ω—å–æ—Ä—ã! üé≠\n\n"
    "       –Ø ‚Äî –î–æ–Ω –í–∏—Ç—Ç–µ, –∏ —Å–µ–≥–æ–¥–Ω—è –≤–µ—á–µ—Ä–æ–º –º—ã —Å—ã–≥—Ä–∞–µ–º –≤ –∏–≥—Ä—É, –≥–¥–µ —Å—Ç–∞–≤–∫–∏ ‚Äî —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–µ –∂–∏–∑–Ω–∏.\n"
    "–í —ç—Ç–æ–º –≥–æ—Ä–æ–¥–µ –∫–∞–∂–¥—ã–π –Ω–æ—Å–∏—Ç –º–∞—Å–∫—É, –Ω–æ –Ω–µ –≤—Å–µ –º–∞—Å–∫–∏ –æ–¥–∏–Ω–∞–∫–æ–≤–æ –æ–ø–∞—Å–Ω—ã.\n\n"
    "üåô –ö–æ–≥–¥–∞ —Å–æ–ª–Ω—Ü–µ —Å–∞–¥–∏—Ç—Å—è, –ø—Ä–æ—Å—ã–ø–∞–µ—Ç—Å—è –Ω–∞—Å—Ç–æ—è—â–∞—è –≤–ª–∞—Å—Ç—å. –ú–∞—Ñ–∏—è –≤—ã—Ö–æ–¥–∏—Ç –Ω–∞ –æ—Ö–æ—Ç—É, "
    "–¥–æ–∫—Ç–æ—Ä –ø—ã—Ç–∞–µ—Ç—Å—è —Å–ø–∞—Å—Ç–∏ –æ–±—Ä–µ—á—ë–Ω–Ω—ã—Ö, –∫–æ–º–∏—Å—Å–∞—Ä –∏—â–µ—Ç –ø—Ä–∞–≤–¥—É –≤ —Ç–µ–Ω–∏, "
    "–∞ –Ω–æ—á–Ω–∞—è –±–∞–±–æ—á–∫–∞ –ø–ª–µ—Ç—ë—Ç —Å–≤–æ–∏ –∫–æ–≤–∞—Ä–Ω—ã–µ —Å–µ—Ç–∏.\n\n"
    "‚òÄÔ∏è –î–Ω—ë–º –≥–æ—Ä–æ–¥ –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –∞—Ä–µ–Ω—É –¥–ª—è –ø–æ–¥–æ–∑—Ä–µ–Ω–∏–π –∏ –æ–±–≤–∏–Ω–µ–Ω–∏–π. "
    "–ö–∞–∂–¥–æ–µ —Å–ª–æ–≤–æ –º–æ–∂–µ—Ç —Å—Ç–∞—Ç—å –ø—Ä–∏–≥–æ–≤–æ—Ä–æ–º, –∫–∞–∂–¥–æ–µ –º–æ–ª—á–∞–Ω–∏–µ ‚Äî –ø—Ä–∏–∑–Ω–∞–Ω–∏–µ–º –≤–∏–Ω—ã.\n\n"
    "üíº –ü–æ–º–Ω–∏—Ç–µ, —Å–∏–Ω—å–æ—Ä—ã: –≤ —ç—Ç–æ–π –∏–≥—Ä–µ –≤—ã–∂–∏–≤–∞–µ—Ç –Ω–µ —Å–∞–º—ã–π —á–µ—Å—Ç–Ω—ã–π, –∞ —Å–∞–º—ã–π —Ö–∏—Ç—Ä—ã–π. "
    "–¢–æ—Ç, –∫—Ç–æ —É–º–µ–µ—Ç —á–∏—Ç–∞—Ç—å –º–µ–∂–¥—É —Å—Ç—Ä–æ–∫ –∏ –≤–∏–¥–µ—Ç—å —Ç–æ, —á—Ç–æ —Å–∫—Ä—ã—Ç–æ –æ—Ç –≥–ª–∞–∑ –ø—Ä–æ—Å—Ç—ã—Ö —Å–º–µ—Ä—Ç–Ω—ã—Ö.\n\n"
    "       –ü—Ä–µ–∂–¥–µ —á–µ–º –Ω–∞—á–∞—Ç—å, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ –Ω–∞–ø–∏—Å–∞–ª–∏ –º–Ω–µ /start. –ë–µ–∑ —Ä–æ–ª–∏ –≤—ã ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–µ—à–∫–∏ –Ω–∞ –¥–æ—Å–∫–µ.\n"
    "       ‚ö†Ô∏è –ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–Ω—É—Ç –≤–æ–ø—Ä–æ—Å—ã ‚Äî –º–æ–π –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ @gazonokosilkins –≤—Å–µ–≥–¥–∞ –≥–æ—Ç–æ–≤ –ø–æ–º–æ—á—å.\n\n"
    "–¢–µ–ø–µ—Ä—å –≤—ã–±–∏—Ä–∞–π—Ç–µ —Å–≤–æ—ë –¥–µ–π—Å—Ç–≤–∏–µ:",

    "üé≠ Salve, —Å–∏–Ω—å–æ—Ä—ã! üé≠\n\n"
    "       –Ø ‚Äî –î–æ–Ω –í–∏—Ç—Ç–µ, –∏ —Å–µ–≥–æ–¥–Ω—è –º—ã –ø–æ–≥—Ä—É–∑–∏–º—Å—è –≤ –º–∏—Ä, –≥–¥–µ –ø—Ä–∞–≤–¥–∞ ‚Äî —Ä–æ—Å–∫–æ—à—å, –∞ –ª–æ–∂—å ‚Äî –∏—Å–∫—É—Å—Å—Ç–≤–æ.\n"
    "–í —ç—Ç–æ–º –≥–æ—Ä–æ–¥–µ –∫–∞–∂–¥—ã–π –∏–≥—Ä–æ–∫ ‚Äî –∞–∫—Ç—ë—Ä –≤ —Ç–µ–∞—Ç—Ä–µ –∂–∏–∑–Ω–∏ –∏ —Å–º–µ—Ä—Ç–∏.\n\n"
    "üåô –ù–æ—á—å—é –≥–æ—Ä–æ–¥ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —Ç–µ–º, –∫—Ç–æ –Ω–µ –±–æ–∏—Ç—Å—è –∫—Ä–æ–≤–∏ –Ω–∞ —Ä—É–∫–∞—Ö. "
    "–ú–∞—Ñ–∏—è –≤—ã–±–∏—Ä–∞–µ—Ç –∂–µ—Ä—Ç–≤, –¥–æ–∫—Ç–æ—Ä –ø—ã—Ç–∞–µ—Ç—Å—è –∏—Å–ø—Ä–∞–≤–∏—Ç—å –∏—Ö –æ—à–∏–±–∫–∏, "
    "–∫–æ–º–∏—Å—Å–∞—Ä –∏—â–µ—Ç –ø—Ä–µ–¥–∞—Ç–µ–ª–µ–π, –∞ –±–∞–±–æ—á–∫–∞ —Å–æ–∑–¥–∞—ë—Ç —Ö–∞–æ—Å.\n\n"
    "‚òÄÔ∏è –î–Ω—ë–º –≤—Å–µ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –¥–µ—Ç–µ–∫—Ç–∏–≤–∞–º–∏ –∏ –ø—Ä–æ–∫—É—Ä–æ—Ä—ã –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ. "
    "–û–±–≤–∏–Ω–µ–Ω–∏—è –ª–µ—Ç—è—Ç, –∫–∞–∫ –ø—É–ª–∏, –∞ –∑–∞—â–∏—Ç–∞ —Å—Ç—Ä–æ–∏—Ç—Å—è –Ω–∞ —Ö–∏—Ç—Ä–æ—Å—Ç–∏ –∏ –∫—Ä–∞—Å–Ω–æ—Ä–µ—á–∏–∏.\n\n"
    "üíº –í —ç—Ç–æ–π –∏–≥—Ä–µ –Ω–µ—Ç –º–µ—Å—Ç–∞ —Å–∞–Ω—Ç–∏–º–µ–Ω—Ç–∞–º. –í—ã–∂–∏–≤–∞–µ—Ç —Ç–æ—Ç, –∫—Ç–æ —É–º–µ–µ—Ç –¥—É–º–∞—Ç—å –∫–∞–∫ –ø—Ä–µ—Å—Ç—É–ø–Ω–∏–∫, "
    "–Ω–æ –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å –∫–∞–∫ –ø—Ä–∞–≤–µ–¥–Ω–∏–∫.\n\n"
    "       –ù–µ –∑–∞–±—É–¥—å—Ç–µ –Ω–∞–ø–∏—Å–∞—Ç—å /start ‚Äî –±–µ–∑ —Ä–æ–ª–∏ –≤—ã –±–µ—Å–ø–æ–º–æ—â–Ω—ã.\n"
    "       ‚ö†Ô∏è –ü–æ–º–æ—â—å –≤—Å–µ–≥–¥–∞ —Ä—è–¥–æ–º: @gazonokosilkins.\n\n"
    "–¢–µ–ø–µ—Ä—å –≤—ã–±–∏—Ä–∞–π—Ç–µ —Å–≤–æ—ë –¥–µ–π—Å—Ç–≤–∏–µ:",

    "üé≠ Buonasera, –¥–æ—Ä–æ–≥–∏–µ –¥—Ä—É–∑—å—è! üé≠\n\n"
    "       –Ø ‚Äî –î–æ–Ω –í–∏—Ç—Ç–µ, –∏ —Å–µ–≥–æ–¥–Ω—è –º—ã —Å—ã–≥—Ä–∞–µ–º –≤ –∏–≥—Ä—É, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∏—Ç –≤–∞—à—É —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –∫ –≤—ã–∂–∏–≤–∞–Ω–∏—é.\n"
    "–í —ç—Ç–æ–º –≥–æ—Ä–æ–¥–µ –∫–∞–∂–¥—ã–π ‚Äî –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∂–µ—Ä—Ç–≤–∞ –∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π —É–±–∏–π—Ü–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.\n\n"
    "üåô –ù–æ—á—å—é –ø—Ä–æ—Å—ã–ø–∞—é—Ç—Å—è –∏—Å—Ç–∏–Ω–Ω—ã–µ —Ö–æ–∑—è–µ–≤–∞ –≥–æ—Ä–æ–¥–∞. "
    "–ú–∞—Ñ–∏—è —Ä–µ—à–∞–µ—Ç —Å—É–¥—å–±—ã, –¥–æ–∫—Ç–æ—Ä –ø—ã—Ç–∞–µ—Ç—Å—è –∏—Ö –∏–∑–º–µ–Ω–∏—Ç—å, "
    "–∫–æ–º–∏—Å—Å–∞—Ä –∏—â–µ—Ç —É–ª–∏–∫–∏, –∞ –±–∞–±–æ—á–∫–∞ –ø—É—Ç–∞–µ—Ç —Å–ª–µ–¥—ã.\n\n"
    "‚òÄÔ∏è –î–Ω—ë–º –≥–æ—Ä–æ–¥ –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ —Å—É–¥, –≥–¥–µ –∫–∞–∂–¥—ã–π ‚Äî –∏ —Å—É–¥—å—è, –∏ –ø–æ–¥—Å—É–¥–∏–º—ã–π. "
    "–í–∞—à–∞ –∑–∞–¥–∞—á–∞ ‚Äî –Ω–∞–π—Ç–∏ –≤–∏–Ω–æ–≤–Ω—ã—Ö, –Ω–µ —Å—Ç–∞–≤ –æ–¥–Ω–∏–º –∏–∑ –Ω–∏—Ö.\n\n"
    "üíº –ü–æ–º–Ω–∏—Ç–µ: –≤ —ç—Ç–æ–π –∏–≥—Ä–µ —á–µ—Å—Ç–Ω–æ—Å—Ç—å ‚Äî —Å–ª–∞–±–æ—Å—Ç—å, –∞ —Ö–∏—Ç—Ä–æ—Å—Ç—å ‚Äî —Å–∏–ª–∞. "
    "–í—ã–∂–∏–≤–∞–µ—Ç —Ç–æ—Ç, –∫—Ç–æ —É–º–µ–µ—Ç –∏–≥—Ä–∞—Ç—å –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º, –Ω–µ —Å–æ–±–ª—é–¥–∞—è –∏—Ö.\n\n"
    "       –ù–∞–ø–∏—à–∏—Ç–µ /start –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–æ–ª–∏ ‚Äî –±–µ–∑ –Ω–µ—ë –≤—ã –æ–±—Ä–µ—á–µ–Ω—ã.\n"
    "       ‚ö†Ô∏è –í–æ–ø—Ä–æ—Å—ã? –û–±—Ä–∞—â–∞–π—Ç–µ—Å—å –∫ @gazonokosilkins.\n\n"
    "–¢–µ–ø–µ—Ä—å –≤—ã–±–∏—Ä–∞–π—Ç–µ —Å–≤–æ—ë –¥–µ–π—Å—Ç–≤–∏–µ:",

    "üé≠ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–∏—Ä —Ç–µ–Ω–µ–π, —Å–∏–Ω—å–æ—Ä—ã! üé≠\n\n"
    "       –Ø ‚Äî –î–æ–Ω –í–∏—Ç—Ç–µ, –∏ —Å–µ–≥–æ–¥–Ω—è –º—ã —Å—ã–≥—Ä–∞–µ–º –≤ –∏–≥—Ä—É, –≥–¥–µ —Å—Ç–∞–≤–∫–∏ –≤—ã—à–µ, —á–µ–º –≤ –ª—é–±–æ–º –∫–∞–∑–∏–Ω–æ.\n"
    "–í —ç—Ç–æ–º –≥–æ—Ä–æ–¥–µ –∫–∞–∂–¥—ã–π –∏–≥—Ä–æ–∫ ‚Äî –ª–∏–±–æ –æ—Ö–æ—Ç–Ω–∏–∫, –ª–∏–±–æ –¥–æ–±—ã—á–∞.\n\n"
    "üåô –ö–æ–≥–¥–∞ –Ω–∞—Å—Ç—É–ø–∞–µ—Ç –Ω–æ—á—å, –ø—Ä–æ—Å—ã–ø–∞—é—Ç—Å—è —Ç–µ, –∫—Ç–æ –Ω–µ –±–æ–∏—Ç—Å—è —Ç—ë–º–Ω—ã—Ö –¥–µ–ª. "
    "–ú–∞—Ñ–∏—è –≤—ã–±–∏—Ä–∞–µ—Ç —Ü–µ–ª–∏, –¥–æ–∫—Ç–æ—Ä –ø—ã—Ç–∞–µ—Ç—Å—è –∏—Ö —Å–ø–∞—Å—Ç–∏, "
    "–∫–æ–º–∏—Å—Å–∞—Ä –∏—â–µ—Ç –ø—Ä–∞–≤–¥—É, –∞ –±–∞–±–æ—á–∫–∞ —Å–æ–∑–¥–∞—ë—Ç –Ω–µ—Ä–∞–∑–±–µ—Ä–∏—Ö—É.\n\n"
    "‚òÄÔ∏è –î–Ω—ë–º –≥–æ—Ä–æ–¥ –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –ø–æ–ª–µ –±–∏—Ç–≤—ã —É–º–æ–≤. "
    "–ö–∞–∂–¥–æ–µ —Å–ª–æ–≤–æ –º–æ–∂–µ—Ç —Å—Ç–∞—Ç—å –æ—Ä—É–∂–∏–µ–º, –∫–∞–∂–¥–æ–µ –º–æ–ª—á–∞–Ω–∏–µ ‚Äî –ø—Ä–∏–∑–Ω–∞–Ω–∏–µ–º.\n\n"
    "üíº –í —ç—Ç–æ–π –∏–≥—Ä–µ –Ω–µ—Ç –º–µ—Å—Ç–∞ –¥–ª—è —Å–ª–∞–±–æ—Å—Ç–∏. –í—ã–∂–∏–≤–∞–µ—Ç —Ç–æ—Ç, –∫—Ç–æ —É–º–µ–µ—Ç —á–∏—Ç–∞—Ç—å –ª—é–¥–µ–π "
    "–∏ –º–∞–Ω–∏–ø—É–ª–∏—Ä–æ–≤–∞—Ç—å –∏—Ö —Å—Ç—Ä–∞—Ö–∞–º–∏.\n\n"
    "       –ù–µ –∑–∞–±—É–¥—å—Ç–µ /start ‚Äî —Ä–æ–ª—å –¥–∞—ë—Ç —Å–∏–ª—É.\n"
    "       ‚ö†Ô∏è –ü–æ–º–æ—â—å: @gazonokosilkins.\n\n"
    "–¢–µ–ø–µ—Ä—å –≤—ã–±–∏—Ä–∞–π—Ç–µ —Å–≤–æ—ë –¥–µ–π—Å—Ç–≤–∏–µ:",

    "üé≠ –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é –≤–∞—Å, —É–≤–∞–∂–∞–µ–º—ã–µ —Å–∏–Ω—å–æ—Ä—ã! üé≠\n\n"
    "       –Ø ‚Äî –î–æ–Ω –í–∏—Ç—Ç–µ, –∏ —Å–µ–≥–æ–¥–Ω—è –º—ã –ø–æ–≥—Ä—É–∑–∏–º—Å—è –≤ –º–∏—Ä, –≥–¥–µ –º–æ—Ä–∞–ª—å ‚Äî –ø–æ–Ω—è—Ç–∏–µ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ–µ.\n"
    "–í —ç—Ç–æ–º –≥–æ—Ä–æ–¥–µ –∫–∞–∂–¥—ã–π ‚Äî –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –≥–µ—Ä–æ–π –∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –∑–ª–æ–¥–µ–π.\n\n"
    "üåô –ù–æ—á—å—é –≥–æ—Ä–æ–¥ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —Ç–µ–º, –∫—Ç–æ –Ω–µ –±–æ–∏—Ç—Å—è –ø—Ä–∏–Ω–∏–º–∞—Ç—å —Å–ª–æ–∂–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è. "
    "–ú–∞—Ñ–∏—è —É–±–∏–≤–∞–µ—Ç, –¥–æ–∫—Ç–æ—Ä —Å–ø–∞—Å–∞–µ—Ç, –∫–æ–º–∏—Å—Å–∞—Ä —Ä–∞—Å—Å–ª–µ–¥—É–µ—Ç, –±–∞–±–æ—á–∫–∞ –∑–∞–ø—É—Ç—ã–≤–∞–µ—Ç.\n\n"
    "‚òÄÔ∏è –î–Ω—ë–º –≤—Å–µ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏ –¥–µ—Ç–µ–∫—Ç–∏–≤–Ω–æ–≥–æ —Ä–æ–º–∞–Ω–∞. "
    "–í–∞—à–∞ –∑–∞–¥–∞—á–∞ ‚Äî —Ä–∞–∑–≥–∞–¥–∞—Ç—å –∑–∞–≥–∞–¥–∫—É, –Ω–µ —Å—Ç–∞–≤ –µ—ë –∂–µ—Ä—Ç–≤–æ–π.\n\n"
    "üíº –ü–æ–º–Ω–∏—Ç–µ: –≤ —ç—Ç–æ–π –∏–≥—Ä–µ –≤—ã–∂–∏–≤–∞–µ—Ç –Ω–µ —Å–∞–º—ã–π —É–º–Ω—ã–π, –∞ —Å–∞–º—ã–π –ø—Ä–æ–Ω–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π. "
    "–¢–æ—Ç, –∫—Ç–æ —É–º–µ–µ—Ç –≤–∏–¥–µ—Ç—å —Ç–æ, —á—Ç–æ —Å–∫—Ä—ã—Ç–æ –æ—Ç –¥—Ä—É–≥–∏—Ö.\n\n"
    "       –ù–∞–ø–∏—à–∏—Ç–µ /start –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–æ–ª–∏.\n"
    "       ‚ö†Ô∏è –í–æ–ø—Ä–æ—Å—ã –∫ @gazonokosilkins.\n\n"
    "–¢–µ–ø–µ—Ä—å –≤—ã–±–∏—Ä–∞–π—Ç–µ —Å–≤–æ—ë –¥–µ–π—Å—Ç–≤–∏–µ:",

    "üé≠ Salve, –¥–æ—Ä–æ–≥–∏–µ —Å–∏–Ω—å–æ—Ä—ã! üé≠\n\n"
    "       –Ø ‚Äî –î–æ–Ω –í–∏—Ç—Ç–µ, –∏ —Å–µ–≥–æ–¥–Ω—è –º—ã —Å—ã–≥—Ä–∞–µ–º –≤ –∏–≥—Ä—É, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∏—Ç –≤–∞—à—É —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –∫ –∞–Ω–∞–ª–∏–∑—É.\n"
    "–í —ç—Ç–æ–º –≥–æ—Ä–æ–¥–µ –∫–∞–∂–¥—ã–π –∏–≥—Ä–æ–∫ ‚Äî –∑–∞–≥–∞–¥–∫–∞, –∫–æ—Ç–æ—Ä—É—é –Ω—É–∂–Ω–æ —Ä–∞–∑–≥–∞–¥–∞—Ç—å.\n\n"
    "üåô –ù–æ—á—å—é –ø—Ä–æ—Å—ã–ø–∞—é—Ç—Å—è –∏—Å—Ç–∏–Ω–Ω—ã–µ –º–∞—Å—Ç–µ—Ä–∞ –∏–≥—Ä—ã. "
    "–ú–∞—Ñ–∏—è –ø–ª–∞–Ω–∏—Ä—É–µ—Ç, –¥–æ–∫—Ç–æ—Ä –∑–∞—â–∏—â–∞–µ—Ç, –∫–æ–º–∏—Å—Å–∞—Ä –∏—â–µ—Ç, –±–∞–±–æ—á–∫–∞ –æ—Ç–≤–ª–µ–∫–∞–µ—Ç.\n\n"
    "‚òÄÔ∏è –î–Ω—ë–º –≥–æ—Ä–æ–¥ –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—é –ø–æ –∏–∑—É—á–µ–Ω–∏—é —á–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–π –ø—Ä–∏—Ä–æ–¥—ã. "
    "–ö–∞–∂–¥—ã–π –∂–µ—Å—Ç, –∫–∞–∂–¥–æ–µ —Å–ª–æ–≤–æ ‚Äî –ø–æ–¥—Å–∫–∞–∑–∫–∞ –∫ —Ä–∞–∑–≥–∞–¥–∫–µ.\n\n"
    "üíº –í —ç—Ç–æ–π –∏–≥—Ä–µ –≤—ã–∂–∏–≤–∞–µ—Ç —Ç–æ—Ç, –∫—Ç–æ —É–º–µ–µ—Ç —Å–æ–µ–¥–∏–Ω—è—Ç—å —Ä–∞–∑—Ä–æ–∑–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–∫—Ç—ã "
    "–≤ –µ–¥–∏–Ω—É—é –∫–∞—Ä—Ç–∏–Ω—É –ø—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏—è.\n\n"
    "       –ù–µ –∑–∞–±—É–¥—å—Ç–µ /start –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–æ–ª–∏.\n"
    "       ‚ö†Ô∏è –ü–æ–º–æ—â—å: @gazonokosilkins.\n\n"
    "–¢–µ–ø–µ—Ä—å –≤—ã–±–∏—Ä–∞–π—Ç–µ —Å–≤–æ—ë –¥–µ–π—Å—Ç–≤–∏–µ:",

    "üé≠ Buonasera, —Å–∏–Ω—å–æ—Ä—ã! üé≠\n\n"
    "       –Ø ‚Äî –î–æ–Ω –í–∏—Ç—Ç–µ, –∏ —Å–µ–≥–æ–¥–Ω—è –º—ã —Å—ã–≥—Ä–∞–µ–º –≤ –∏–≥—Ä—É, –≥–¥–µ –∫–∞–∂–¥—ã–π ‚Äî –∏ —Å—É–¥—å—è, –∏ –ø–∞–ª–∞—á.\n"
    "–í —ç—Ç–æ–º –≥–æ—Ä–æ–¥–µ –Ω–µ—Ç –º–µ—Å—Ç–∞ –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö —Ä–µ—à–µ–Ω–∏–π.\n\n"
    "üåô –ö–æ–≥–¥–∞ –Ω–∞—Å—Ç—É–ø–∞–µ—Ç –Ω–æ—á—å, –ø—Ä–æ—Å—ã–ø–∞—é—Ç—Å—è —Ç–µ, –∫—Ç–æ –Ω–µ –±–æ–∏—Ç—Å—è –ø—Ä–∏–Ω–∏–º–∞—Ç—å –Ω–∞ —Å–µ–±—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å. "
    "–ú–∞—Ñ–∏—è —Ä–µ—à–∞–µ—Ç —Å—É–¥—å–±—ã, –¥–æ–∫—Ç–æ—Ä –ø—ã—Ç–∞–µ—Ç—Å—è –∏—Ö –∏–∑–º–µ–Ω–∏—Ç—å, "
    "–∫–æ–º–∏—Å—Å–∞—Ä –∏—â–µ—Ç –∏—Å—Ç–∏–Ω—É, –∞ –±–∞–±–æ—á–∫–∞ —Å–æ–∑–¥–∞—ë—Ç —Ö–∞–æ—Å.\n\n"
    "‚òÄÔ∏è –î–Ω—ë–º –≥–æ—Ä–æ–¥ –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ —Ç–µ–∞—Ç—Ä, –≥–¥–µ –∫–∞–∂–¥—ã–π ‚Äî –∏ –∞–∫—Ç—ë—Ä, –∏ –∑—Ä–∏—Ç–µ–ª—å. "
    "–í–∞—à–∞ –∑–∞–¥–∞—á–∞ ‚Äî —Ä–∞–∑–≥–∞–¥–∞—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–π, –Ω–µ —Å—Ç–∞–≤ –µ–≥–æ –∂–µ—Ä—Ç–≤–æ–π.\n\n"
    "üíº –ü–æ–º–Ω–∏—Ç–µ: –≤ —ç—Ç–æ–π –∏–≥—Ä–µ –≤—ã–∂–∏–≤–∞–µ—Ç —Ç–æ—Ç, –∫—Ç–æ —É–º–µ–µ—Ç –∏–≥—Ä–∞—Ç—å –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º, "
    "–Ω–µ –ø–æ–¥—á–∏–Ω—è—è—Å—å –∏–º –ø–æ–ª–Ω–æ—Å—Ç—å—é.\n\n"
    "       –ù–∞–ø–∏—à–∏—Ç–µ /start –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–æ–ª–∏.\n"
    "       ‚ö†Ô∏è –í–æ–ø—Ä–æ—Å—ã –∫ @gazonokosilkins.\n\n"
    "–¢–µ–ø–µ—Ä—å –≤—ã–±–∏—Ä–∞–π—Ç–µ —Å–≤–æ—ë –¥–µ–π—Å—Ç–≤–∏–µ:"
]

NIGHT_PHASE_MESSAGES = [
    "üåô –ì–æ—Ä–æ–¥ –∑–∞—Å—ã–ø–∞–µ—Ç... –ª–∏—à—å –º–∞—Ñ–∏–æ–∑–∏ –∏ –ø—Ä–æ—á–∞—è –±—Ä–∞—Ç–≤–∞ –≤—ã—Ö–æ–¥—è—Ç –Ω–∞ –æ—Ö–æ—Ç—É.",
    "üåô –¢–µ–Ω–∏ —Å–≥—É—â–∞—é—Ç—Å—è –Ω–∞–¥ –≥–æ—Ä–æ–¥–æ–º... –≤—Ä–µ–º—è –¥–ª—è —Ç—ë–º–Ω—ã—Ö –¥–µ–ª.",
    "üåô –ù–æ—á—å –æ–ø—É—Å—Ç–∏–ª–∞—Å—å –Ω–∞ –≥–æ—Ä–æ–¥... –º–∞—Ñ–∏—è –≤—ã—Ö–æ–¥–∏—Ç –Ω–∞ —É–ª–∏—Ü—ã.",
    "üåô –ì–æ—Ä–æ–¥ –ø–æ–≥—Ä—É–∂–∞–µ—Ç—Å—è –≤–æ —Ç—å–º—É... –±—Ä–∞—Ç–≤–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç —Å–≤–æ—é —Ä–∞–±–æ—Ç—É.",
    "üåô –ó–≤—ë–∑–¥—ã —Å–∫—Ä—ã–ª–∏—Å—å –∑–∞ —Ç—É—á–∞–º–∏... –≤—Ä–µ–º—è –¥–ª—è –Ω–æ—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π.",
    "üåô –õ—É–Ω–∞ –æ—Å–≤–µ—â–∞–µ—Ç –ø—É—Å—Ç—ã–µ —É–ª–∏—Ü—ã... –º–∞—Ñ–∏—è –≤—ã–±–∏—Ä–∞–µ—Ç —Ü–µ–ª–∏.",
    "üåô –ì–æ—Ä–æ–¥ –∑–∞—Ç–∏—Ö... –ª–∏—à—å –ø—Ä–µ—Å—Ç—É–ø–Ω–∏–∫–∏ –Ω–µ —Å–ø—è—Ç.",
    "üåô –¢—å–º–∞ –æ–∫—É—Ç–∞–ª–∞ –≥–æ—Ä–æ–¥... –±—Ä–∞—Ç–≤–∞ –≤—ã—Ö–æ–¥–∏—Ç –Ω–∞ –æ—Ö–æ—Ç—É."
]

DAY_PHASE_MESSAGES = [
    "‚òÄÔ∏è –î–µ–Ω—å –Ω–∞—Å—Ç—É–ø–∏–ª! üó£Ô∏è –û–±—Å—É–∂–¥–µ–Ω–∏–µ –Ω–∞—á–∞–ª–æ—Å—å. –£ –≤–∞—Å –Ω–µ–º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏, —Å–∏–Ω—å–æ—Ä—ã.",
    "‚òÄÔ∏è –°–æ–ª–Ω—Ü–µ –≤—Å—Ç–∞–ª–æ –Ω–∞–¥ –≥–æ—Ä–æ–¥–æ–º! –í—Ä–µ–º—è –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏–π –∏ –ø–æ–¥–æ–∑—Ä–µ–Ω–∏–π.",
    "‚òÄÔ∏è –ù–æ–≤—ã–π –¥–µ–Ω—å –ø—Ä–∏—à—ë–ª! –ì–æ—Ä–æ–¥ –ø—Ä–æ—Å—ã–ø–∞–µ—Ç—Å—è –¥–ª—è –∂–∞—Ä–∫–∏—Ö –¥–µ–±–∞—Ç–æ–≤.",
    "‚òÄÔ∏è –†–∞—Å—Å–≤–µ—Ç –Ω–∞—Å—Ç—É–ø–∏–ª! –í—Ä–µ–º—è —Ä–∞–∑–æ–±–ª–∞—á–∞—Ç—å –ø—Ä–µ–¥–∞—Ç–µ–ª–µ–π.",
    "‚òÄÔ∏è –î–µ–Ω—å –Ω–∞—á–∞–ª—Å—è! –ì–æ—Ä–æ–¥ –≥–æ—Ç–æ–≤ –∫ –æ–±—Å—É–∂–¥–µ–Ω–∏—é –Ω–æ—á–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π.",
    "‚òÄÔ∏è –°–æ–ª–Ω—Ü–µ –æ—Å–≤–µ—Ç–∏–ª–æ –≥–æ—Ä–æ–¥! –í—Ä–µ–º—è –¥–ª—è –¥–µ—Ç–µ–∫—Ç–∏–≤–Ω–æ–π —Ä–∞–±–æ—Ç—ã.",
    "‚òÄÔ∏è –ù–æ–≤—ã–π –¥–µ–Ω—å! –ì–æ—Ä–æ–¥ –ø—Ä–æ—Å—ã–ø–∞–µ—Ç—Å—è –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤–∏–Ω–æ–≤–Ω—ã—Ö.",
    "‚òÄÔ∏è –†–∞—Å—Å–≤–µ—Ç! –í—Ä–µ–º—è –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –Ω–æ—á–Ω—ã–µ –ø—Ä–æ–∏—Å—à–µ—Å—Ç–≤–∏—è."
]

VOTING_START_MESSAGES = [
    "üó≥Ô∏è –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ! –ö–æ–≥–æ –æ—Ç–ø—Ä–∞–≤–∏–º –Ω–∞ –¥–Ω–æ —Ä–µ–∫–∏?",
    "üó≥Ô∏è –í—Ä–µ–º—è –≥–æ–ª–æ—Å–æ–≤–∞—Ç—å! –ö—Ç–æ —Å–µ–≥–æ–¥–Ω—è –ø–æ–ø–ª–∞—Ç–∏—Ç—Å—è –∂–∏–∑–Ω—å—é?",
    "üó≥Ô∏è –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –Ω–∞—á–∞–ª–æ—Å—å! –í—ã–±–∏—Ä–∞–µ–º –∂–µ—Ä—Ç–≤—É.",
    "üó≥Ô∏è –í—Ä–µ–º—è —Ä–µ—à–∞—Ç—å —Å—É–¥—å–±—É! –ö–æ–≥–æ –∫–∞–∑–Ω–∏–º —Å–µ–≥–æ–¥–Ω—è?",
    "üó≥Ô∏è –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ! –ö—Ç–æ —Å–µ–≥–æ–¥–Ω—è –ø–æ–∫–∏–Ω–µ—Ç –∏–≥—Ä—É?",
    "üó≥Ô∏è –í—Ä–µ–º—è –≤—ã–Ω–æ—Å–∏—Ç—å –ø—Ä–∏–≥–æ–≤–æ—Ä! –í—ã–±–∏—Ä–∞–µ–º –∫–∞–Ω–¥–∏–¥–∞—Ç–∞.",
    "üó≥Ô∏è –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ! –ö–æ–≥–æ –æ—Ç–ø—Ä–∞–≤–∏–º –≤ –º–∏—Ä –∏–Ω–æ–π?",
    "üó≥Ô∏è –í—Ä–µ–º—è —Ä–µ—à–∞—Ç—å! –ö—Ç–æ —Å–µ–≥–æ–¥–Ω—è —É–º—Ä—ë—Ç?"
]

REVOTE_MESSAGES = [
    "üó≥Ô∏è –ü–µ—Ä–µ–≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ! –í—ã–±–∏—Ä–∞–µ–º –∏–∑ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –Ω–∏—á—å–µ–π.",
    "üó≥Ô∏è –ù–∏—á—å—è! –ì–æ–ª–æ—Å—É–µ–º —Å–Ω–æ–≤–∞ —Å—Ä–µ–¥–∏ —Ä–∞–≤–Ω—ã—Ö.",
    "üó≥Ô∏è –ü–µ—Ä–µ–≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ! –í—ã–±–∏—Ä–∞–µ–º –∏–∑ –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º—ã—Ö.",
    "üó≥Ô∏è –ù–∏—á—å—è! –í—Ä–µ–º—è –¥–ª—è –≤—Ç–æ—Ä–æ–≥–æ —Ç—É—Ä–∞.",
    "üó≥Ô∏è –ü–µ—Ä–µ–≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ! –í—ã–±–∏—Ä–∞–µ–º —Å—Ä–µ–¥–∏ —Ä–∞–≤–Ω—ã—Ö.",
    "üó≥Ô∏è –ù–∏—á—å—è! –ì–æ–ª–æ—Å—É–µ–º –µ—â—ë —Ä–∞–∑.",
    "üó≥Ô∏è –ü–µ—Ä–µ–≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ! –í—ã–±–∏—Ä–∞–µ–º –∏–∑ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤.",
    "üó≥Ô∏è –ù–∏—á—å—è! –í—Ä–µ–º—è –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è."
]

# –†–∞–Ω–¥–æ–º–Ω—ã–µ —Ñ—Ä–∞–∑—ã –¥–ª—è –Ω–æ—á–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π —Ä–æ–ª–µ–π
NIGHT_ACTION_MESSAGES = {
    PlayerRole.MAFIA: [
        "üî™ –¢–µ–Ω–∏ —Å–≥—É—â–∞—é—Ç—Å—è... –º–∞—Ñ–∏—è –≤—ã–±–∏—Ä–∞–µ—Ç —Å–≤–æ—é –∂–µ—Ä—Ç–≤—É.",
        "üî™ –ù–æ—á—å –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –±—Ä–∞—Ç–≤–µ... –≤—Ä–µ–º—è –ø—Ä–∏–Ω–∏–º–∞—Ç—å —Ä–µ—à–µ–Ω–∏—è.",
        "üî™ –ú–∞—Ñ–∏—è –≤—ã—Ö–æ–¥–∏—Ç –Ω–∞ –æ—Ö–æ—Ç—É... –∫—Ç–æ —Å—Ç–∞–Ω–µ—Ç –¥–æ–±—ã—á–µ–π?",
        "üî™ –¢—ë–º–Ω—ã–µ —Å–∏–ª—ã –∞–∫—Ç–∏–≤–∏–∑–∏—Ä—É—é—Ç—Å—è... –º–∞—Ñ–∏—è –ø–ª–∞–Ω–∏—Ä—É–µ—Ç —É–±–∏–π—Å—Ç–≤–æ.",
        "üî™ –í—Ä–µ–º—è –¥–ª—è –∫—Ä–æ–≤–∞–≤—ã—Ö –¥–µ–ª... –º–∞—Ñ–∏—è –≤—ã–±–∏—Ä–∞–µ—Ç —Ü–µ–ª—å.",
        "üî™ –ù–æ—á—å –º–∞—Ñ–∏–∏... –∫—Ç–æ –Ω–µ –¥–æ–∂–∏–≤—ë—Ç –¥–æ —Ä–∞—Å—Å–≤–µ—Ç–∞?",
        "üî™ –ë—Ä–∞—Ç–≤–∞ —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è... –≤—Ä–µ–º—è –¥–ª—è —Ç—ë–º–Ω—ã—Ö –¥–µ–ª.",
        "üî™ –ú–∞—Ñ–∏—è –ø—Ä–æ—Å—ã–ø–∞–µ—Ç—Å—è... –≤—ã–±–∏—Ä–∞–µ–º –∂–µ—Ä—Ç–≤—É."
    ],
    PlayerRole.DOCTOR: [
        "ü©∫ –î–æ–∫—Ç–æ—Ä –≤—ã—Ö–æ–¥–∏—Ç –Ω–∞ –¥–µ–∂—É—Ä—Å—Ç–≤–æ... –∫–æ–≥–æ —Å–ø–∞—Å—Ç–∏ —Å–µ–≥–æ–¥–Ω—è?",
        "ü©∫ –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è –ø–æ–º–æ—â—å –Ω—É–∂–Ω–∞... –¥–æ–∫—Ç–æ—Ä –≤—ã–±–∏—Ä–∞–µ—Ç –ø–∞—Ü–∏–µ–Ω—Ç–∞.",
        "ü©∫ –í—Ä–µ–º—è –¥–ª—è –∏—Å—Ü–µ–ª–µ–Ω–∏—è... –¥–æ–∫—Ç–æ—Ä –∏—â–µ—Ç —Ç–æ–≥–æ, –∫—Ç–æ –Ω—É–∂–¥–∞–µ—Ç—Å—è –≤ –ø–æ–º–æ—â–∏.",
        "ü©∫ –î–æ–∫—Ç–æ—Ä –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ... –∫—Ç–æ –ø–æ–ª—É—á–∏—Ç –ª–µ—á–µ–Ω–∏–µ?",
        "ü©∫ –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –æ—Å–º–æ—Ç—Ä... –¥–æ–∫—Ç–æ—Ä –≤—ã–±–∏—Ä–∞–µ—Ç –±–æ–ª—å–Ω–æ–≥–æ.",
        "ü©∫ –í—Ä–µ–º—è –¥–ª—è —Å–ø–∞—Å–µ–Ω–∏—è... –¥–æ–∫—Ç–æ—Ä –∏—â–µ—Ç –Ω—É–∂–¥–∞—é—â–∏—Ö—Å—è.",
        "ü©∫ –î–æ–∫—Ç–æ—Ä –Ω–∞ –¥–µ–∂—É—Ä—Å—Ç–≤–µ... –∫–æ–≥–æ –ª–µ—á–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è?",
        "ü©∫ –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è –ø–æ–º–æ—â—å... –¥–æ–∫—Ç–æ—Ä –≤—ã–±–∏—Ä–∞–µ—Ç –ø–∞—Ü–∏–µ–Ω—Ç–∞."
    ],
    PlayerRole.COMMISSIONER: [
        "üëÆ –ö–æ–º–∏—Å—Å–∞—Ä –≤—ã—Ö–æ–¥–∏—Ç –Ω–∞ —Å–ª–µ–¥... –∫–æ–≥–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è?",
        "üëÆ –ü–æ–ª–∏—Ü–µ–π—Å–∫–æ–µ —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ... –∫–æ–º–∏—Å—Å–∞—Ä –∏—â–µ—Ç —É–ª–∏–∫–∏.",
        "üëÆ –í—Ä–µ–º—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏... –∫–æ–º–∏—Å—Å–∞—Ä –≤—ã–±–∏—Ä–∞–µ—Ç –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º–æ–≥–æ.",
        "üëÆ –°–ª–µ–¥—Å—Ç–≤–∏–µ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è... –∫–æ–º–∏—Å—Å–∞—Ä –∏—â–µ—Ç –ø—Ä–∞–≤–¥—É.",
        "üëÆ –ü–æ–ª–∏—Ü–µ–π—Å–∫–∞—è —Ä–∞–±–æ—Ç–∞... –∫–æ–º–∏—Å—Å–∞—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º—ã—Ö.",
        "üëÆ –í—Ä–µ–º—è –¥–ª—è —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è... –∫–æ–º–∏—Å—Å–∞—Ä –≤—ã–±–∏—Ä–∞–µ—Ç —Ü–µ–ª—å.",
        "üëÆ –ö–æ–º–∏—Å—Å–∞—Ä –Ω–∞ –∑–∞–¥–∞–Ω–∏–∏... –∫–æ–≥–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è?",
        "üëÆ –ü–æ–ª–∏—Ü–µ–π—Å–∫–æ–µ –¥–µ–ª–æ... –∫–æ–º–∏—Å—Å–∞—Ä –∏—â–µ—Ç –≤–∏–Ω–æ–≤–Ω—ã—Ö."
    ],
    PlayerRole.BUTTERFLY: [
        "üíÉ –ù–æ—á–Ω–∞—è –±–∞–±–æ—á–∫–∞ –≤—ã—Ö–æ–¥–∏—Ç –Ω–∞ –æ—Ö–æ—Ç—É... –∫–æ–≥–æ –æ—Ç–≤–ª–µ—á—å —Å–µ–≥–æ–¥–Ω—è?",
        "üíÉ –í—Ä–µ–º—è –¥–ª—è —Å–æ–±–ª–∞–∑–Ω–µ–Ω–∏—è... –±–∞–±–æ—á–∫–∞ –≤—ã–±–∏—Ä–∞–µ—Ç —Ü–µ–ª—å.",
        "üíÉ –ù–æ—á–Ω–∞—è –±–∞–±–æ—á–∫–∞ –∞–∫—Ç–∏–≤–∏–∑–∏—Ä—É–µ—Ç—Å—è... –∫—Ç–æ —Å—Ç–∞–Ω–µ—Ç –µ—ë –∂–µ—Ä—Ç–≤–æ–π?",
        "üíÉ –í—Ä–µ–º—è –¥–ª—è –æ—Ç–≤–ª–µ—á–µ–Ω–∏—è... –±–∞–±–æ—á–∫–∞ –∏—â–µ—Ç –¥–æ–±—ã—á—É.",
        "üíÉ –ù–æ—á–Ω–∞—è –±–∞–±–æ—á–∫–∞ –Ω–∞ –∑–∞–¥–∞–Ω–∏–∏... –∫–æ–≥–æ –∑–∞–ø—É—Ç–∞—Ç—å —Å–µ–≥–æ–¥–Ω—è?",
        "üíÉ –í—Ä–µ–º—è –¥–ª—è –∫–æ–≤–∞—Ä—Å—Ç–≤–∞... –±–∞–±–æ—á–∫–∞ –≤—ã–±–∏—Ä–∞–µ—Ç —Ü–µ–ª—å.",
        "üíÉ –ù–æ—á–Ω–∞—è –±–∞–±–æ—á–∫–∞ –ø—Ä–æ—Å—ã–ø–∞–µ—Ç—Å—è... –∫—Ç–æ –ø–æ–ø–∞–¥—ë—Ç –≤ –µ—ë —Å–µ—Ç–∏?",
        "üíÉ –í—Ä–µ–º—è –¥–ª—è —Å–æ–±–ª–∞–∑–Ω–∞... –±–∞–±–æ—á–∫–∞ –∏—â–µ—Ç –∂–µ—Ä—Ç–≤—É."
    ]
}

# –†–∞–Ω–¥–æ–º–Ω—ã–µ —Ñ—Ä–∞–∑—ã –¥–ª—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –æ –≤—Ä–µ–º–µ–Ω–∏
TIME_REMINDER_MESSAGES = {
    "night": [
        "‚è≥ –î–æ —Ä–∞—Å—Å–≤–µ—Ç–∞ –æ—Å—Ç–∞–ª–æ—Å—å: {time} —Å–µ–∫.",
        "üåô –í—Ä–µ–º—è –∏—Å—Ç–µ–∫–∞–µ—Ç... –æ—Å—Ç–∞–ª–æ—Å—å: {time} —Å–µ–∫.",
        "‚è∞ –ù–æ—á—å –ø–æ–¥—Ö–æ–¥–∏—Ç –∫ –∫–æ–Ω—Ü—É... {time} —Å–µ–∫.",
        "üïê –î–æ —É—Ç—Ä–∞ –æ—Å—Ç–∞–ª–æ—Å—å: {time} —Å–µ–∫.",
        "‚è≥ –¢–µ–Ω–∏ —Ä–∞—Å—Å–µ–∏–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑: {time} —Å–µ–∫.",
        "üåô –ù–æ—á—å –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è... {time} —Å–µ–∫.",
        "‚è∞ –í—Ä–µ–º—è –Ω–æ—á–∏ –∏—Å—Ç–µ–∫–∞–µ—Ç: {time} —Å–µ–∫.",
        "üïê –î–æ —Ä–∞—Å—Å–≤–µ—Ç–∞: {time} —Å–µ–∫."
    ],
    "day": [
        "‚è≥ –î–æ –∫–æ–Ω—Ü–∞ –¥–Ω—è –æ—Å—Ç–∞–ª–æ—Å—å: {time} —Å–µ–∫.",
        "‚òÄÔ∏è –°–æ–ª–Ω—Ü–µ —Å–∞–¥–∏—Ç—Å—è —á–µ—Ä–µ–∑: {time} —Å–µ–∫.",
        "‚è∞ –î–µ–Ω—å –ø–æ–¥—Ö–æ–¥–∏—Ç –∫ –∫–æ–Ω—Ü—É... {time} —Å–µ–∫.",
        "üïê –î–æ –≤–µ—á–µ—Ä–∞ –æ—Å—Ç–∞–ª–æ—Å—å: {time} —Å–µ–∫.",
        "‚è≥ –í—Ä–µ–º—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è: {time} —Å–µ–∫.",
        "‚òÄÔ∏è –î–µ–Ω—å –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è... {time} —Å–µ–∫.",
        "‚è∞ –í—Ä–µ–º—è –¥–Ω—è –∏—Å—Ç–µ–∫–∞–µ—Ç: {time} —Å–µ–∫.",
        "üïê –î–æ –Ω–æ—á–∏: {time} —Å–µ–∫."
    ],
    "voting": [
        "‚è≥ –î–æ –∫–æ–Ω—Ü–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –æ—Å—Ç–∞–ª–æ—Å—å: {time} —Å–µ–∫.",
        "üó≥Ô∏è –í—Ä–µ–º—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è: {time} —Å–µ–∫.",
        "‚è∞ –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è... {time} —Å–µ–∫.",
        "üïê –î–æ –∫–æ–Ω—Ü–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è: {time} —Å–µ–∫.",
        "‚è≥ –í—Ä–µ–º—è –ø—Ä–∏–Ω–∏–º–∞—Ç—å —Ä–µ—à–µ–Ω–∏–µ: {time} —Å–µ–∫.",
        "üó≥Ô∏è –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –∏—Å—Ç–µ–∫–∞–µ—Ç... {time} —Å–µ–∫.",
        "‚è∞ –í—Ä–µ–º—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è: {time} —Å–µ–∫.",
        "üïê –î–æ —Ñ–∏–Ω–∞–ª–∞: {time} —Å–µ–∫."
    ]
}

# –†–∞–Ω–¥–æ–º–Ω—ã–µ —Ñ—Ä–∞–∑—ã –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –≤ –ø–µ—Ä–≤—ã–π –¥–µ–Ω—å
NO_VOTING_FIRST_DAY_MESSAGES = [
    "üîî –°–µ–≥–æ–¥–Ω—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –Ω–µ –±—É–¥–µ—Ç (–ø–µ—Ä–≤—ã–π –¥–µ–Ω—å –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π –Ω–æ—á–∏).\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±—Å—É–¥–∏—Ç–µ –∏—Ç–æ–≥–∏ –Ω–æ—á–∏ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤—å—Ç–µ—Å—å –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—é.",
    "üì¢ –í–Ω–∏–º–∞–Ω–∏–µ! –ü–µ—Ä–≤—ã–π –¥–µ–Ω—å ‚Äî –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –Ω–µ—Ç.\n–û–±—Å—É–¥–∏—Ç–µ –Ω–æ—á–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –∏ –≥–æ—Ç–æ–≤—å—Ç–µ—Å—å –∫ –∑–∞–≤—Ç—Ä–∞—à–Ω–µ–º—É –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—é.",
    "üö´ –°–µ–≥–æ–¥–Ω—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –Ω–µ –ø—Ä–æ–≤–æ–¥–∏—Ç—Å—è (–ø–µ—Ä–≤—ã–π –¥–µ–Ω—å).\n–û–±—Å—É–¥–∏—Ç–µ –Ω–æ—á—å –∏ –ø–ª–∞–Ω–∏—Ä—É–π—Ç–µ –∑–∞–≤—Ç—Ä–∞—à–Ω–µ–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ.",
    "‚ö†Ô∏è –ü–µ—Ä–≤—ã–π –¥–µ–Ω—å ‚Äî –±–µ–∑ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è.\n–û–±—Å—É–¥–∏—Ç–µ –Ω–æ—á—å –∏ –ø–ª–∞–Ω–∏—Ä—É–π—Ç–µ –∑–∞–≤—Ç—Ä–∞—à–Ω–µ–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ.",
    "üîï –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è —Å–µ–≥–æ–¥–Ω—è –Ω–µ –±—É–¥–µ—Ç (–ø–µ—Ä–≤—ã–π –¥–µ–Ω—å).\n–í—Ä–µ–º—è –¥–ª—è –¥–∏—Å–∫—É—Å—Å–∏–π –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∫ –∑–∞–≤—Ç—Ä–∞.",
    "üìã –ü–µ—Ä–≤—ã–π –¥–µ–Ω—å ‚Äî –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.\n–û–±—Å—É–¥–∏—Ç–µ –Ω–æ—á–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –∏ –≥–æ—Ç–æ–≤—å—Ç–µ—Å—å –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Ä–∞—É–Ω–¥—É.",
    "üö∑ –°–µ–≥–æ–¥–Ω—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –Ω–µ—Ç (–ø–µ—Ä–≤—ã–π –¥–µ–Ω—å).\n–í—Ä–µ–º—è –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.",
    "‚è∏Ô∏è –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ (–ø–µ—Ä–≤—ã–π –¥–µ–Ω—å).\n–û–±—Å—É–¥–∏—Ç–µ –Ω–æ—á—å –∏ –≥–æ—Ç–æ–≤—å—Ç–µ—Å—å –∫ –∑–∞–≤—Ç—Ä–∞—à–Ω–µ–º—É —Ä–µ—à–µ–Ω–∏—é."
]

# –†–∞–Ω–¥–æ–º–Ω—ã–µ —Ñ—Ä–∞–∑—ã –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π –æ –Ω–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –õ–°
NO_DM_MESSAGES = [
    "‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ! –°–ª–µ–¥—É—é—â–∏–µ –∏–≥—Ä–æ–∫–∏ –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª–∏ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –±–æ—Ç–æ–º:\n{players}\n–û–Ω–∏ –Ω–µ –ø–æ–ª—É—á–∞—Ç —Ä–æ–ª–µ–π –∏ –Ω–µ —Å–º–æ–≥—É—Ç —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –∏–≥—Ä–µ!",
    "üö® –ü—Ä–æ–±–ª–µ–º–∞! –≠—Ç–∏ –∏–≥—Ä–æ–∫–∏ –Ω–µ –Ω–∞–ø–∏—Å–∞–ª–∏ /start –±–æ—Ç—É:\n{players}\n–ë–µ–∑ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –õ–° –æ–Ω–∏ –æ—Å—Ç–∞–Ω—É—Ç—Å—è –±–µ–∑ —Ä–æ–ª–µ–π!",
    "‚ùå –û—à–∏–±–∫–∞! –î–∞–Ω–Ω—ã–µ –∏–≥—Ä–æ–∫–∏ –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª–∏ –±–æ—Ç–∞:\n{players}\n–û–Ω–∏ –Ω–µ —Å–º–æ–≥—É—Ç –∏–≥—Ä–∞—Ç—å –±–µ–∑ —Ä–æ–ª–µ–π!",
    "üí• –í–Ω–∏–º–∞–Ω–∏–µ! –°–ª–µ–¥—É—é—â–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª–∏ –õ–°:\n{players}\n–û–Ω–∏ –æ—Å—Ç–∞–Ω—É—Ç—Å—è –±–µ–∑ —Ä–æ–ª–µ–π –≤ –∏–≥—Ä–µ!",
    "üî¥ –ü—Ä–æ–±–ª–µ–º–∞ —Å –∞–∫—Ç–∏–≤–∞—Ü–∏–µ–π! –≠—Ç–∏ –∏–≥—Ä–æ–∫–∏ –Ω–µ –Ω–∞–ø–∏—Å–∞–ª–∏ /start:\n{players}\n–ë–µ–∑ —Ä–æ–ª–µ–π –æ–Ω–∏ –Ω–µ —Å–º–æ–≥—É—Ç —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å!",
    "‚ö° –¢—Ä–µ–≤–æ–≥–∞! –î–∞–Ω–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª–∏ –±–æ—Ç–∞:\n{players}\n–û–Ω–∏ –æ—Å—Ç–∞–Ω—É—Ç—Å—è –±–µ–∑ —Ä–æ–ª–µ–π!",
    "üö´ –í–Ω–∏–º–∞–Ω–∏–µ! –°–ª–µ–¥—É—é—â–∏–µ –∏–≥—Ä–æ–∫–∏ –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª–∏ –õ–°:\n{players}\n–ë–µ–∑ —Ä–æ–ª–µ–π –æ–Ω–∏ –Ω–µ —Å–º–æ–≥—É—Ç –∏–≥—Ä–∞—Ç—å!",
    "üí¢ –ü—Ä–æ–±–ª–µ–º–∞! –≠—Ç–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –Ω–µ –Ω–∞–ø–∏—Å–∞–ª–∏ /start:\n{players}\n–û–Ω–∏ –æ—Å—Ç–∞–Ω—É—Ç—Å—è –±–µ–∑ —Ä–æ–ª–µ–π –≤ –∏–≥—Ä–µ!"
]

# –†–∞–Ω–¥–æ–º–Ω—ã–µ —Ñ—Ä–∞–∑—ã –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è –æ –Ω–∞—á–∞–ª–µ –∏–≥—Ä—ã
GAME_START_MESSAGES = [
    "üé≠ –ò–ì–†–ê –ù–ê–ß–ê–õ–ê–°–¨! üé≠\n\nüíº –í–Ω–∏–º–∞–Ω–∏–µ, —Å–∏–Ω—å–æ—Ä—ã –∏ —Å–∏–Ω—å–æ—Ä–∏—Ç—ã‚Ä¶ –°–µ–≥–æ–¥–Ω—è –Ω–æ—á—å—é —Ä–µ—à–∏—Ç—Å—è —Å—É–¥—å–±–∞ —ç—Ç–æ–≥–æ –≥–æ—Ä–æ–¥–∞.\n–û–¥–Ω–∏ –∏–∑ –≤–∞—Å –±—É–¥—É—Ç –æ—Ö–æ—Ç–∏—Ç—å—Å—è, –¥—Ä—É–≥–∏–µ ‚Äî —Å–ø–∞—Å–∞—Ç—å, –∫—Ç–æ-—Ç–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö, –∞ –∫—Ç–æ-—Ç–æ –ø—É—Ç–∞—Ç—å –≤—Å–µ—Ö —Å–≤–æ–∏–º–∏ —á–∞—Ä–∞–º–∏.\n–ö–∞–∂–¥—ã–π —à–∞–≥, –∫–∞–∂–¥–æ–µ —Å–ª–æ–≤–æ, –∫–∞–∂–¥—ã–π –≤–∑–≥–ª—è–¥ –º–æ–∂–µ—Ç —Å—Ç–∞—Ç—å —Ä–æ–∫–æ–≤—ã–º.",
    "üé≠ –ò–ì–†–ê –ù–ê–ß–ê–õ–ê–°–¨! üé≠\n\nüíº –°–∏–Ω—å–æ—Ä—ã –∏ —Å–∏–Ω—å–æ—Ä–∏—Ç—ã, —Å–µ–≥–æ–¥–Ω—è –Ω–æ—á—å—é –Ω–∞—á–Ω–µ—Ç—Å—è –æ—Ö–æ—Ç–∞.\n–û–¥–Ω–∏ –±—É–¥—É—Ç —É–±–∏–≤–∞—Ç—å, –¥—Ä—É–≥–∏–µ ‚Äî —Å–ø–∞—Å–∞—Ç—å, –∫—Ç–æ-—Ç–æ –∏—Å–∫–∞—Ç—å –ø—Ä–∞–≤–¥—É, –∞ –∫—Ç–æ-—Ç–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ö–∞–æ—Å.\n–ö–∞–∂–¥–æ–µ —Ä–µ—à–µ–Ω–∏–µ –º–æ–∂–µ—Ç —Å—Ç–æ–∏—Ç—å –∂–∏–∑–Ω–∏.",
    "üé≠ –ò–ì–†–ê –ù–ê–ß–ê–õ–ê–°–¨! üé≠\n\nüíº –í–Ω–∏–º–∞–Ω–∏–µ, –∏–≥—Ä–æ–∫–∏! –°–µ–≥–æ–¥–Ω—è –Ω–æ—á—å—é –≥–æ—Ä–æ–¥ –ø–æ–≥—Ä—É–∑–∏—Ç—Å—è –≤ —Ç—å–º—É.\n–ú–∞—Ñ–∏—è –≤—ã–π–¥–µ—Ç –Ω–∞ –æ—Ö–æ—Ç—É, –¥–æ–∫—Ç–æ—Ä –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è —Å–ø–∞—Å—Ç–∏, –∫–æ–º–∏—Å—Å–∞—Ä –±—É–¥–µ—Ç –∏—Å–∫–∞—Ç—å –ø—Ä–µ–¥–∞—Ç–µ–ª–µ–π, –∞ –±–∞–±–æ—á–∫–∞ –∑–∞–ø—É—Ç–∞–µ—Ç –≤—Å–µ—Ö.",
    "üé≠ –ò–ì–†–ê –ù–ê–ß–ê–õ–ê–°–¨! üé≠\n\nüíº –°–∏–Ω—å–æ—Ä—ã, –∏–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å! –°–µ–≥–æ–¥–Ω—è –Ω–æ—á—å—é —Ä–µ—à–∞—Ç—Å—è —Å—É–¥—å–±—ã.\n–û–¥–Ω–∏ –±—É–¥—É—Ç –æ—Ö–æ—Ç–∏—Ç—å—Å—è, –¥—Ä—É–≥–∏–µ –∑–∞—â–∏—â–∞—Ç—å—Å—è, –∫—Ç–æ-—Ç–æ —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å, –∞ –∫—Ç–æ-—Ç–æ –∑–∞–ø—É—Ç—ã–≤–∞—Ç—å —Å–ª–µ–¥—ã.",
    "üé≠ –ò–ì–†–ê –ù–ê–ß–ê–õ–ê–°–¨! üé≠\n\nüíº –í–Ω–∏–º–∞–Ω–∏–µ! –°–µ–≥–æ–¥–Ω—è –Ω–æ—á—å—é –≥–æ—Ä–æ–¥ —Å—Ç–∞–Ω–µ—Ç –∞—Ä–µ–Ω–æ–π –¥–ª—è —Ç–∞–π–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π.\n–ú–∞—Ñ–∏—è –≤—ã–±–∏—Ä–∞–µ—Ç —Ü–µ–ª–∏, –¥–æ–∫—Ç–æ—Ä —Å–ø–∞—Å–∞–µ—Ç, –∫–æ–º–∏—Å—Å–∞—Ä –∏—â–µ—Ç, –±–∞–±–æ—á–∫–∞ –æ—Ç–≤–ª–µ–∫–∞–µ—Ç.",
    "üé≠ –ò–ì–†–ê –ù–ê–ß–ê–õ–ê–°–¨! üé≠\n\nüíº –°–∏–Ω—å–æ—Ä—ã –∏ —Å–∏–Ω—å–æ—Ä–∏—Ç—ã, –∏–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å! –°–µ–≥–æ–¥–Ω—è –Ω–æ—á—å—é –Ω–∞—á–Ω–µ—Ç—Å—è –æ—Ö–æ—Ç–∞.\n–û–¥–Ω–∏ –±—É–¥—É—Ç —É–±–∏–≤–∞—Ç—å, –¥—Ä—É–≥–∏–µ ‚Äî —Å–ø–∞—Å–∞—Ç—å, –∫—Ç–æ-—Ç–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å, –∞ –∫—Ç–æ-—Ç–æ –∑–∞–ø—É—Ç—ã–≤–∞—Ç—å.",
    "üé≠ –ò–ì–†–ê –ù–ê–ß–ê–õ–ê–°–¨! üé≠\n\nüíº –í–Ω–∏–º–∞–Ω–∏–µ, –∏–≥—Ä–æ–∫–∏! –°–µ–≥–æ–¥–Ω—è –Ω–æ—á—å—é –≥–æ—Ä–æ–¥ –ø–æ–≥—Ä—É–∑–∏—Ç—Å—è –≤ —Ç–µ–Ω–∏.\n–ú–∞—Ñ–∏—è –≤—ã–π–¥–µ—Ç –Ω–∞ —É–ª–∏—Ü—ã, –¥–æ–∫—Ç–æ—Ä –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è —Å–ø–∞—Å—Ç–∏, –∫–æ–º–∏—Å—Å–∞—Ä –±—É–¥–µ—Ç –∏—Å–∫–∞—Ç—å –ø—Ä–∞–≤–¥—É.",
    "üé≠ –ò–ì–†–ê –ù–ê–ß–ê–õ–ê–°–¨! üé≠\n\nüíº –°–∏–Ω—å–æ—Ä—ã, –∏–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å! –°–µ–≥–æ–¥–Ω—è –Ω–æ—á—å—é —Ä–µ—à–∞—Ç—Å—è —Å—É–¥—å–±—ã –≥–æ—Ä–æ–¥–∞.\n–û–¥–Ω–∏ –±—É–¥—É—Ç –æ—Ö–æ—Ç–∏—Ç—å—Å—è, –¥—Ä—É–≥–∏–µ –∑–∞—â–∏—â–∞—Ç—å—Å—è, –∫—Ç–æ-—Ç–æ —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å, –∞ –∫—Ç–æ-—Ç–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ö–∞–æ—Å."
]

def get_chat_key(message_or_callback) -> str:
    """–ü–æ–ª—É—á–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á —á–∞—Ç–∞ —Å —É—á—ë—Ç–æ–º —Ç–µ–º—ã"""
    chat_id = message_or_callback.chat.id
    thread_id = getattr(message_or_callback, 'message_thread_id', None) or 0
    return f"{chat_id}_{thread_id}"

def get_chat_id_from_key(chat_key: str) -> int:
    """–ü–æ–ª—É—á–∞–µ—Ç chat_id –∏–∑ chat_key"""
    return int(chat_key.split('_')[0])

def get_thread_id_from_key(chat_key: str) -> int:
    """–ü–æ–ª—É—á–∞–µ—Ç thread_id –∏–∑ chat_key"""
    return int(chat_key.split('_')[1])

def check_topic_permission(message_or_callback) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ –≤ –¥–∞–Ω–Ω–æ–π —Ç–µ–º–µ"""
    # –î–ª—è callback query –∏—Å–ø–æ–ª—å–∑—É–µ–º message.message_thread_id
    if hasattr(message_or_callback, 'message'):
        # –≠—Ç–æ callback query
        thread_id = message_or_callback.message.message_thread_id
        chat = message_or_callback.message.chat
    else:
        # –≠—Ç–æ –æ–±—ã—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        thread_id = message_or_callback.message_thread_id
        chat = message_or_callback.chat
    
    logger.debug(f"check_topic_permission: chat.is_forum={chat.is_forum}, thread_id={thread_id}")
    
    if chat.is_forum:
        # –í —Ñ–æ—Ä—É–º–∞—Ö —Ä–∞–∑—Ä–µ—à–∞–µ–º —Ç–æ–ª—å–∫–æ –≤ —Ç–µ–º–µ "–ò–≥—Ä–∞ –≤ ¬´–ú–∞—Ñ–∏—é¬ª" (ID: 39431)
        result = thread_id == 39431
        logger.debug(f"check_topic_permission: thread_id={thread_id}, —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–π=39431, —Ä–µ–∑—É–ª—å—Ç–∞—Ç={result}")
        return result
    else:
        # –í –æ–±—ã—á–Ω—ã—Ö –≥—Ä—É–ø–ø–∞—Ö –∑–∞–ø—Ä–µ—â–∞–µ–º
        logger.debug("check_topic_permission: –Ω–µ —Ñ–æ—Ä—É–º, —Ä–µ–∑—É–ª—å—Ç–∞—Ç=False")
        return False

# –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–æ–ª–µ–π: —ç–º–æ–¥–∑–∏, –∏–º–µ–Ω–∞ –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
ROLE_EMOJI = {
    PlayerRole.MAFIA: "üòà",
    PlayerRole.CIVILIAN: "üïäÔ∏è",
    PlayerRole.DOCTOR: "üíâ",
    PlayerRole.COMMISSIONER: "üëÆ",
    PlayerRole.BUTTERFLY: "üíÉ",
}

ROLE_NAMES = {
    PlayerRole.MAFIA: "–ú–∞—Ñ–∏—è",
    PlayerRole.CIVILIAN: "–ú–∏—Ä–Ω—ã–π –∂–∏—Ç–µ–ª—å",
    PlayerRole.DOCTOR: "–î–æ–∫—Ç–æ—Ä",
    PlayerRole.COMMISSIONER: "–ö–æ–º–∏—Å—Å–∞—Ä",
    PlayerRole.BUTTERFLY: "–ù–æ—á–Ω–∞—è –±–∞–±–æ—á–∫–∞",
}

INSTRUCTIONS_BY_ROLE = {
    PlayerRole.MAFIA: (
        "–¢—ã –º–∞—Ñ–∏—è. –ö–∞–∂–¥—É—é –Ω–æ—á—å –≤—ã–±–∏—Ä–∞–π –∂–µ—Ä—Ç–≤—É –ø–æ –∫–Ω–æ–ø–∫–∞–º. "
        "–ü–µ—Ä–µ–ø–∏—Å—ã–≤–∞–π—Å—è —Å —Å–æ—Ä–∞—Ç–Ω–∏–∫–∞–º–∏ –≤ —ç—Ç–æ–º —á–∞—Ç–µ, —Ü–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è –ø–æ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤—É. –°–µ–±—è –≤—ã–±—Ä–∞—Ç—å –Ω–µ–ª—å–∑—è."
    ),
    PlayerRole.DOCTOR: (
        "–¢—ã –¥–æ–∫—Ç–æ—Ä. –ö–∞–∂–¥—É—é –Ω–æ—á—å –≤—ã–±–µ—Ä–∏ –æ–¥–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞, —á—Ç–æ–±—ã –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è —Å–ø–∞—Å—Ç–∏ –µ–≥–æ –æ—Ç —Å–º–µ—Ä—Ç–∏. "
        "–°–µ–±—è –º–æ–∂–Ω–æ –ª–µ—á–∏—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑ –∑–∞ –∏–≥—Ä—É."
    ),
    PlayerRole.COMMISSIONER: (
        "–¢—ã –∫–æ–º–∏—Å—Å–∞—Ä. –ö–∞–∂–¥—É—é –Ω–æ—á—å –ø—Ä–æ–≤–µ—Ä—è–π –æ–¥–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞ ‚Äî —è —Å–∫–∞–∂—É, –º–∞—Ñ–∏—è –æ–Ω –∏–ª–∏ –Ω–µ—Ç. "
        "–°–µ–±—è –ø—Ä–æ–≤–µ—Ä—è—Ç—å –Ω–µ–ª—å–∑—è."
    ),
    PlayerRole.BUTTERFLY: (
        "–¢—ã –Ω–æ—á–Ω–∞—è –±–∞–±–æ—á–∫–∞. –ö–∞–∂–¥—É—é –Ω–æ—á—å –æ—Ç–≤–ª–µ–∫–∞–π –∫–æ–≥–æ-—Ç–æ, —á—Ç–æ–±—ã —Å–ø—É—Ç–∞—Ç—å –ø–ª–∞–Ω—ã. –°–µ–±—è –≤—ã–±—Ä–∞—Ç—å –Ω–µ–ª—å–∑—è."
    ),
    PlayerRole.CIVILIAN: (
        "–¢—ã –º–∏—Ä–Ω—ã–π –∂–∏—Ç–µ–ª—å. –î–Ω—ë–º –æ–±—Å—É–∂–¥–∞–π –≤ –æ–±—â–µ–º —á–∞—Ç–µ –∏ –≥–æ–ª–æ—Å—É–π, —á—Ç–æ–±—ã —É—Ç–æ–ø–∏—Ç—å –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Å–∏–Ω—å–æ—Ä–∞."
    ),
}

def build_role_prompt(role: PlayerRole, action_line: str) -> str:
    emoji = ROLE_EMOJI.get(role, "‚ùì")
    role_name = ROLE_NAMES.get(role, "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —Ä–æ–ª—å")
    description = INSTRUCTIONS_BY_ROLE.get(role, "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —Ä–æ–ª—å")
    return (
        f"üé≠ –¢–≤–æ—è —Ä–æ–ª—å ‚Äî {emoji} {role_name}\n\n"
        f"{description}\n\n"
        f"{action_line}"
    )

async def _send_night_action_keyboards(chat_key: str, bot):
    game = game_manager.get_game(chat_key)
    if not game:
        return
    # –ù–µ –¥—É–±–ª–∏—Ä—É–µ–º, –µ—Å–ª–∏ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏ –≤ —ç—Ç–æ–π –Ω–æ—á–∏
    if getattr(game, "night_prompts_sent", False):
        return
    alive_players = game.get_alive_players()
    # –ï—Å–ª–∏ –±–∞–±–æ—á–∫–∞ –æ—Ç–≤–ª–µ–∫–ª–∞ —Ü–µ–ª—å –ø—Ä–æ—à–ª–æ–π –Ω–æ—á—å—é ‚Äî –∑–∞–ø—Ä–µ—Ç–∏–º –µ—ë –≤—ã–±–∏—Ä–∞—Ç—å –≤ —Ç–µ–∫—É—â–µ–π
    # –ò—Å–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ä–æ–ª–µ–π
    mafia_excluded_targets = set()
    doctor_excluded_targets = set()
    commissioner_excluded_targets = set()
    
    # –ï—Å–ª–∏ –±–∞–±–æ—á–∫–∞ –æ—Ç–≤–ª–µ–∫–ª–∞ —Ü–µ–ª—å –ø—Ä–æ—à–ª–æ–π –Ω–æ—á–∏ ‚Äî –∑–∞–ø—Ä–µ—Ç–∏–º –µ—ë –≤—ã–±–∏—Ä–∞—Ç—å –≤ —Ç–µ–∫—É—â–µ–π –¥–ª—è –º–∞—Ñ–∏–∏ –∏ –¥–æ–∫—Ç–æ—Ä–∞
    if game.last_butterfly_distract_target is not None:
        mafia_excluded_targets.add(game.last_butterfly_distract_target)
        doctor_excluded_targets.add(game.last_butterfly_distract_target)
        commissioner_excluded_targets.add(game.last_butterfly_distract_target)
    
    # –ù–ï –¥–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ—Ö —Ä–∞–Ω–µ–µ –æ—Ç–≤–ª–µ—á–µ–Ω–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ - –æ–Ω–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è –≤—ã–±–æ—Ä–∞
    # –û—Ç–≤–ª–µ—á–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤—É–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ –æ–¥–Ω—É –Ω–æ—á—å
    for player in alive_players:
        try:
            # –ï—Å–ª–∏ –∏–≥—Ä–æ–∫ –æ—Ç–≤–ª–µ—á–µ–Ω —ç—Ç–æ–π –Ω–æ—á—å—é ‚Äî –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –µ–º—É –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–µ–π—Å—Ç–≤–∏–π
            if game.butterfly_distract_target is not None and player.user_id == game.butterfly_distract_target:
                logger.debug(f"_send_night_action_keyboards: –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É –¥–ª—è –æ—Ç–≤–ª–µ—á–µ–Ω–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞ {player.user_id}")
                continue
            if player.role == PlayerRole.MAFIA:
                # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é —Ñ—Ä–∞–∑—É –¥–ª—è –º–∞—Ñ–∏–∏
                mafia_message = random.choice(NIGHT_ACTION_MESSAGES[PlayerRole.MAFIA])
                await bot.send_message(
                    player.user_id,
                    build_role_prompt(PlayerRole.MAFIA, mafia_message),
                    reply_markup=get_player_selection_keyboard(alive_players, "mafia_kill", chat_key, exclude_user_id=player.user_id, exclude_target_ids=mafia_excluded_targets)
                )
                # –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ—Å—Ç–∞–≤ –º–∞—Ñ–∏–∏ –¥–ª—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏
                peers = game_manager.get_mafia_peers(chat_key, exclude_user_id=player.user_id)
                if peers:
                    mafia_list = ", ".join([f"@{p.username}" if p.username else p.first_name for p in peers])
                    await bot.send_message(player.user_id, f"ü§´ –¢–≤–æ–∏ —Å–æ–æ–±—â–Ω–∏–∫–∏: {mafia_list}. –ú–æ–∂–µ—Ç–µ –æ–±—Å—É–∂–¥–∞—Ç—å –ø—Ä—è–º–æ –∑–¥–µ—Å—å –≤ –õ–° ‚Äî —è –ø–µ—Ä–µ–¥–∞–º –∏–º —Ç–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è.")
            elif player.role == PlayerRole.DOCTOR:
                # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é —Ñ—Ä–∞–∑—É –¥–ª—è –¥–æ–∫—Ç–æ—Ä–∞
                doctor_message = random.choice(NIGHT_ACTION_MESSAGES[PlayerRole.DOCTOR])
                await bot.send_message(
                    player.user_id,
                    build_role_prompt(PlayerRole.DOCTOR, doctor_message),
                    # –†–∞–∑—Ä–µ—à–∞–µ–º —Å–∞–º–æ–ª–µ—á–µ–Ω–∏–µ ‚Äî –Ω–µ –∏—Å–∫–ª—é—á–∞–µ–º —Å–µ–±—è
                    reply_markup=get_player_selection_keyboard(alive_players, "doctor_save", chat_key, exclude_target_ids=doctor_excluded_targets)
                )
            elif player.role == PlayerRole.COMMISSIONER:
                # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é —Ñ—Ä–∞–∑—É –¥–ª—è –∫–æ–º–∏—Å—Å–∞—Ä–∞
                commissioner_message = random.choice(NIGHT_ACTION_MESSAGES[PlayerRole.COMMISSIONER])
                await bot.send_message(
                    player.user_id,
                    build_role_prompt(PlayerRole.COMMISSIONER, commissioner_message),
                    reply_markup=get_player_selection_keyboard(alive_players, "commissioner_check", chat_key, exclude_user_id=player.user_id, exclude_target_ids=commissioner_excluded_targets)
                )
            elif player.role == PlayerRole.BUTTERFLY:
                # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é —Ñ—Ä–∞–∑—É –¥–ª—è –Ω–æ—á–Ω–æ–π –±–∞–±–æ—á–∫–∏
                butterfly_message = random.choice(NIGHT_ACTION_MESSAGES[PlayerRole.BUTTERFLY])
                await bot.send_message(
                    player.user_id,
                    build_role_prompt(PlayerRole.BUTTERFLY, butterfly_message),
                    reply_markup=get_player_selection_keyboard(alive_players, "butterfly_distract", chat_key, exclude_user_id=player.user_id)
                )
        except Exception as e:
            logger.exception(f"_send_night_action_keyboards: –æ—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏–≥—Ä–æ–∫—É {player.user_id}: {e}")
    # –ü–æ–º–µ—á–∞–µ–º, —á—Ç–æ –Ω–æ—á–Ω—ã–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã —Ä–∞–∑–æ—Å–ª–∞–Ω—ã
    game.night_prompts_sent = True

async def _autopilot_loop(chat_key: str, bot):
    logger.info(f"—Å—Ç–∞—Ä—Ç –∞–≤—Ç–æ–ø–∏–ª–æ—Ç–∞ –¥–ª—è —á–∞—Ç–∞ {chat_key}")
    try:
        # –ü–æ–ª—É—á–∞–µ–º chat_id –∏ thread_id –∏–∑ chat_key –æ–¥–∏–Ω —Ä–∞–∑ –≤ –Ω–∞—á–∞–ª–µ
        # –î–µ–ª–∞–µ–º –∏—Ö –≥–ª–æ–±–∞–ª—å–Ω—ã–º–∏ –¥–ª—è –≤—Å–µ–π —Ñ—É–Ω–∫—Ü–∏–∏
        global_chat_id = get_chat_id_from_key(chat_key)
        global_thread_id = get_thread_id_from_key(chat_key)
        
        # –ï—Å–ª–∏ thread_id —Ä–∞–≤–µ–Ω 0, –Ω–µ –ø–µ—Ä–µ–¥–∞–µ–º –µ–≥–æ (–≥–ª–∞–≤–Ω–∞—è —Ç–µ–º–∞)
        # –ù–æ –¥–ª—è –≥–ª–∞–≤–Ω–æ–π —Ç–µ–º—ã –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å None, –∞ –Ω–µ 0
        global_message_thread_id = None if global_thread_id == 0 else global_thread_id
        
        logger.debug(f"–∞–≤—Ç–æ–ø–∏–ª–æ—Ç: chat_id={global_chat_id}, thread_id={global_thread_id}, message_thread_id={global_message_thread_id}")
        
        while True:
            game = game_manager.get_game(chat_key)
            if not game or game.phase == GamePhase.ENDED:
                logger.info(f"–∞–≤—Ç–æ–ø–∏–ª–æ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω –¥–ª—è —á–∞—Ç–∞ {chat_key} (–∏–≥—Ä–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –∑–∞–∫–æ–Ω—á–µ–Ω–∞)")
                break

            # –ù–æ—á—å
            logger.debug(f"–∞–≤—Ç–æ–ø–∏–ª–æ—Ç: –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ—á–Ω—É—é —Ñ–∞–∑—É, —Ç–µ–∫—É—â–∞—è —Ñ–∞–∑–∞: {game.phase}, —Ä–∞—É–Ω–¥: {game.current_round}")
            if game.phase == GamePhase.NIGHT:
                logger.info(f"–∞–≤—Ç–æ–ø–∏–ª–æ—Ç: –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –Ω–æ—á–Ω–∞—è —Ñ–∞–∑–∞ –≤ —á–∞—Ç–µ {chat_key}")
                # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –Ω–æ—á–∏
                night_message = random.choice(NIGHT_PHASE_MESSAGES)
                await bot.send_message(global_chat_id, night_message, message_thread_id=global_message_thread_id)
                await _send_night_action_keyboards(chat_key, bot)

                # –ñ–¥–µ–º —Å—Ç—Ä–æ–≥–æ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è –Ω–æ—á–∏, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ç–æ–≥–æ, –∑–∞–≤–µ—Ä—à–∏–ª–∏ –ª–∏ –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è, —Å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è–º–∏
                waited = 0
                interval = 1  # –£–º–µ–Ω—å—à–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
                notified_night = set()
                logger.debug(f"–Ω–æ—á–Ω–∞—è —Ñ–∞–∑–∞: –Ω–∞—á–∏–Ω–∞–µ–º —Ç–∞–π–º–µ—Ä, –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {NIGHT_TIMEOUT_SECS} —Å–µ–∫.")
                while waited < NIGHT_TIMEOUT_SECS:
                    remaining = NIGHT_TIMEOUT_SECS - waited
                    logger.debug(f"–Ω–æ—á–Ω–∞—è —Ñ–∞–∑–∞: –ø—Ä–æ—à–ª–æ {waited} —Å–µ–∫., –æ—Å—Ç–∞–ª–æ—Å—å {remaining} —Å–µ–∫.")
                    
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≤–µ—Ä—à–∏–ª–∏ –ª–∏ –≤—Å–µ –Ω–æ—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
                    try:
                        current_game = game_manager.get_game(chat_key)
                        if current_game and current_game.phase == GamePhase.NIGHT:
                            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Å–µ –ª–∏ —Ä–æ–ª–∏ –≤—ã–ø–æ–ª–Ω–∏–ª–∏ –¥–µ–π—Å—Ç–≤–∏—è
                            required_roles = set()
                            if any(p.role == PlayerRole.MAFIA for p in current_game.get_alive_players()):
                                required_roles.add("mafia")
                            if any(p.role == PlayerRole.DOCTOR for p in current_game.get_alive_players()):
                                required_roles.add("doctor")
                            if any(p.role == PlayerRole.COMMISSIONER for p in current_game.get_alive_players()):
                                required_roles.add("commissioner")
                            if any(p.role == PlayerRole.BUTTERFLY for p in current_game.get_alive_players()):
                                required_roles.add("butterfly")
                            
                            completed_actions = current_game.night_actions_completed
                            if required_roles.issubset(completed_actions):
                                logger.info(f"–Ω–æ—á–Ω–∞—è —Ñ–∞–∑–∞: –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω—ã, –∑–∞–≤–µ—Ä—à–∞–µ–º –¥–æ—Å—Ä–æ—á–Ω–æ")
                                break
                            
                            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ –º–∞—Ñ–∏—è –Ω–µ –º–æ–∂–µ—Ç –¥–æ–≥–æ–≤–æ—Ä–∏—Ç—å—Å—è, –∂–¥–µ–º –µ—â–µ –Ω–µ–º–Ω–æ–≥–æ
                            if "mafia" in required_roles and "mafia" not in completed_actions:
                                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≥–æ–ª–æ—Å–æ–≤–∞–ª–∞ –ª–∏ –º–∞—Ñ–∏—è, –Ω–æ –Ω–µ –≤—ã–±—Ä–∞–ª–∞ —Ü–µ–ª—å
                                if current_game.mafia_votes and len(current_game.mafia_votes) > 0:
                                    alive_mafias = [p.user_id for p in current_game.get_players_by_role(PlayerRole.MAFIA)]
                                    if len(current_game.mafia_votes) == len(alive_mafias):
                                        # –í—Å–µ –º–∞—Ñ–∏–∏ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏, –Ω–æ —Ü–µ–ª—å –Ω–µ –≤—ã–±—Ä–∞–Ω–∞ (–Ω–∏—á—å—è)
                                        logger.info(f"–Ω–æ—á–Ω–∞—è —Ñ–∞–∑–∞: –º–∞—Ñ–∏—è –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∞, –Ω–æ –Ω–µ –≤—ã–±—Ä–∞–ª–∞ —Ü–µ–ª—å - –∂–¥–µ–º –µ—â–µ –Ω–µ–º–Ω–æ–≥–æ")
                                        # –ù–µ –∑–∞–≤–µ—Ä—à–∞–µ–º –¥–æ—Å—Ä–æ—á–Ω–æ, –¥–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –æ–±–¥—É–º—ã–≤–∞–Ω–∏–µ
                    except Exception as e:
                        logger.debug(f"–Ω–æ—á–Ω–∞—è —Ñ–∞–∑–∞: –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏–π: {e}")
                    
                    if remaining in {30, 15, 5} and remaining not in notified_night:
                        try:
                            # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é —Ñ—Ä–∞–∑—É –¥–ª—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –Ω–æ—á–∏
                            night_reminder = random.choice(TIME_REMINDER_MESSAGES["night"]).format(time=remaining)
                            await bot.send_message(
                                global_chat_id,
                                night_reminder,
                                message_thread_id=global_message_thread_id,
                            )
                            notified_night.add(remaining)
                            logger.debug(f"–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –Ω–æ—á–∏: {remaining} —Å–µ–∫. –æ—Å—Ç–∞–ª–æ—Å—å")
                        except Exception as e:
                            logger.exception(f"–æ—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –Ω–æ—á–∏: {e}")
                    await asyncio.sleep(interval)
                    waited += interval

                msg, _ = game_manager.process_night_results(chat_key)
                if msg:
                    await bot.send_message(global_chat_id, msg, message_thread_id=global_message_thread_id)
                    logger.info(f"–Ω–æ—á–Ω–∞—è —Ñ–∞–∑–∞: –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö: {msg[:100]}...")
                else:
                    logger.warning(f"–Ω–æ—á–Ω–∞—è —Ñ–∞–∑–∞: –Ω–µ –ø–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö")
                
                over, winner_msg = game_manager.check_game_over(chat_key)
                if over:
                    logger.info(f"–∞–≤—Ç–æ–ø–∏–ª–æ—Ç: –∏–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –≤ —á–∞—Ç–µ {chat_key} - –ø–æ–±–µ–¥–∞ {'–º–∞—Ñ–∏–∏' if '–º–∞—Ñ–∏—è' in winner_msg else '–º–∏—Ä–Ω—ã—Ö'}")
                    await bot.send_message(global_chat_id, winner_msg, message_thread_id=global_message_thread_id, reply_markup=get_new_game_keyboard())
                    game_manager.end_game(chat_key)
                    break

            # –î–µ–Ω—å
            current_game = game_manager.get_game(chat_key)
            logger.debug(f"–∞–≤—Ç–æ–ø–∏–ª–æ—Ç: –ø—Ä–æ–≤–µ—Ä—è–µ–º –¥–Ω–µ–≤–Ω—É—é —Ñ–∞–∑—É, —Ç–µ–∫—É—â–∞—è —Ñ–∞–∑–∞: {current_game.phase if current_game else 'None'}, —Ä–∞—É–Ω–¥: {current_game.current_round if current_game else 'None'}")
            if current_game and current_game.phase == GamePhase.DAY:
                logger.info(f"–∞–≤—Ç–æ–ø–∏–ª–æ—Ç: –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –¥–Ω–µ–≤–Ω–∞—è —Ñ–∞–∑–∞ –≤ —á–∞—Ç–µ {chat_key}")
                # –°–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–æ –∏—Ç–æ–≥–∏ –¥–µ–π—Å—Ç–≤–∏–π —Ä–æ–ª–µ–π –Ω–æ—á—å—é
                game = game_manager.get_game(chat_key)
                
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–æ–º–∏—Å—Å–∞—Ä–∞ –≤ –õ–° (–±–µ–∑ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –æ–±—â–∏–π —á–∞—Ç)
                if game.last_commissioner_checks:
                    for _cid, _target_id, is_mafia in game.last_commissioner_checks:
                        commissioner = game.players.get(_cid)
                        target = game.players.get(_target_id)
                        if target:
                            uname = f"@{target.username}" if target.username else None
                            disp = f"{target.first_name}{f' ({uname})' if uname else ''}"
                        else:
                            disp = "–∏–≥—Ä–æ–∫"
                        # –õ–° –∫–æ–º–∏—Å—Å–∞—Ä—É ‚Äî —Å —Ä–∞—Å–∫—Ä—ã—Ç–∏–µ–º —Ü–µ–ª–∏
                        if commissioner:
                            try:
                                await bot.send_message(
                                    commissioner.user_id,
                                    f"üëÆ –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏: {disp} ‚Äî {'–ú–ê–§–ò–Ø' if is_mafia else '–Ω–µ –º–∞—Ñ–∏—è'}."
                                )
                            except Exception as e:
                                logger.exception(f"–Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–º–∏—Å—Å–∞—Ä—É {_cid}: {e}")

                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–Ω–µ–≤–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
                day_message = random.choice(DAY_PHASE_MESSAGES)
                await bot.send_message(global_chat_id, day_message, message_thread_id=global_message_thread_id)
                
                # –ù–µ –¥—É–±–ª–∏—Ä—É–µ–º: –ø–æ—Å–ª–µ –Ω–æ—á–∏ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –µ–¥–∏–Ω–∞—è —Å–≤–æ–¥–∫–∞. –ü—É–±–ª–∏—á–Ω–∞—è —Å–≤–æ–¥–∫–∞ –∫–æ–º–∏—Å—Å–∞—Ä–∞ –æ–ø—É—Å–∫–∞–µ—Ç—Å—è.

                # –¢–∞–π–º–µ—Ä –¥–Ω—è —Å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è–º–∏ –∑–∞ 30/15/5 —Å–µ–∫—É–Ω–¥
                waited_day = 0
                interval = 1  # –£–º–µ–Ω—å—à–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
                notified = set()
                logger.debug(f"–¥–Ω–µ–≤–Ω–∞—è —Ñ–∞–∑–∞: –Ω–∞—á–∏–Ω–∞–µ–º —Ç–∞–π–º–µ—Ä, –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {DAY_DISCUSS_TIMEOUT_SECS} —Å–µ–∫.")
                while waited_day < DAY_DISCUSS_TIMEOUT_SECS:
                    remaining = DAY_DISCUSS_TIMEOUT_SECS - waited_day
                    logger.debug(f"–¥–Ω–µ–≤–Ω–∞—è —Ñ–∞–∑–∞: –ø—Ä–æ—à–ª–æ {waited_day} —Å–µ–∫., –æ—Å—Ç–∞–ª–æ—Å—å {remaining} —Å–µ–∫.")
                    if remaining in {30, 15, 5} and remaining not in notified:
                        try:
                            # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é —Ñ—Ä–∞–∑—É –¥–ª—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –¥–Ω–µ
                            day_reminder = random.choice(TIME_REMINDER_MESSAGES["day"]).format(time=remaining)
                            await bot.send_message(
                                global_chat_id,
                                day_reminder,
                                message_thread_id=global_message_thread_id,
                            )
                            notified.add(remaining)
                            logger.debug(f"–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –¥–Ω–µ: {remaining} —Å–µ–∫. –æ—Å—Ç–∞–ª–æ—Å—å")
                        except Exception as e:
                            logger.exception(f"–æ—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –¥–Ω–µ: {e}")
                    await asyncio.sleep(interval)
                    waited_day += interval

                # –û—Å–æ–±–æ–µ –ø—Ä–∞–≤–∏–ª–æ: –ø–æ—Å–ª–µ —Å–∞–º–æ–π –ø–µ—Ä–≤–æ–π –Ω–æ—á–∏ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–≤–æ–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ
                if not getattr(game, "first_voting_skipped", False) and game.current_round <= 1:
                    # –ü—É–±–ª–∏–∫—É–µ–º —Å–ø–∏—Å–∫–∏ –∂–∏–≤—ã—Ö/–º–µ—Ä—Ç–≤—ã—Ö –∏ —Å—Ä–∞–∑—É —É—Ö–æ–¥–∏–º –≤ –Ω–æ—á—å –±–µ–∑ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è
                    alive = []
                    dead = []
                    for p in game.players.values():
                        uname = f"@{p.username}" if p.username else None
                        disp = f"{p.first_name}{f' ({uname})' if uname else ''}"
                        (alive if p.is_alive else dead).append(disp)
                    # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è
                    no_voting_message = random.choice(NO_VOTING_FIRST_DAY_MESSAGES)
                    msg = (
                        no_voting_message + "\n\n" +
                        f"üë• –ñ–∏–≤—ã–µ ({len(alive)}):\n" + ("\n".join([f"‚Ä¢ {n}" for n in alive]) if alive else "‚Äî") + "\n" +
                        f"üíÄ –ú–µ—Ä—Ç–≤—ã–µ ({len(dead)}):\n" + ("\n".join([f"‚Ä¢ {n}" for n in dead]) if dead else "‚Äî")
                    )
                    await bot.send_message(global_chat_id, msg, message_thread_id=global_message_thread_id)
                    # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –Ω–æ—á–∏
                    game.phase = GamePhase.NIGHT
                    game.current_round += 1
                    game.all_actions_notified = False
                    game.first_voting_skipped = True
                    continue

                if game_manager.start_voting(chat_key):
                    logger.info(f"–∞–≤—Ç–æ–ø–∏–ª–æ—Ç: –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –≤ —á–∞—Ç–µ {chat_key}")
                    game = game_manager.get_game(chat_key)
                    alive = game.get_alive_players()
                    # –ü–µ—Ä–µ–≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ ‚Äî –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –Ω–µ —Ñ–∏–ª—å—Ç—Ä—É–µ–º
                    # –ë–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä–∞–≤–æ –≥–æ–ª–æ—Å–∞ —É –æ—Ç–≤–ª–µ—á–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ—à–ª–æ–π –Ω–æ—á—å—é
                    if game.last_butterfly_distract_target is not None:
                        for p in alive:
                            if p.user_id == game.last_butterfly_distract_target:
                                p.has_voted = True
                                break
                    # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è
                    title = random.choice(VOTING_START_MESSAGES)
                    sent = await bot.send_message(global_chat_id, title, reply_markup=get_voting_keyboard(alive), message_thread_id=global_message_thread_id)
                    try:
                        game.current_voting_message_id = sent.message_id
                    except Exception:
                        pass

                    # –ñ–¥–µ–º —Å—Ç—Ä–æ–≥–æ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è —Å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è–º–∏
                    waited_vote = 0
                    interval = 1  # –£–º–µ–Ω—å—à–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
                    notified_vote = set()
                    logger.debug(f"–≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ: –Ω–∞—á–∏–Ω–∞–µ–º —Ç–∞–π–º–µ—Ä, –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {VOTING_TIMEOUT_SECS} —Å–µ–∫.")
                    while waited_vote < VOTING_TIMEOUT_SECS:
                        # –†–∞–Ω–Ω–µ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ: –≤—Å–µ –∂–∏–≤—ã–µ (–∏ –¥–æ–ø—É—â–µ–Ω–Ω—ã–µ) –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏
                        try:
                            game = game_manager.get_game(chat_key)
                            if game and game.phase == GamePhase.VOTING:
                                eligible = game.get_alive_players()
                                if eligible and all(p.has_voted for p in eligible):
                                    logger.info("–≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ: –≤—Å–µ –≥–æ–ª–æ—Å–∞ –ø–æ–ª—É—á–µ–Ω—ã ‚Äî –∑–∞–≤–µ—Ä—à–∞–µ–º –¥–æ—Å—Ä–æ—á–Ω–æ")
                                    break
                        except Exception as e:
                            logger.debug(f"–≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ: –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ä–∞–Ω–Ω–µ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è: {e}")
                        remaining = VOTING_TIMEOUT_SECS - waited_vote
                        logger.debug(f"–≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ: –ø—Ä–æ—à–ª–æ {waited_vote} —Å–µ–∫., –æ—Å—Ç–∞–ª–æ—Å—å {remaining} —Å–µ–∫.")
                        if remaining in {30, 15, 5} and remaining not in notified_vote:
                            try:
                                # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é —Ñ—Ä–∞–∑—É –¥–ª—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–∏
                                vote_reminder = random.choice(TIME_REMINDER_MESSAGES["voting"]).format(time=remaining)
                                await bot.send_message(
                                    global_chat_id,
                                    vote_reminder,
                                    message_thread_id=global_message_thread_id,
                                )
                                notified_vote.add(remaining)
                                logger.debug(f"–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–∏: {remaining} —Å–µ–∫. –æ—Å—Ç–∞–ª–æ—Å—å")
                            except Exception as e:
                                logger.exception(f"–æ—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–∏: {e}")
                        await asyncio.sleep(interval)
                        waited_vote += interval

                    result_msg, executed_id = game_manager.get_voting_results(chat_key)
                    await bot.send_message(global_chat_id, result_msg, message_thread_id=global_message_thread_id)

                    # executed_id –º–æ–∂–µ—Ç –±—ã—Ç—å 0 —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –Ω–∏–∫—Ç–æ –Ω–µ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª ‚Äî –Ω–∏—á—å—è —Ç–µ–ø–µ—Ä—å –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –ø–µ—Ä–µ–≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è
                    
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–∫–æ–Ω—á–∞–Ω–∏–µ –∏–≥—Ä—ã —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–æ–≥–æ-—Ç–æ –∫–∞–∑–Ω–∏–ª–∏
                    over, winner_msg = game_manager.check_game_over(chat_key)
                    if over:
                        logger.info(f"–∞–≤—Ç–æ–ø–∏–ª–æ—Ç: –∏–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –≤ —á–∞—Ç–µ {chat_key} - –ø–æ–±–µ–¥–∞ {'–º–∞—Ñ–∏–∏' if '–º–∞—Ñ–∏—è' in winner_msg else '–º–∏—Ä–Ω—ã—Ö'}")
                        await bot.send_message(global_chat_id, winner_msg, message_thread_id=global_message_thread_id, reply_markup=get_new_game_keyboard())
                        game_manager.end_game(chat_key)
                        break
                    else:
                        # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥–∏ –ø–µ—Ä–µ–≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è, –µ—Å–ª–∏ –∫–∞–∑–Ω—å —Å–æ—Å—Ç–æ—è–ª–∞—Å—å
                        game = game_manager.get_game(chat_key)
                        if game:
                            game.revote_active = False
                            try:
                                game.revote_candidates.clear()
                            except Exception:
                                game.revote_candidates = set()
                        
                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏–≥—Ä–∞ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ—à–ª–∞ –≤ –Ω–æ—á–Ω—É—é —Ñ–∞–∑—É
                        game = game_manager.get_game(chat_key)
                        if game and game.phase == GamePhase.NIGHT:
                            logger.info(f"–∞–≤—Ç–æ–ø–∏–ª–æ—Ç: –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ, –ø–µ—Ä–µ—Ö–æ–¥ –∫ –Ω–æ—á–Ω–æ–π —Ñ–∞–∑–µ, —Ä–∞—É–Ω–¥ {game.current_round}")
                            # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥–∏ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π –Ω–æ—á–∏
                            game.night_prompts_sent = False
                            game.all_actions_notified = False
                            # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ü–∏–∫–ª –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–æ—á–Ω–æ–π —Ñ–∞–∑—ã
                            continue
                        else:
                            logger.warning(f"–∞–≤—Ç–æ–ø–∏–ª–æ—Ç: –ø–æ—Å–ª–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –∏–≥—Ä–∞ –Ω–µ –ø–µ—Ä–µ—à–ª–∞ –≤ –Ω–æ—á–Ω—É—é —Ñ–∞–∑—É, —Ñ–∞–∑–∞: {game.phase if game else 'None'}")
                            # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ–≤–æ–¥–∏–º –≤ –Ω–æ—á—å
                            if game:
                                game.phase = GamePhase.NIGHT
                                game.current_round += 1
                                game.night_prompts_sent = False
                                game.all_actions_notified = False
                                logger.info(f"–∞–≤—Ç–æ–ø–∏–ª–æ—Ç: –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–∞ –≤ –Ω–æ—á–Ω—É—é —Ñ–∞–∑—É, —Ä–∞—É–Ω–¥ {game.current_round}")
                                continue
                else:
                    # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ, –º–∞–ª–µ–Ω—å–∫–∞—è –ø–∞—É–∑–∞ –∏ –ø–æ–ø—ã—Ç–∫–∞ —Å–Ω–æ–≤–∞
                    await asyncio.sleep(3)

    except asyncio.CancelledError:
        logger.info(f"–∞–≤—Ç–æ–ø–∏–ª–æ—Ç –æ—Ç–º–µ–Ω–µ–Ω –¥–ª—è —á–∞—Ç–∞ {chat_key}")
        raise
    except Exception as e:
        logger.exception(f"–æ—à–∏–±–∫–∞ –∞–≤—Ç–æ–ø–∏–ª–æ—Ç–∞ –≤ —á–∞—Ç–µ {chat_key}: {e}")
        logger.debug(f"global_chat_id={global_chat_id if 'global_chat_id' in locals() else '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω'}, global_message_thread_id={global_message_thread_id if 'global_message_thread_id' in locals() else '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω'}")

@router.message(Command("mafia"))
async def cmd_mafia(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /mafia"""
    logger.debug(f"cmd_mafia: –∫–æ–º–∞–Ω–¥–∞ /mafia –≤—ã–∑–≤–∞–Ω–∞ –≤ —á–∞—Ç–µ {message.chat.id}, thread_id={message.message_thread_id}")
    
    # –°—Ç—Ä–æ–≥–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–º—ã - –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –¢–û–õ–¨–ö–û –≤ —Ç–µ–º–µ "–ò–≥—Ä–∞ –≤ ¬´–ú–∞—Ñ–∏—é¬ª" (ID: 39431)
    if not check_topic_permission(message):
        await message.answer("‚ö†Ô∏è –ö–æ–º–∞–Ω–¥–∞ /mafia –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤—ã–∑–≤–∞–Ω–∞ –≤ —Ç–µ–º–µ ¬´–ò–≥—Ä–∞ –≤ ¬´–ú–∞—Ñ–∏—é¬ª!")
        return
    
    logger.debug(f"cmd_mafia: –¥–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω, –∫–æ–º–∞–Ω–¥–∞ –≤ —Ç–µ–º–µ {message.message_thread_id}")
    
    # –°–æ–∑–¥–∞–µ–º –∏–≥—Ä—É –¥–ª—è —ç—Ç–æ–≥–æ —á–∞—Ç–∞ (—Å —É—á—ë—Ç–æ–º —Ç–µ–º—ã)
    chat_key = f"{message.chat.id}_{message.message_thread_id or 0}"
    game = game_manager.create_game(chat_key)
    logger.debug(f"cmd_mafia: —Å–æ–∑–¥–∞–Ω–∞ –∏–≥—Ä–∞ –¥–ª—è —á–∞—Ç–∞ {chat_key}")
    
    # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –æ—Ç –î–æ–Ω–∞ –í–∏—Ç—Ç–µ
    greeting = random.choice(DON_VITTE_GREETINGS)
    
    await message.answer(
        greeting,
        reply_markup=get_main_menu_keyboard()
    )

@router.callback_query(F.data == "test_game")
async def show_test_game_menu(callback: CallbackQuery):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ–Ω—é —Ç–µ—Å—Ç–æ–≤–æ–π –∏–≥—Ä—ã"""
    logger.debug(f"show_test_game_menu: –ø–æ–∫–∞–∑–∞–Ω–æ –º–µ–Ω—é —Ç–µ—Å—Ç–æ–≤–æ–π –∏–≥—Ä—ã –¥–ª—è —á–∞—Ç–∞ {callback.message.chat.id}")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ - –≤ —Ç–µ–º–µ "–ò–≥—Ä–∞ –≤ ¬´–ú–∞—Ñ–∏—é¬ª" —Ä–∞–∑—Ä–µ—à–∞–µ–º –≤—Å–µ–º –∞–¥–º–∏–Ω–∞–º
    is_admin = False
    is_creator = False
    chat_type = callback.message.chat.type
    
    logger.debug(f"show_test_game_menu: —Ç–∏–ø —á–∞—Ç–∞: {chat_type}, user_id: {callback.from_user.id}")
    
    try:
        member = await callback.message.bot.get_chat_member(callback.message.chat.id, callback.from_user.id)
        is_admin = member.status in {"administrator", "creator"}
        is_creator = member.status == "creator"
        logger.debug(f"show_test_game_menu: –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ - —Å—Ç–∞—Ç—É—Å: {member.status}, is_admin: {is_admin}, is_creator: {is_creator}")
    except Exception as e:
        logger.warning(f"show_test_game_menu: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}")
        # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞ –≤ —Ñ–æ—Ä—É–º–µ, —Ä–∞–∑—Ä–µ—à–∞–µ–º –¥–æ—Å—Ç—É–ø
        if chat_type == "supergroup":
            is_admin = True
            logger.debug(f"show_test_game_menu: —Ä–∞–∑—Ä–µ—à–µ–Ω –¥–æ—Å—Ç—É–ø –∏–∑-–∑–∞ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –≤ —Å—É–ø–µ—Ä–≥—Ä—É–ø–ø–µ")
    
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ —ç—Ç–æ —Ç–µ–º–∞ "–ò–≥—Ä–∞ –≤ ¬´–ú–∞—Ñ–∏—é¬ª", —Ç–æ —Ä–∞–∑—Ä–µ—à–∞–µ–º –¥–æ—Å—Ç—É–ø
    if not (is_admin or is_creator):
        if check_topic_permission(callback.message):
            is_admin = True
            logger.debug(f"show_test_game_menu: —Ä–∞–∑—Ä–µ—à–µ–Ω –¥–æ—Å—Ç—É–ø –≤ —Ç–µ–º–µ ¬´–ò–≥—Ä–∞ –≤ ¬´–ú–∞—Ñ–∏—é¬ª¬ª")
    
    # –í–†–ï–ú–ï–ù–ù–û: –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ —Ä–∞–∑—Ä–µ—à–∞–µ–º –≤—Å–µ–º –≤ —Ç–µ–º–µ "–ò–≥—Ä–∞ –≤ ¬´–ú–∞—Ñ–∏—é¬ª"
    if not (is_admin or is_creator):
        if check_topic_permission(callback.message):
            logger.warning(f"show_test_game_menu: –í–†–ï–ú–ï–ù–ù–´–ô –¥–æ—Å—Ç—É–ø –∫ —Ç–µ—Å—Ç–æ–≤–æ–π –∏–≥—Ä–µ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏")
            # –†–∞–∑—Ä–µ—à–∞–µ–º –¥–æ—Å—Ç—É–ø –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
        else:
            await callback.answer("‚ö†Ô∏è –¢–µ—Å—Ç–æ–≤–∞—è –∏–≥—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –≤ —Ç–µ–º–µ ¬´–ò–≥—Ä–∞ –≤ ¬´–ú–∞—Ñ–∏—é¬ª¬ª!", show_alert=True)
            return
    
    await callback.message.answer(
        "üß™ –¢–ï–°–¢–û–í–ê–Ø –ò–ì–†–ê üß™\n\n"
        "–ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –∏–≥—Ä—É —Å 10 –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–º–∏ –∏–≥—Ä–æ–∫–∞–º–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–æ–≤–æ–≤–≤–µ–¥–µ–Ω–∏–π.\n\n"
        "–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:\n"
        "‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–æ—á–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π\n"
        "‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ\n"
        "‚Ä¢ –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª –∏–≥—Ä—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è\n\n"
        "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:\n"
        "‚Ä¢ –ó–∞–ø—É—Å–∫/–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ—Å—Ç–∞\n"
        "‚Ä¢ –ü–∞—É–∑–∞ –∏ —Å–±—Ä–æ—Å\n"
        "‚Ä¢ –¢–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=get_test_game_control_keyboard()
    )
    await callback.answer()

@router.callback_query(F.data == "start_test_game")
async def start_test_game(callback: CallbackQuery):
    """–ó–∞–ø—É—Å–∫–∞–µ—Ç —Ç–µ—Å—Ç–æ–≤—É—é –∏–≥—Ä—É"""
    logger.debug(f"start_test_game: –ø–æ–ø—ã—Ç–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–π –∏–≥—Ä—ã –≤ —á–∞—Ç–µ {callback.message.chat.id}")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ - –±–æ–ª–µ–µ –≥–∏–±–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
    is_admin = False
    is_creator = False
    chat_type = callback.message.chat.type
    
    try:
        member = await callback.message.bot.get_chat_member(callback.message.chat.id, callback.from_user.id)
        is_admin = member.status in {"administrator", "creator"}
        is_creator = member.status == "creator"
        logger.debug(f"start_test_game: —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {member.status}")
    except Exception as e:
        logger.warning(f"start_test_game: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}")
        # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞, —Ä–∞–∑—Ä–µ—à–∞–µ–º –¥–æ—Å—Ç—É–ø –≤ —Å—É–ø–µ—Ä–≥—Ä—É–ø–ø–µ
        if chat_type == "supergroup":
            is_admin = True
            logger.debug(f"start_test_game: —Ä–∞–∑—Ä–µ—à–µ–Ω –¥–æ—Å—Ç—É–ø –≤ —Å—É–ø–µ—Ä–≥—Ä—É–ø–ø–µ")
    
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ —ç—Ç–æ —Ç–µ–º–∞ "–ò–≥—Ä–∞ –≤ ¬´–ú–∞—Ñ–∏—é¬ª", —Ç–æ —Ä–∞–∑—Ä–µ—à–∞–µ–º –¥–æ—Å—Ç—É–ø
    if not (is_admin or is_creator):
        if check_topic_permission(callback.message):
            is_admin = True
            logger.debug(f"start_test_game: —Ä–∞–∑—Ä–µ—à–µ–Ω –¥–æ—Å—Ç—É–ø –≤ —Ç–µ–º–µ ¬´–ò–≥—Ä–∞ –≤ ¬´–ú–∞—Ñ–∏—é¬ª¬ª")
    
    # –í–†–ï–ú–ï–ù–ù–û: –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ —Ä–∞–∑—Ä–µ—à–∞–µ–º –≤—Å–µ–º –≤ —Ç–µ–º–µ "–ò–≥—Ä–∞ –≤ ¬´–ú–∞—Ñ–∏—é¬ª"
    if not (is_admin or is_creator):
        if check_topic_permission(callback.message):
            logger.warning(f"start_test_game: –í–†–ï–ú–ï–ù–ù–´–ô –¥–æ—Å—Ç—É–ø –∫ —Ç–µ—Å—Ç–æ–≤–æ–π –∏–≥—Ä–µ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏")
            # –†–∞–∑—Ä–µ—à–∞–µ–º –¥–æ—Å—Ç—É–ø –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
        else:
            await callback.answer("‚ö†Ô∏è –¢–µ—Å—Ç–æ–≤–∞—è –∏–≥—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –≤ —Ç–µ–º–µ ¬´–ò–≥—Ä–∞ –≤ ¬´–ú–∞—Ñ–∏—é¬ª¬ª!", show_alert=True)
            return
    
    chat_key = get_chat_key(callback.message)
    
    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∞–≤—Ç–æ–ø–∏–ª–æ—Ç –µ—Å–ª–∏ –µ—Å—Ç—å
    if _autopilot_tasks.get(chat_key) and not _autopilot_tasks[chat_key].done():
        logger.info(f"start_test_game: –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∞–≤—Ç–æ–ø–∏–ª–æ—Ç–∞ –¥–ª—è —á–∞—Ç–∞ {chat_key}")
        _autopilot_tasks[chat_key].cancel()
        await asyncio.sleep(1)  # –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
    
    # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≤–µ—Ä—à–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –∏–≥—Ä—É
    game_manager.end_game(chat_key)
    
    # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—É—é –∏–≥—Ä—É
    logger.info(f"start_test_game: —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–π –∏–≥—Ä—ã –¥–ª—è —á–∞—Ç–∞ {chat_key}")
    game = game_manager.create_test_game(chat_key)
    
    if game:
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é —Ñ–∞–∑—É –∏–≥—Ä—ã
        game.phase = GamePhase.NIGHT
        game.current_round = 1
        logger.info(f"start_test_game: –∏–≥—Ä–∞ —Å–æ–∑–¥–∞–Ω–∞, —Ñ–∞–∑–∞: {game.phase}, —Ä–∞—É–Ω–¥: {game.current_round}, –∏–≥—Ä–æ–∫–æ–≤: {len(game.players)}")
        
        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
        if len(game.players) == 0:
            logger.error(f"start_test_game: –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê! –ò–≥—Ä–æ–∫–∏ –Ω–µ —Å–æ–∑–¥–∞–Ω—ã!")
            await callback.message.answer(
                "‚ùå –û–®–ò–ë–ö–ê –°–û–ó–î–ê–ù–ò–Ø –¢–ï–°–¢–û–í–û–ô –ò–ì–†–´!\n\n"
                "–ò–≥—Ä–æ–∫–∏ –Ω–µ –±—ã–ª–∏ —Å–æ–∑–¥–∞–Ω—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏.",
                reply_markup=get_test_game_control_keyboard()
            )
        else:
            logger.info(f"start_test_game: —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ {len(game.players)} –∏–≥—Ä–æ–∫–æ–≤")
            for player_id, player in game.players.items():
                logger.debug(f"start_test_game: –∏–≥—Ä–æ–∫ {player_id}: {player.first_name} ({player.role.value})")
        
            await callback.message.answer(
                "üß™ –¢–ï–°–¢–û–í–ê–Ø –ò–ì–†–ê –ó–ê–ü–£–©–ï–ù–ê! üß™\n\n"
                f"–°–æ–∑–¥–∞–Ω–æ {len(game.players)} –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤:\n"
                + "\n".join([f"‚Ä¢ {p.first_name} ({p.role.value})" for p in game.players.values()]) +
                "\n\n–ò–≥—Ä–∞ –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ—Ö–æ–¥–∏—Ç—å –≤—Å–µ —Ñ–∞–∑—ã.\n"
                "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è —Ç–µ—Å—Ç–∞.",
                reply_markup=get_test_game_control_keyboard()
            )
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–ø–∏–ª–æ—Ç –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–π –∏–≥—Ä—ã
        logger.info(f"start_test_game: –∑–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∞–≤—Ç–æ–ø–∏–ª–æ—Ç–∞ –¥–ª—è —á–∞—Ç–∞ {chat_key}")
        if _autopilot_tasks.get(chat_key) and not _autopilot_tasks[chat_key].done():
            logger.info(f"start_test_game: –æ—Ç–º–µ–Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∞–≤—Ç–æ–ø–∏–ª–æ—Ç–∞ –¥–ª—è —á–∞—Ç–∞ {chat_key}")
            _autopilot_tasks[chat_key].cancel()
        
        _autopilot_tasks[chat_key] = asyncio.create_task(_test_autopilot_loop(chat_key, callback.bot))
        logger.info(f"start_test_game: —Ç–µ—Å—Ç–æ–≤—ã–π –∞–≤—Ç–æ–ø–∏–ª–æ—Ç —Å–æ–∑–¥–∞–Ω –∫–∞–∫ –∑–∞–¥–∞—á–∞ –¥–ª—è —á–∞—Ç–∞ {chat_key}")
        
        logger.info(f"start_test_game: —Ç–µ—Å—Ç–æ–≤–∞—è –∏–≥—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞ –≤ —á–∞—Ç–µ {chat_key}")
    else:
        await callback.answer("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –∏–≥—Ä—É!", show_alert=True)
    
    await callback.answer()

@router.callback_query(F.data == "stop_test_game")
async def stop_test_game(callback: CallbackQuery):
    """–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ç–µ—Å—Ç–æ–≤—É—é –∏–≥—Ä—É"""
    logger.debug(f"stop_test_game: –ø–æ–ø—ã—Ç–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç–µ—Å—Ç–æ–≤–æ–π –∏–≥—Ä—ã –≤ —á–∞—Ç–µ {callback.message.chat.id}")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ - –±–æ–ª–µ–µ –≥–∏–±–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
    is_admin = False
    is_creator = False
    chat_type = callback.message.chat.type
    
    try:
        member = await callback.message.bot.get_chat_member(callback.message.chat.id, callback.from_user.id)
        is_admin = member.status in {"administrator", "creator"}
        is_creator = member.status == "creator"
        logger.debug(f"stop_test_game: —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {member.status}")
    except Exception as e:
        logger.warning(f"stop_test_game: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}")
        # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞, —Ä–∞–∑—Ä–µ—à–∞–µ–º –¥–æ—Å—Ç—É–ø –≤ —Å—É–ø–µ—Ä–≥—Ä—É–ø–ø–µ
        if chat_type == "supergroup":
            is_admin = True
            logger.debug(f"stop_test_game: —Ä–∞–∑—Ä–µ—à–µ–Ω –¥–æ—Å—Ç—É–ø –≤ —Å—É–ø–µ—Ä–≥—Ä—É–ø–ø–µ")
    
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ —ç—Ç–æ —Ç–µ–º–∞ "–ò–≥—Ä–∞ –≤ ¬´–ú–∞—Ñ–∏—é¬ª", —Ç–æ —Ä–∞–∑—Ä–µ—à–∞–µ–º –¥–æ—Å—Ç—É–ø
    if not (is_admin or is_creator):
        if check_topic_permission(callback.message):
            is_admin = True
            logger.debug(f"stop_test_game: —Ä–∞–∑—Ä–µ—à–µ–Ω –¥–æ—Å—Ç—É–ø –≤ —Ç–µ–º–µ ¬´–ò–≥—Ä–∞ –≤ ¬´–ú–∞—Ñ–∏—é¬ª¬ª")
    
    # –í–†–ï–ú–ï–ù–ù–û: –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ —Ä–∞–∑—Ä–µ—à–∞–µ–º –≤—Å–µ–º –≤ —Ç–µ–º–µ "–ò–≥—Ä–∞ –≤ ¬´–ú–∞—Ñ–∏—é¬ª"
    if not (is_admin or is_creator):
        if check_topic_permission(callback.message):
            logger.warning(f"stop_test_game: –í–†–ï–ú–ï–ù–ù–´–ô –¥–æ—Å—Ç—É–ø –∫ —Ç–µ—Å—Ç–æ–≤–æ–π –∏–≥—Ä–µ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏")
            # –†–∞–∑—Ä–µ—à–∞–µ–º –¥–æ—Å—Ç—É–ø –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
        else:
            await callback.answer("‚ö†Ô∏è –¢–µ—Å—Ç–æ–≤–∞—è –∏–≥—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –≤ —Ç–µ–º–µ ¬´–ò–≥—Ä–∞ –≤ ¬´–ú–∞—Ñ–∏—é¬ª¬ª!", show_alert=True)
            return
    
    chat_key = get_chat_key(callback.message)
    
    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤—Ç–æ–ø–∏–ª–æ—Ç
    if _autopilot_tasks.get(chat_key):
        _autopilot_tasks[chat_key].cancel()
        del _autopilot_tasks[chat_key]
    
    # –ó–∞–≤–µ—Ä—à–∞–µ–º –∏–≥—Ä—É
    game_manager.end_game(chat_key)
    
    await callback.message.answer(
        "‚èπÔ∏è –¢–ï–°–¢–û–í–ê–Ø –ò–ì–†–ê –û–°–¢–ê–ù–û–í–õ–ï–ù–ê ‚èπÔ∏è\n\n"
        "–ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –í—Å–µ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã.\n"
        "–ú–æ–∂–µ—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–æ–≤—ã–π —Ç–µ—Å—Ç –∏–ª–∏ –≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.",
        reply_markup=get_main_menu_keyboard()
    )
    
    logger.info(f"stop_test_game: —Ç–µ—Å—Ç–æ–≤–∞—è –∏–≥—Ä–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –≤ —á–∞—Ç–µ {chat_key}")
    await callback.answer()

async def _test_autopilot_loop(chat_key: str, bot):
    """–ê–≤—Ç–æ–ø–∏–ª–æ—Ç –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–π –∏–≥—Ä—ã"""
    logger.info(f"—Å—Ç–∞—Ä—Ç —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∞–≤—Ç–æ–ø–∏–ª–æ—Ç–∞ –¥–ª—è —á–∞—Ç–∞ {chat_key}")
    try:
        global_chat_id = get_chat_id_from_key(chat_key)
        global_thread_id = get_thread_id_from_key(chat_key)
        global_message_thread_id = None if global_thread_id == 0 else global_thread_id
        
        logger.debug(f"—Ç–µ—Å—Ç–æ–≤—ã–π –∞–≤—Ç–æ–ø–∏–ª–æ—Ç: chat_id={global_chat_id}, thread_id={global_thread_id}")
        
        # –ù–∞—á–∏–Ω–∞–µ–º —Å –Ω–æ—á–Ω–æ–π —Ñ–∞–∑—ã
        game = game_manager.get_game(chat_key)
        if game:
            game.phase = GamePhase.NIGHT
            game.current_round = 1
            logger.info(f"—Ç–µ—Å—Ç–æ–≤—ã–π –∞–≤—Ç–æ–ø–∏–ª–æ—Ç: —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –Ω–∞—á–∞–ª—å–Ω–∞—è —Ñ–∞–∑–∞ NIGHT –¥–ª—è —á–∞—Ç–∞ {chat_key}")
        
        while True:
            game = game_manager.get_game(chat_key)
            if not game or game.phase == GamePhase.ENDED or not game.is_test_game:
                logger.info(f"—Ç–µ—Å—Ç–æ–≤—ã–π –∞–≤—Ç–æ–ø–∏–ª–æ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω –¥–ª—è —á–∞—Ç–∞ {chat_key}")
                break
            
            logger.info(f"—Ç–µ—Å—Ç–æ–≤—ã–π –∞–≤—Ç–æ–ø–∏–ª–æ—Ç: === –ù–ê–ß–ê–õ–û –¶–ò–ö–õ–ê ===")
            logger.info(f"—Ç–µ—Å—Ç–æ–≤—ã–π –∞–≤—Ç–æ–ø–∏–ª–æ—Ç: —Ñ–∞–∑–∞: {game.phase}, —Ä–∞—É–Ω–¥: {game.current_round}")
            logger.info(f"—Ç–µ—Å—Ç–æ–≤—ã–π –∞–≤—Ç–æ–ø–∏–ª–æ—Ç: –∂–∏–≤—ã—Ö –∏–≥—Ä–æ–∫–æ–≤: {len(game.get_alive_players())}")
            logger.info(f"—Ç–µ—Å—Ç–æ–≤—ã–π –∞–≤—Ç–æ–ø–∏–ª–æ—Ç: –≤—Å–µ–≥–æ –∏–≥—Ä–æ–∫–æ–≤: {len(game.players)}")
            
            # –õ–æ–≥–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤
            for player_id, player in game.players.items():
                status = "–ñ–ò–í" if player.is_alive else "–ú–ï–†–¢–í"
                logger.debug(f"—Ç–µ—Å—Ç–æ–≤—ã–π –∞–≤—Ç–æ–ø–∏–ª–æ—Ç: –∏–≥—Ä–æ–∫ {player.first_name} (ID: {player_id}): {status}, —Ä–æ–ª—å: {player.role.value}")
            
            logger.info(f"—Ç–µ—Å—Ç–æ–≤—ã–π –∞–≤—Ç–æ–ø–∏–ª–æ—Ç: ===================")
            
            # –ù–æ—á—å
            if game.phase == GamePhase.NIGHT:
                logger.info(f"—Ç–µ—Å—Ç–æ–≤—ã–π –∞–≤—Ç–æ–ø–∏–ª–æ—Ç: –Ω–æ—á–Ω–∞—è —Ñ–∞–∑–∞ –≤ —á–∞—Ç–µ {chat_key}")
                night_message = random.choice(NIGHT_PHASE_MESSAGES)
                await bot.send_message(global_chat_id, night_message, message_thread_id=global_message_thread_id)
                
                # –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –¥–ª—è –∏–º–∏—Ç–∞—Ü–∏–∏ —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏–π –∏–≥—Ä–æ–∫–æ–≤
                await asyncio.sleep(5)
                
                # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–ø–æ–ª–Ω—è–µ–º –Ω–æ—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
                logger.info(f"—Ç–µ—Å—Ç–æ–≤—ã–π –∞–≤—Ç–æ–ø–∏–ª–æ—Ç: –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–æ—á–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è —Ä–∞—É–Ω–¥–∞ {game.current_round}")
                game_manager.execute_test_night_actions(chat_key)
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–æ—á–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π
                game = game_manager.get_game(chat_key)
                if game:
                    logger.info(f"—Ç–µ—Å—Ç–æ–≤—ã–π –∞–≤—Ç–æ–ø–∏–ª–æ—Ç: === –ü–†–û–í–ï–†–ö–ê –†–ï–ó–£–õ–¨–¢–ê–¢–û–í –ù–û–ß–ò {game.current_round} ===")
                    logger.info(f"—Ç–µ—Å—Ç–æ–≤—ã–π –∞–≤—Ç–æ–ø–∏–ª–æ—Ç: –¶–µ–ª—å –º–∞—Ñ–∏–∏: {game.night_kill_target}")
                    logger.info(f"—Ç–µ—Å—Ç–æ–≤—ã–π –∞–≤—Ç–æ–ø–∏–ª–æ—Ç: –°–ø–∞—Å–µ–Ω–∏—è –¥–æ–∫—Ç–æ—Ä–∞: {game.doctor_saves}")
                    logger.info(f"—Ç–µ—Å—Ç–æ–≤—ã–π –∞–≤—Ç–æ–ø–∏–ª–æ—Ç: –ü—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–º–∏—Å—Å–∞—Ä–∞: {game.commissioner_check_results}")
                    logger.info(f"—Ç–µ—Å—Ç–æ–≤—ã–π –∞–≤—Ç–æ–ø–∏–ª–æ—Ç: –û—Ç–≤–ª–µ—á–µ–Ω–∏—è –±–∞–±–æ—á–∫–∏: {game.butterfly_distract_target}")
                    
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫—Ç–æ –≤—ã–∂–∏–ª
                    alive_after_night = game.get_alive_players()
                    logger.info(f"—Ç–µ—Å—Ç–æ–≤—ã–π –∞–≤—Ç–æ–ø–∏–ª–æ—Ç: –ü–æ—Å–ª–µ –Ω–æ—á–∏ –∂–∏–≤—ã—Ö –∏–≥—Ä–æ–∫–æ–≤: {len(alive_after_night)}")
                    for player in alive_after_night:
                        logger.debug(f"—Ç–µ—Å—Ç–æ–≤—ã–π –∞–≤—Ç–æ–ø–∏–ª–æ—Ç: –∂–∏–≤: {player.first_name} ({player.role.value})")
                    logger.info(f"—Ç–µ—Å—Ç–æ–≤—ã–π –∞–≤—Ç–æ–ø–∏–ª–æ—Ç: ==========================================")
                
                # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –¥–Ω—é
                game.phase = GamePhase.DAY
                game.current_round += 1
                logger.info(f"—Ç–µ—Å—Ç–æ–≤—ã–π –∞–≤—Ç–æ–ø–∏–ª–æ—Ç: –ø–µ—Ä–µ—Ö–æ–¥ –∫ –¥–Ω–µ–≤–Ω–æ–π —Ñ–∞–∑–µ, —Ä–∞—É–Ω–¥ {game.current_round}")
                
                # –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –ø–µ—Ä–µ–¥ –¥–Ω–µ–º
                await asyncio.sleep(3)
            
            # –î–µ–Ω—å
            elif game.phase == GamePhase.DAY:
                logger.info(f"—Ç–µ—Å—Ç–æ–≤—ã–π –∞–≤—Ç–æ–ø–∏–ª–æ—Ç: –¥–Ω–µ–≤–Ω–∞—è —Ñ–∞–∑–∞ –≤ —á–∞—Ç–µ {chat_key}")
                day_message = random.choice(DAY_PHASE_MESSAGES)
                await bot.send_message(global_chat_id, day_message, message_thread_id=global_message_thread_id)
                
                # –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –¥–ª—è –∏–º–∏—Ç–∞—Ü–∏–∏ –æ–±—Å—É–∂–¥–µ–Ω–∏—è
                await asyncio.sleep(10)
                
                # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—é
                logger.info(f"—Ç–µ—Å—Ç–æ–≤—ã–π –∞–≤—Ç–æ–ø–∏–ª–æ—Ç: –ø–æ–ø—ã—Ç–∫–∞ –Ω–∞—á–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –≤ —á–∞—Ç–µ {chat_key}")
                if game_manager.start_voting(chat_key):
                    game.phase = GamePhase.VOTING
                    logger.info(f"—Ç–µ—Å—Ç–æ–≤—ã–π –∞–≤—Ç–æ–ø–∏–ª–æ—Ç: –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –Ω–∞—á–∞—Ç–æ, —Ñ–∞–∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞ VOTING")
                else:
                    # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –Ω–æ—á–∏
                    logger.warning(f"—Ç–µ—Å—Ç–æ–≤—ã–π –∞–≤—Ç–æ–ø–∏–ª–æ—Ç: –Ω–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –Ω–æ—á–∏")
                    game.phase = GamePhase.NIGHT
                    continue
            
            # –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ
            elif game.phase == GamePhase.VOTING:
                logger.info(f"—Ç–µ—Å—Ç–æ–≤—ã–π –∞–≤—Ç–æ–ø–∏–ª–æ—Ç: –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –≤ —á–∞—Ç–µ {chat_key}")
                voting_message = random.choice(VOTING_START_MESSAGES)
                await bot.send_message(global_chat_id, voting_message, message_thread_id=global_message_thread_id)
                
                # –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –¥–ª—è –∏–º–∏—Ç–∞—Ü–∏–∏ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è
                await asyncio.sleep(8)
                
                # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–ø–æ–ª–Ω—è–µ–º –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ
                logger.info(f"—Ç–µ—Å—Ç–æ–≤—ã–π –∞–≤—Ç–æ–ø–∏–ª–æ—Ç: –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –≤ —á–∞—Ç–µ {chat_key}")
                game_manager.execute_test_voting(chat_key)
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è
                game = game_manager.get_game(chat_key)
                if game:
                    logger.info(f"—Ç–µ—Å—Ç–æ–≤—ã–π –∞–≤—Ç–æ–ø–∏–ª–æ—Ç: === –ü–†–û–í–ï–†–ö–ê –†–ï–ó–£–õ–¨–¢–ê–¢–û–í –ì–û–õ–û–°–û–í–ê–ù–ò–Ø ===")
                    logger.info(f"—Ç–µ—Å—Ç–æ–≤—ã–π –∞–≤—Ç–æ–ø–∏–ª–æ—Ç: –í—Å–µ–≥–æ –≥–æ–ª–æ—Å–æ–≤: {len(game.votes)}")
                    for voter_id, target_id in game.votes.items():
                        voter = game.players.get(voter_id)
                        target = game.players.get(target_id)
                        if voter and target:
                            logger.info(f"—Ç–µ—Å—Ç–æ–≤—ã–π –∞–≤—Ç–æ–ø–∏–ª–æ—Ç: –≥–æ–ª–æ—Å: {voter.first_name} ({voter.role.value}) ‚Üí {target.first_name} ({target.role.value})")
                    logger.info(f"—Ç–µ—Å—Ç–æ–≤—ã–π –∞–≤—Ç–æ–ø–∏–ª–æ—Ç: ==========================================")
                
                # –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è
                logger.info(f"—Ç–µ—Å—Ç–æ–≤—ã–π –∞–≤—Ç–æ–ø–∏–ª–æ—Ç: –ø–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –≤ —á–∞—Ç–µ {chat_key}")
                result_msg, executed_id = game_manager.get_voting_results(chat_key)
                await bot.send_message(global_chat_id, result_msg, message_thread_id=global_message_thread_id)
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–∫–æ–Ω—á–∞–Ω–∏–µ –∏–≥—Ä—ã
                over, winner_msg = game_manager.check_game_over(chat_key)
                if over:
                    logger.info(f"—Ç–µ—Å—Ç–æ–≤—ã–π –∞–≤—Ç–æ–ø–∏–ª–æ—Ç: –∏–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –≤ —á–∞—Ç–µ {chat_key}")
                    await bot.send_message(global_chat_id, winner_msg, message_thread_id=global_message_thread_id)
                    game_manager.end_game(chat_key)
                    break
                
                # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –Ω–æ—á–∏
                game.phase = GamePhase.NIGHT
                game.current_round += 1
                logger.info(f"—Ç–µ—Å—Ç–æ–≤—ã–π –∞–≤—Ç–æ–ø–∏–ª–æ—Ç: –ø–µ—Ä–µ—Ö–æ–¥ –∫ –Ω–æ—á–Ω–æ–π —Ñ–∞–∑–µ, —Ä–∞—É–Ω–¥ {game.current_round}")
                await asyncio.sleep(3)
            
            # –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –º–µ–∂–¥—É —Ü–∏–∫–ª–∞–º–∏
            await asyncio.sleep(1)
            
    except asyncio.CancelledError:
        logger.info(f"—Ç–µ—Å—Ç–æ–≤—ã–π –∞–≤—Ç–æ–ø–∏–ª–æ—Ç –æ—Ç–º–µ–Ω–µ–Ω –¥–ª—è —á–∞—Ç–∞ {chat_key}")
        raise
    except Exception as e:
        logger.exception(f"–æ—à–∏–±–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∞–≤—Ç–æ–ø–∏–ª–æ—Ç–∞ –≤ —á–∞—Ç–µ {chat_key}: {e}")

@router.callback_query(F.data == "rules")
async def show_rules(callback: CallbackQuery):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã"""
    logger.debug(f"show_rules: –ø–æ–∫–∞–∑ –ø—Ä–∞–≤–∏–ª –¥–ª—è —á–∞—Ç–∞ {callback.message.chat.id}")
    
    rules_text = (
        "üìú –ü–†–ê–í–ò–õ–ê –ò–ì–†–´ ¬´–ú–ê–§–ò–Ø –ú–£–ò–í¬ª üìú\n\n"
        "       üåÉ –ì–æ—Ä–æ–¥ –∑–∞—Å—ã–ø–∞–µ—Ç, —Ç–µ–Ω–∏ —Å–≥—É—â–∞—é—Ç—Å—è –Ω–∞–¥ –ú–£–ò–í–æ–º... –ü—Ä–æ—Å—ã–ø–∞–µ—Ç—Å—è –º–∞—Ñ–∏—è‚Ä¶\n\n"
        "–ö–∞–∂–¥—ã–π –∂–∏—Ç–µ–ª—å –Ω–æ—Å–∏—Ç –º–∞—Å–∫—É. –ö—Ç–æ-—Ç–æ —Å–∫—Ä—ã–≤–∞–µ—Ç –∫—Ä–æ–≤—å –Ω–∞ —Ä—É–∫–∞—Ö, –∫—Ç–æ-—Ç–æ ‚Äì —Å—Ç—Ä–∞—Ö –≤ –≥–ª–∞–∑–∞—Ö.\n"
        "–¢–≤–æ—è –∑–∞–¥–∞—á–∞ –ø—Ä–æ—Å—Ç–∞: –≤—ã–∂–∏—Ç—å. –ù–æ —Å–ø–æ—Å–æ–± —É –∫–∞–∂–¥–æ–≥–æ —Å–≤–æ–π.\n\n"
        "       üë• –†–æ–ª–∏:\n"
        "‚Ä¢ üî™ –ú–∞—Ñ–∏—è ‚Äî —É–±–∏–π—Ü—ã –≤ –¥–æ—Ä–æ–≥–∏—Ö –∫–æ—Å—Ç—é–º–∞—Ö. –ù–æ—á—å—é –æ–Ω–∏ —Ä–µ—à–∞—é—Ç, –∫—Ç–æ –Ω–µ –¥–æ–∂–∏–≤—ë—Ç –¥–æ —É—Ç—Ä–∞.\n"
        "‚Ä¢ üëÆ –ö–æ–º–∏—Å—Å–∞—Ä ‚Äî –≥–ª–∞–∑ –∑–∞–∫–æ–Ω–∞. –ö–∞–∂–¥—É—é –Ω–æ—á—å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –æ–¥–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞.\n"
        "‚Ä¢ ü©∫ –î–æ–∫—Ç–æ—Ä ‚Äî –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π, –∫—Ç–æ –º–æ–∂–µ—Ç —Å–ø–∞—Å—Ç–∏ –∂–∏–∑–Ω—å. –õ–µ—á–∏—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞.\n"
        "‚Ä¢ üíÉ –ù–æ—á–Ω–∞—è –±–∞–±–æ—á–∫–∞ ‚Äî –∫–æ–≤–∞—Ä–Ω–∞—è –∫—Ä–∞—Å–∞–≤–∏—Ü–∞. –õ–∏—à–∞–µ—Ç –∏–≥—Ä–æ–∫–∞ —Ö–æ–¥–∞.\n"
        "‚Ä¢ üëî –ú–∏—Ä–Ω—ã–π –∂–∏—Ç–µ–ª—å ‚Äî –æ–±—ã—á–Ω—ã–µ –ª—é–¥–∏, —É –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å –ª–∏—à—å –≥–æ–ª–æ—Å –∏ –≤–µ—Ä–∞ –¥—Ä—É–≥ –≤ –¥—Ä—É–≥–∞.\n\n"
        "       üåô –ù–æ—á—å: –ì–æ—Ä–æ–¥ —Å–ø–∏—Ç. –ú–∞—Ñ–∏—è —É–±–∏–≤–∞–µ—Ç. –ö–æ–º–∏—Å—Å–∞—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç. –î–æ–∫—Ç–æ—Ä –ª–µ—á–∏—Ç. –ë–∞–±–æ—á–∫–∞ —Å–æ–±–ª–∞–∑–Ω—è–µ—Ç.\n"
        "       ‚òÄÔ∏è –î–µ–Ω—å: –ì–æ—Ä–æ–¥ –ø—Ä–æ—Å—ã–ø–∞–µ—Ç—Å—è. –í—Å–µ –æ–±—Å—É–∂–¥–∞—é—Ç –∏ –ø–æ–¥–æ–∑—Ä–µ–≤–∞—é—Ç –¥—Ä—É–≥ –¥—Ä—É–≥–∞.\n"
        "       ‚öñÔ∏è –ö–∞–∑–Ω—å: –ü–æ –∏—Ç–æ–≥–∞–º –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –æ–¥–∏–Ω –∏–≥—Ä–æ–∫ —É—Ö–æ–¥–∏—Ç –∏–∑ –∏–≥—Ä—ã.\n\n"
        "       üèÜ –ö–æ–Ω–µ—Ü –∏–≥—Ä—ã:\n"
        "‚Ä¢ –ï—Å–ª–∏ –º–∞—Ñ–∏—è —É–Ω–∏—á—Ç–æ–∂–∞–µ—Ç –≤—Å–µ—Ö –º–∏—Ä–Ω—ã—Ö ‚Äî –≥–æ—Ä–æ–¥ –≤–æ –≤–ª–∞—Å—Ç–∏ –ø—Ä–µ—Å—Ç—É–ø–Ω–∏–∫–æ–≤.\n"
        "‚Ä¢ –ï—Å–ª–∏ –º–∏—Ä–Ω—ã–µ –≤—ã—á–∏—Å–ª—è—é—Ç –≤—Å–µ—Ö –º–∞—Ñ–∏–æ–∑–∏ ‚Äî –≥–æ—Ä–æ–¥ —Å–Ω–æ–≤–∞ –¥—ã—à–∏—Ç —Å–≤–æ–±–æ–¥–æ–π.\n\n"
        "       üíº –í —ç—Ç–æ–º –≥–æ—Ä–æ–¥–µ –≤—ã–∂–∏–≤–∞–µ—Ç –Ω–µ —Å–∞–º—ã–π —á–µ—Å—Ç–Ω—ã–π, –∞ —Å–∞–º—ã–π —Ö–∏—Ç—Ä—ã–π."
    )

    await callback.message.answer(
        rules_text,
        reply_markup=get_back_keyboard()
    )
    await callback.answer()

@router.callback_query(F.data == "how_to_play")
async def show_how_to_play(callback: CallbackQuery):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –ø–æ –∏–≥—Ä–µ"""
    logger.debug(f"show_how_to_play: –ø–æ–∫–∞–∑ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è —á–∞—Ç–∞ {callback.message.chat.id}")
    
    how_to_play_text = (
        "‚ùì –ö–ê–ö –ò–ì–†–ê–¢–¨ ‚ùì\n\n"
        "1Ô∏è‚É£ –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è –∫ –∏–≥—Ä–µ ‚Äî –Ω–∞–∂–º–∏ ¬´‚ûï –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∏–≥—Ä–µ¬ª\n\n"
        "2Ô∏è‚É£ –î–æ–∂–¥–∏—Å—å –Ω–∞—á–∞–ª–∞ ‚Äî –∫–∞–∫ —Ç–æ–ª—å–∫–æ –Ω–∞–±–µ—Ä—ë—Ç—Å—è —Ö–æ—Ç—è –±—ã 4 –∏–≥—Ä–æ–∫–∞, –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –Ω–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É ¬´‚úÖ –ì–æ—Ç–æ–≤–æ¬ª\n\n"
        "3Ô∏è‚É£ –ü–æ–ª—É—á–∏ —Å–≤–æ—é —Ä–æ–ª—å ‚Äî —è —à–µ–ø–Ω—É –µ—ë —Ç–µ–±–µ –Ω–∞ —É—Ö–æ\n\n"
        "4Ô∏è‚É£ –ñ–∏–≤–∏ –ø–æ —Ñ–∞–∑–∞–º:\n"
        "   üåô –ù–æ—á—å ‚Äî –º–∞—Ñ–∏—è –≤—ã—Ö–æ–¥–∏—Ç –Ω–∞ —É–ª–∏—Ü—ã, –¥–æ–∫—Ç–æ—Ä —Å–ø–∞—Å–∞–µ—Ç, –∫–æ–º–∏—Å—Å–∞—Ä –∏—â–µ—Ç –ø—Ä–∞–≤–¥—É, –±–∞–±–æ—á–∫–∞ —Å–±–∏–≤–∞–µ—Ç —Å –ø—É—Ç–∏\n"
        "   ‚òÄÔ∏è –î–µ–Ω—å ‚Äî –≤–µ—Å—å –≥–æ—Ä–æ–¥ —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è, –∏–¥—ë—Ç –∂–∞—Ä–∫–æ–µ –æ–±—Å—É–∂–¥–µ–Ω–∏–µ –∏ –ø–æ–∏—Å–∫ –ø—Ä–µ–¥–∞—Ç–µ–ª–µ–π\n"
        "   üó≥Ô∏è –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ ‚Äî –∫–∞–∂–¥—ã–π –æ—Ç–¥–∞—ë—Ç —Å–≤–æ–π –≥–æ–ª–æ—Å –∑–∞ —Ç–æ–≥–æ, –∫—Ç–æ, –ø–æ –µ–≥–æ –º–Ω–µ–Ω–∏—é, –∑–∞–º–µ—à–∞–Ω –≤ –∫—Ä–æ–≤–∏\n\n"
        "5Ô∏è‚É£ –ü–æ–±–µ–¥–∞ –¥–æ—Å—Ç–∞–Ω–µ—Ç—Å—è —Ç–µ–º, –∫—Ç–æ –ø–µ—Ä–µ–∂–∏–≤—ë—Ç –≤—Ä–∞–≥–æ–≤ –∏ —Å—É–º–µ–µ—Ç –ø–µ—Ä–µ–∏–≥—Ä–∞—Ç—å –æ—Å—Ç–∞–ª—å–Ω—ã—Ö\n\n"
        "üí° –°–æ–≤–µ—Ç—ã –±—ã–≤–∞–ª—ã—Ö:\n"
        "‚Ä¢ –°–ª—É—à–∞–π, –∫—Ç–æ —á—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç ‚Äî –∏ –∫—Ç–æ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –º–æ–ª—á–∏—Ç\n"
        "‚Ä¢ –ó–∞–ø–æ–º–∏–Ω–∞–π, –∫—Ç–æ –≥–æ–ª–æ—Å—É–µ—Ç –ø—Ä–æ—Ç–∏–≤ –∫–æ–≥–æ\n"
        "‚Ä¢ –ù–µ —Å–ø–µ—à–∏ —Ä–∞—Å–∫—Ä—ã–≤–∞—Ç—å —Å–≤–æ—é –∫–∞—Ä—Ç—É, —ç—Ç–æ –º–æ–∂–µ—Ç —Å—Ç–æ–∏—Ç—å —Ç–µ–±–µ –∂–∏–∑–Ω–∏\n"
        "‚Ä¢ –î–æ–≤–µ—Ä—è–π, –Ω–æ –≤—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π ‚Äî –≤ —ç—Ç–æ–º –≥–æ—Ä–æ–¥–µ –∫–∞–∂–¥—ã–π –º–æ–∂–µ—Ç –æ–∫–∞–∑–∞—Ç—å—Å—è —Å –Ω–æ–∂–æ–º –∑–∞ —Å–ø–∏–Ω–æ–π"
    )
    
    await callback.message.answer(
        how_to_play_text,
        reply_markup=get_back_keyboard()
    )
    await callback.answer()

@router.callback_query(F.data == "start_game")
async def start_game_lobby(callback: CallbackQuery):
    """–ù–∞—á–∏–Ω–∞–µ—Ç –ª–æ–±–±–∏ –∏–≥—Ä—ã"""
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —Ä–∞–±–æ—Ç—É –≤ –¥–∞–Ω–Ω–æ–π —Ç–µ–º–µ
    if not check_topic_permission(callback.message):
        await callback.answer("‚ö†Ô∏è –î–µ–π—Å—Ç–≤–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ —Ç–æ–ª—å–∫–æ –≤ —Ç–µ–º–µ ¬´–ò–≥—Ä–∞ –≤ ¬´–ú–∞—Ñ–∏—é¬ª¬ª!", show_alert=True)
        return
    
    chat_id = callback.message.chat.id
    thread_id = callback.message.message_thread_id or 0
    chat_key = f"{chat_id}_{thread_id}"
    
    logger.info(f"start_game_lobby: —Å–æ–∑–¥–∞–Ω–∏–µ –ª–æ–±–±–∏ –¥–ª—è —á–∞—Ç–∞ {chat_key} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {callback.from_user.first_name} (@{callback.from_user.username})")
    
    # –°–æ–∑–¥–∞–µ–º –∏–≥—Ä—É, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
    game = game_manager.get_game(chat_key)
    if not game:
        logger.debug(f"start_game_lobby: –∏–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é")
        game = game_manager.create_game(chat_key)
        logger.info(f"start_game_lobby: —Å–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è –∏–≥—Ä–∞ –¥–ª—è —á–∞—Ç–∞ {chat_key}")
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–∑–¥–∞—Ç–µ–ª—è –ª–æ–±–±–∏ (–µ—Å–ª–∏ –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
    if not getattr(game, "lobby_creator_id", None):
        try:
            game.lobby_creator_id = callback.from_user.id
            logger.debug(f"start_game_lobby: —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Å–æ–∑–¥–∞—Ç–µ–ª—å –ª–æ–±–±–∏: {callback.from_user.id}")
        except Exception as e:
            logger.exception(f"start_game_lobby: –æ—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–æ–∑–¥–∞—Ç–µ–ª—è –ª–æ–±–±–∏: {e}")
    
        logger.debug(f"start_game_lobby: –ª–æ–±–±–∏ –∏–≥—Ä—ã –¥–ª—è —á–∞—Ç–∞ {chat_key}, –∏–≥—Ä–æ–∫–æ–≤: {len(game.players)}")
    
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤
    player_list = []
    for player in game.players.values():
        username = f"@{player.username}" if player.username else None
        display = f"{player.first_name}{f' ({username})' if username else ''}"
        player_list.append(f"‚Ä¢ {display}")
    
    player_names = "\n".join(player_list) if player_list else "–ü–æ–∫–∞ –Ω–∏–∫–æ–≥–æ"
    
    await callback.message.answer(
        "üé≤ –õ–û–ë–ë–ò –ò–ì–†–´ üé≤\n\n"
        f"üë• –ó–∞ —Å—Ç–æ–ª–æ–º —Å–æ–±—Ä–∞–ª–∏—Å—å: {len(game.players)}/{MAX_PLAYERS} —Å–∏–Ω—å–æ—Ä–æ–≤ –∏ —Å–∏–Ω—å–æ—Ä–∏—Ç\n"
        f"üìã –ò–≥—Ä–æ–∫–∏:\n{player_names}\n\n"
        "üìã –ú–∏–Ω–∏–º—É–º –¥–ª—è –Ω–∞—á–∞–ª–∞: 1 –∏–≥—Ä–æ–∫, –Ω–æ –¥–ª—è –Ω–∞—Å—Ç–æ—è—â–µ–π –∏–≥—Ä—ã –ª—É—á—à–µ –Ω–µ –º–µ–Ω—å—à–µ 4\n\n"
        "üíº –í —ç—Ç–æ–º –≥–æ—Ä–æ–¥–µ –∫–∞–∂–¥—ã–π —Å–∫—Ä—ã–≤–∞–µ—Ç —Å–≤–æ–∏ –Ω–∞–º–µ—Ä–µ–Ω–∏—è. –ù–æ—á—å—é –º–∞—Ñ–∏—è –±—É–¥–µ—Ç –æ—Ö–æ—Ç–∏—Ç—å—Å—è, "
        "–¥–æ–∫—Ç–æ—Ä —Å–ø–∞—Å–∞—Ç—å, –∫–æ–º–∏—Å—Å–∞—Ä –ø—Ä–æ–≤–µ—Ä—è—Ç—å, –∞ –Ω–æ—á–Ω–∞—è –±–∞–±–æ—á–∫–∞ –ø–ª–µ—Å—Ç–∏ –∏–Ω—Ç—Ä–∏–≥–∏.\n"
        "–¢–æ–ª—å–∫–æ —Å–∞–º—ã–µ —Ö–∏—Ç—Ä—ã–µ –ø–µ—Ä–µ–∂–∏–≤—É—Ç —Ä–∞—Å—Å–≤–µ—Ç.\n\n"
        "‚ö†Ô∏è –î–µ—Ä–∂–∏—Å—å —Ä—è–¥–æ–º —Å–æ —Å–≤–æ–∏–º–∏ —Å–æ—é–∑–Ω–∏–∫–∞–º–∏, –Ω–æ –¥–æ–≤–µ—Ä—è–π —Å –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å—é. "
        "–ö—Ç–æ –≥–æ—Ç–æ–≤ —Ä–∏—Å–∫–Ω—É—Ç—å –∏ —Å—ã–≥—Ä–∞—Ç—å ‚Äî –∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, –∏ –ø—É—Å—Ç—å –Ω–∞—á–Ω—ë—Ç—Å—è –∏–≥—Ä–∞...",
        reply_markup=get_lobby_keyboard()
    )
    await callback.answer()

@router.callback_query(F.data == "join_game")
async def join_game(callback: CallbackQuery):
    """–ò–≥—Ä–æ–∫ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ—Ç—Å—è –∫ –∏–≥—Ä–µ"""
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —Ä–∞–±–æ—Ç—É –≤ –¥–∞–Ω–Ω–æ–π —Ç–µ–º–µ
    if not check_topic_permission(callback.message):
        await callback.answer("‚ö†Ô∏è –î–µ–π—Å—Ç–≤–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ —Ç–æ–ª—å–∫–æ –≤ —Ç–µ–º–µ ¬´–ò–≥—Ä–∞ –≤ ¬´–ú–∞—Ñ–∏—é¬ª¬ª!", show_alert=True)
        return
    
    chat_id = callback.message.chat.id
    thread_id = callback.message.message_thread_id or 0
    chat_key = f"{chat_id}_{thread_id}"
    user_id = callback.from_user.id
    username = callback.from_user.username or "Unknown"
    first_name = callback.from_user.first_name or "Unknown"
    
    logger.info(f"join_game: –∏–≥—Ä–æ–∫ {first_name} (@{callback.from_user.username}) –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ—Ç—Å—è –∫ –∏–≥—Ä–µ –≤ —á–∞—Ç–µ {chat_key}")
    
    if game_manager.add_player(chat_key, user_id, username, first_name):
        logger.info(f"join_game: –∏–≥—Ä–æ–∫ {first_name} —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ –∏–≥—Ä–µ –≤ —á–∞—Ç–µ {chat_key}")
        game = game_manager.get_game(chat_key)
        
        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ª–æ–±–±–∏
        try:
            await callback.message.delete()
            logger.debug(f"join_game: —É–¥–∞–ª–µ–Ω–æ —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ª–æ–±–±–∏")
        except TelegramBadRequest as e:
            logger.debug(f"join_game: –Ω–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ª–æ–±–±–∏: {e}")
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤
        player_list = []
        for player in game.players.values():
            username = f"@{player.username}" if player.username else None
            display = f"{player.first_name}{f' ({username})' if username else ''}"
            player_list.append(f"‚Ä¢ {display}")
        
        player_names = "\n".join(player_list) if player_list else "–ü–æ–∫–∞ –Ω–∏–∫–æ–≥–æ"
        
        # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ª–æ–±–±–∏ —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–º —Å–ø–∏—Å–∫–æ–º
        await callback.message.answer(
            f"‚úÖ {first_name} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ –∏–≥—Ä–µ!\n\n"
            f"üë• –ò–≥—Ä–æ–∫–æ–≤: {len(game.players)}/{MAX_PLAYERS}\n"
            f"üìã –ò–≥—Ä–æ–∫–∏:\n{player_names}\n\n"
            "üìã –ú–∏–Ω–∏–º—É–º –¥–ª—è –Ω–∞—á–∞–ª–∞: 1 –∏–≥—Ä–æ–∫\n"
            "üí° –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è: –º–∏–Ω–∏–º—É–º 4 –∏–≥—Ä–æ–∫–∞",
            reply_markup=get_lobby_keyboard()
        )
    else:
        logger.warning(f"join_game: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å –∏–≥—Ä–æ–∫–∞ {first_name} –∫ –∏–≥—Ä–µ –≤ —á–∞—Ç–µ {chat_key}")
        await callback.answer("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∏–≥—Ä–µ!", show_alert=True)
    
    await callback.answer()

@router.callback_query(F.data == "leave_game")
async def leave_game(callback: CallbackQuery):
    """–ò–≥—Ä–æ–∫ –≤—ã—Ö–æ–¥–∏—Ç –∏–∑ –ª–æ–±–±–∏"""
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —Ä–∞–±–æ—Ç—É –≤ –¥–∞–Ω–Ω–æ–π —Ç–µ–º–µ
    if not check_topic_permission(callback.message):
        await callback.answer("‚ö†Ô∏è –î–µ–π—Å—Ç–≤–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ —Ç–æ–ª—å–∫–æ –≤ —Ç–µ–º–µ ¬´–ò–≥—Ä–∞ –≤ ¬´–ú–∞—Ñ–∏—é¬ª¬ª!", show_alert=True)
        return
    
    chat_id = callback.message.chat.id
    thread_id = callback.message.message_thread_id or 0
    chat_key = f"{chat_id}_{thread_id}"
    user_id = callback.from_user.id
    first_name = callback.from_user.first_name or "Unknown"
    
    logger.info(f"leave_game: –∏–≥—Ä–æ–∫ {first_name} –≤—ã—Ö–æ–¥–∏—Ç –∏–∑ –∏–≥—Ä—ã –≤ —á–∞—Ç–µ {chat_key}")
    
    if game_manager.remove_player(chat_key, user_id):
        game = game_manager.get_game(chat_key)
        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ª–æ–±–±–∏
        try:
            await callback.message.delete()
            logger.debug("leave_game: —É–¥–∞–ª–µ–Ω–æ —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ª–æ–±–±–∏")
        except TelegramBadRequest as e:
            logger.debug(f"leave_game: –Ω–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ª–æ–±–±–∏: {e}")
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤
        player_list = []
        for player in game.players.values():
            username = f"@{player.username}" if player.username else None
            display = f"{player.first_name}{f' ({username})' if username else ''}"
            player_list.append(f"‚Ä¢ {display}")
        player_names = "\n".join(player_list) if player_list else "–ü–æ–∫–∞ –Ω–∏–∫–æ–≥–æ"
        
        await callback.message.answer(
            f"üö™ {first_name} –≤—ã—à–µ–ª –∏–∑ –∏–≥—Ä—ã.\n\n"
            f"üë• –ò–≥—Ä–æ–∫–æ–≤: {len(game.players)}/{MAX_PLAYERS}\n"
            f"üìã –ò–≥—Ä–æ–∫–∏:\n{player_names}",
            reply_markup=get_lobby_keyboard()
        )
    else:
        logger.warning(f"leave_game: –Ω–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∏–≥—Ä–æ–∫–∞ {first_name} –∏–∑ –∏–≥—Ä—ã –≤ —á–∞—Ç–µ {chat_key}")
        await callback.answer("–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–π—Ç–∏ –∏–∑ –∏–≥—Ä—ã!", show_alert=True)
    
    await callback.answer()

@router.callback_query(F.data == "ready_to_start")
async def ready_to_start(callback: CallbackQuery):
    """–ê–¥–º–∏–Ω –≥–æ—Ç–æ–≤ –Ω–∞—á–∞—Ç—å –∏–≥—Ä—É"""
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —Ä–∞–±–æ—Ç—É –≤ –¥–∞–Ω–Ω–æ–π —Ç–µ–º–µ
    if not check_topic_permission(callback.message):
        await callback.answer("‚ö†Ô∏è –î–µ–π—Å—Ç–≤–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ —Ç–æ–ª—å–∫–æ –≤ —Ç–µ–º–µ ¬´–ò–≥—Ä–∞ –≤ ¬´–ú–∞—Ñ–∏—é¬ª¬ª!", show_alert=True)
        return
    
    chat_key = get_chat_key(callback.message)
    
    logger.debug(
        f"ready_to_start –≤—ã–∑–≤–∞–Ω –¥–ª—è —á–∞—Ç–∞ {chat_key} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º: "
        f"{callback.from_user.first_name} (@{callback.from_user.username}) id={callback.from_user.id}"
    )
    
    if not game_manager.can_start_game(chat_key):
        logger.warning("ready_to_start: –∏–≥—Ä–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∞—á–∞—Ç–∞")
        await callback.answer("–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å –∏–≥—Ä—É! –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã 1 –∏–≥—Ä–æ–∫.", show_alert=True)
        return
    
    # –†–∞–∑—Ä–µ—à–∞–µ–º –ª—é–±–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –Ω–∞–∂–∏–º–∞—Ç—å –∫–Ω–æ–ø–∫—É —Å—Ç–∞—Ä—Ç–∞
    game = game_manager.get_game(chat_key)
    
    # –õ–æ–≥–∏—Ä—É–µ–º, –∫—Ç–æ –Ω–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É —Å—Ç–∞—Ä—Ç–∞
    user_info = f"{callback.from_user.first_name} (@{callback.from_user.username}) id={callback.from_user.id}"
    logger.info(f"ready_to_start: –∫–Ω–æ–ø–∫–∞ —Å—Ç–∞—Ä—Ç–∞ –Ω–∞–∂–∞—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {user_info} –≤ —á–∞—Ç–µ {chat_key}")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ü–µ–ª–µ–π
    is_creator = getattr(game, "lobby_creator_id", None) == callback.from_user.id if game else False
    is_admin = False
    try:
        member = await callback.message.bot.get_chat_member(callback.message.chat.id, callback.from_user.id)
        is_admin = member.status in {"administrator", "creator"}
        logger.debug(f"ready_to_start: —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - {member.status}, is_admin: {is_admin}, is_creator: {is_creator}")
    except TelegramBadRequest as e:
        logger.debug(f"ready_to_start: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}")
    
    logger.info(f"ready_to_start: –∑–∞–ø—É—Å–∫–∞–µ–º –∏–≥—Ä—É, –Ω–∞–∂–∞–ª: {user_info}")
    
    if game_manager.start_game(chat_key):
        logger.info(f"ready_to_start: –∏–≥—Ä–∞ —É—Å–ø–µ—à–Ω–æ –Ω–∞—á–∞—Ç–∞ –≤ —á–∞—Ç–µ {chat_key} —Å {len(game.players)} –∏–≥—Ä–æ–∫–∞–º–∏")
        game = game_manager.get_game(chat_key)
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
        # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –∏–≥—Ä—ã
        game_start_message = random.choice(GAME_START_MESSAGES)
        full_game_start_message = (
            game_start_message + "\n\n"
            "üìã –°–µ–≥–æ–¥–Ω—è –∑–∞ —ç—Ç–∏–º —Å—Ç–æ–ª–æ–º:\n" +
            "\n".join([
                f"‚Ä¢ {p.first_name}{f' (@{p.username})' if p.username else ''}"
                for p in game.players.values()
            ]) +
            "\n\nüåô –ù–æ—á—å—é:\n"
            "‚Ä¢ –ú–∞—Ñ–∏—è —Ä–µ—à–∞–µ—Ç, —á—å—é –∂–∏–∑–Ω—å –æ–±–æ—Ä–≤—ë—Ç—Å—è\n"
            "‚Ä¢ –î–æ–∫—Ç–æ—Ä –ø—ã—Ç–∞–µ—Ç—Å—è —Å–ø–∞—Å—Ç–∏ –∫–æ–≥–æ-—Ç–æ –æ—Ç —Å–º–µ—Ä—Ç–∏\n"
            "‚Ä¢ –ö–æ–º–∏—Å—Å–∞—Ä —Ç–∞–π–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –æ–¥–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –ø—Ä–µ–¥–∞—Ç–µ–ª—è\n"
            "‚Ä¢ –ù–æ—á–Ω–∞—è –±–∞–±–æ—á–∫–∞ —Å–ø—É—Ç—ã–≤–∞–µ—Ç –ø–ª–∞–Ω—ã –∏ –ª–∏—à–∞–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞ —Ö–æ–¥–∞\n\n"
            "‚òÄÔ∏è –î–Ω—ë–º –≥–æ—Ä–æ–¥ –ø—Ä–æ—Å–Ω—ë—Ç—Å—è –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏–π –∏ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –∑–∞ –∫–∞–∑–Ω—å. –ü–æ–º–Ω–∏—Ç–µ: –¥–æ–≤–µ—Ä–∏–µ –∑–¥–µ—Å—å ‚Äî —Ä–æ—Å–∫–æ—à—å, –∞ –æ—à–∏–±–∫–∞ —Å—Ç–æ–∏—Ç –∂–∏–∑–Ω–∏."
        )
        await callback.message.answer(full_game_start_message)

        
        # –†–∞–∑–¥–∞–µ–º —Ä–æ–ª–∏ –≤ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π)
        not_started_dm = []
        players_to_remove = []  # –°–ø–∏—Å–æ–∫ ID –∏–≥—Ä–æ–∫–æ–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
        logger.info(f"ready_to_start: –Ω–∞—á–∏–Ω–∞–µ–º —Ä–∞–∑–¥–∞—á—É —Ä–æ–ª–µ–π –¥–ª—è {len(game.players)} –∏–≥—Ä–æ–∫–æ–≤")
        for player in game.players.values():
            try:
                role_emoji = {
                    PlayerRole.MAFIA: "üòà",
                    PlayerRole.CIVILIAN: "üïäÔ∏è",
                    PlayerRole.DOCTOR: "üíâ",
                    PlayerRole.COMMISSIONER: "üëÆ",
                    PlayerRole.BUTTERFLY: "üíÉ"
                }.get(player.role, "‚ùì")
                
                role_name = {
                    PlayerRole.MAFIA: "–ú–∞—Ñ–∏—è",
                    PlayerRole.CIVILIAN: "–ú–∏—Ä–Ω—ã–π –∂–∏—Ç–µ–ª—å",
                    PlayerRole.DOCTOR: "–î–æ–∫—Ç–æ—Ä",
                    PlayerRole.COMMISSIONER: "–ö–æ–º–∏—Å—Å–∞—Ä",
                    PlayerRole.BUTTERFLY: "–ù–æ—á–Ω–∞—è –±–∞–±–æ—á–∫–∞"
                }.get(player.role, "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —Ä–æ–ª—å")
                
                role_description = INSTRUCTIONS_BY_ROLE.get(player.role, "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —Ä–æ–ª—å")

                # –ì–æ—Ç–æ–≤–∏–º –æ–¥–∏–Ω —Ç–µ–∫—Å—Ç —Ä–æ–ª–∏ –∏ –≤ —Ç–æ–º –∂–µ —Å–æ–æ–±—â–µ–Ω–∏–∏ –ø—Ä–∏–∫–ª–∞–¥—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
                base_text = (
                    f"üé≠ –¢–≤–æ—è —Ä–æ–ª—å ‚Äî {role_emoji} {role_name}\n\n"
                    f"{role_description}"
                )
                if not getattr(player, "role_info_sent", False):
                    if player.role == PlayerRole.MAFIA:
                        await callback.bot.send_message(
                            player.user_id,
                            base_text + "\n\nüòà –í—ã–±–µ—Ä–∏—Ç–µ –∂–µ—Ä—Ç–≤—É:",
                            reply_markup=get_player_selection_keyboard(list(game.players.values()), "mafia_kill", chat_key)
                        )
                        # –°—Ä–∞–∑—É –ø–æ—Å–ª–µ —Ä–∞–∑–¥–∞—á–∏ —Ä–æ–ª–µ–π —Å–æ–æ–±—â–∏–º –º–∞—Ñ–∏–∏ –æ —Å–æ–æ–±—â–Ω–∏–∫–∞—Ö
                        try:
                            peers = game_manager.get_mafia_peers(chat_key, exclude_user_id=player.user_id)
                            if peers:
                                mafia_list = ", ".join([f"@{p.username}" if p.username else p.first_name for p in peers])
                                await callback.bot.send_message(
                                    player.user_id,
                                    f"ü§´ –¢–≤–æ–∏ —Å–æ–æ–±—â–Ω–∏–∫–∏: {mafia_list}. –ú–æ–∂–µ—Ç–µ –æ–±—Å—É–∂–¥–∞—Ç—å –ø—Ä—è–º–æ –∑–¥–µ—Å—å –≤ –õ–° ‚Äî —è –ø–µ—Ä–µ–¥–∞–º –∏–º —Ç–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è."
                                )
                        except Exception as e:
                            logger.exception(f"–Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–Ω–∏–∫–æ–≤ –º–∞—Ñ–∏–∏ –∏–≥—Ä–æ–∫—É {player.user_id}: {e}")
                    elif player.role == PlayerRole.DOCTOR:
                        await callback.bot.send_message(
                            player.user_id,
                            base_text + "\n\nüíâ –í—ã–±–µ—Ä–∏—Ç–µ, –∫–æ–≥–æ –ª–µ—á–∏—Ç—å:",
                            reply_markup=get_player_selection_keyboard(list(game.players.values()), "doctor_save", chat_key)
                        )
                    elif player.role == PlayerRole.COMMISSIONER:
                        await callback.bot.send_message(
                            player.user_id,
                            base_text + "\n\nüëÆ –í—ã–±–µ—Ä–∏—Ç–µ, –∫–æ–≥–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:",
                            reply_markup=get_player_selection_keyboard(list(game.players.values()), "commissioner_check", chat_key)
                        )
                    elif player.role == PlayerRole.BUTTERFLY:
                        await callback.bot.send_message(
                            player.user_id,
                            base_text + "\n\nüíÉ –í—ã–±–µ—Ä–∏—Ç–µ, –∫–æ–≥–æ –æ—Ç–≤–ª–µ—á—å:",
                            reply_markup=get_player_selection_keyboard(list(game.players.values()), "butterfly_distract", chat_key)
                        )
                    else:
                        # –ú–∏—Ä–Ω–æ–º—É –ø—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–æ–ª—å –±–µ–∑ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
                        await callback.bot.send_message(player.user_id, base_text)
                    player.role_info_sent = True
                
            except TelegramForbiddenError as e:
                # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞—á–∞–ª –¥–∏–∞–ª–æ–≥ —Å –±–æ—Ç–æ–º
                uname = f"@{player.username}" if player.username else None
                disp = f"{player.first_name}{f' ({uname})' if uname else ''}"
                not_started_dm.append(disp)
                players_to_remove.append(player.user_id)  # –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–ø–∏—Å–æ–∫ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
                logger.warning(f"–†–æ–ª—å –Ω–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –∏–≥—Ä–æ–∫—É {player.user_id} (–Ω–µ—Ç /start): {e}")
            except Exception as e:
                logger.exception(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–æ–ª–∏ –∏–≥—Ä–æ–∫—É {player.user_id}: {e}")

        # –£–¥–∞–ª—è–µ–º –∏–≥—Ä–æ–∫–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –Ω–∞—á–∞–ª–∏ –¥–∏–∞–ª–æ–≥ —Å –±–æ—Ç–æ–º
        if players_to_remove:
            game_manager.remove_players_without_start(chat_key, players_to_remove)
            logger.info(f"ready_to_start: —É–¥–∞–ª–µ–Ω–æ {len(players_to_remove)} –∏–≥—Ä–æ–∫–æ–≤ –±–µ–∑ /start –∏–∑ –∏–≥—Ä—ã")

        # –ú—ã —É–∂–µ —Ä–∞–∑–æ—Å–ª–∞–ª–∏ –Ω–æ—á–Ω—ã–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –≤ —Å–æ—Å—Ç–∞–≤–µ –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è ‚Äî
        # –Ω–µ –¥–∞—ë–º –∞–≤—Ç–æ–ø–∏–ª–æ—Ç—É –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∏—Ö –ø–æ–≤—Ç–æ—Ä–Ω–æ –≤ —ç—Ç—É –Ω–æ—á—å
        try:
            game.night_prompts_sent = True
        except Exception:
            pass
        
        logger.info(f"ready_to_start: —Ä–∞–∑–¥–∞—á–∞ —Ä–æ–ª–µ–π –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –∑–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–ø–∏–ª–æ—Ç –¥–ª—è —á–∞—Ç–∞ {chat_key}")
        
        # –°–æ–æ–±—â–∏–º –≤ –æ–±—â–∏–π —á–∞—Ç, –∫—Ç–æ –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª –õ–° —Å –±–æ—Ç–æ–º
        if not_started_dm:
            # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –õ–°
            no_dm_message = random.choice(NO_DM_MESSAGES)
            players_list = "\n".join([f"‚Ä¢ {name}" for name in not_started_dm])
            full_message = no_dm_message.format(players=players_list) + "\n\n–û–Ω–∏ –±—ã–ª–∏ —É–¥–∞–ª–µ–Ω—ã –∏–∑ –∏–≥—Ä—ã. –ù–∞–ø–∏—à–∏—Ç–µ –±–æ—Ç—É –≤ –õ–° –∫–æ–º–∞–Ω–¥—É /start, —á—Ç–æ–±—ã —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ —Å–ª–µ–¥—É—é—â–∏—Ö –∏–≥—Ä–∞—Ö."
            await callback.message.answer(full_message)
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–ø–∏–ª–æ—Ç —Ü–∏–∫–ª–∞ —Ñ–∞–∑
        if _autopilot_tasks.get(chat_key) and not _autopilot_tasks[chat_key].done():
            _autopilot_tasks[chat_key].cancel()
        _autopilot_tasks[chat_key] = asyncio.create_task(_autopilot_loop(chat_key, callback.bot))
        logger.info(f"ready_to_start: –∞–≤—Ç–æ–ø–∏–ª–æ—Ç –∑–∞–ø—É—â–µ–Ω –¥–ª—è —á–∞—Ç–∞ {chat_key}")
    else:
        logger.warning("ready_to_start: start_game –≤–µ—Ä–Ω—É–ª False")
        await callback.answer("–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å –∏–≥—Ä—É!", show_alert=True)
    
    await callback.answer()

@router.callback_query(F.data == "cancel_game")
async def cancel_game(callback: CallbackQuery):
    """–û—Ç–º–µ–Ω—è–µ—Ç –∏–≥—Ä—É"""
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —Ä–∞–±–æ—Ç—É –≤ –¥–∞–Ω–Ω–æ–π —Ç–µ–º–µ
    if not check_topic_permission(callback.message):
        await callback.answer("‚ö†Ô∏è –î–µ–π—Å—Ç–≤–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ —Ç–æ–ª—å–∫–æ –≤ —Ç–µ–º–µ ¬´–ò–≥—Ä–∞ –≤ ¬´–ú–∞—Ñ–∏—é¬ª¬ª!", show_alert=True)
        return
    
    chat_key = get_chat_key(callback.message)
    
    logger.debug(
        f"cancel_game –≤—ã–∑–≤–∞–Ω –¥–ª—è —á–∞—Ç–∞ {chat_key} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º: "
        f"{callback.from_user.first_name} (@{callback.from_user.username}) id={callback.from_user.id}"
    )
    
    # –õ–æ–≥–∏—Ä—É–µ–º, –∫—Ç–æ –Ω–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É –æ—Ç–º–µ–Ω—ã
    user_info = f"{callback.from_user.first_name} (@{callback.from_user.username}) id={callback.from_user.id}"
    logger.info(f"cancel_game: –∫–Ω–æ–ø–∫–∞ –æ—Ç–º–µ–Ω—ã –Ω–∞–∂–∞—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {user_info} –≤ —á–∞—Ç–µ {chat_key}")
    
    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤—Ç–æ–ø–∏–ª–æ—Ç –µ—Å–ª–∏ –µ—Å—Ç—å
    if _autopilot_tasks.get(chat_key) and not _autopilot_tasks[chat_key].done():
        _autopilot_tasks[chat_key].cancel()
        del _autopilot_tasks[chat_key]
    
    # –ó–∞–≤–µ—Ä—à–∞–µ–º –∏–≥—Ä—É
    game_manager.end_game(chat_key)
    
    await callback.message.answer(
        "‚ùå –ò–≥—Ä–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.\n\n"
        "–í—Å–µ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã. –ú–æ–∂–µ—Ç–µ –Ω–∞—á–∞—Ç—å –Ω–æ–≤—É—é –∏–≥—Ä—É.",
        reply_markup=get_new_game_keyboard()
    )
    
    logger.info(f"cancel_game: –∏–≥—Ä–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞ –≤ —á–∞—Ç–µ {chat_key} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {user_info}")
    await callback.answer()

@router.callback_query(F.data.startswith("mafia_kill:"))
async def mafia_kill_action(callback: CallbackQuery):
    """–ú–∞—Ñ–∏—è –≤—ã–±–∏—Ä–∞–µ—Ç –∂–µ—Ä—Ç–≤—É"""
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —Ä–∞–±–æ—Ç—É –≤ –¥–∞–Ω–Ω–æ–π —Ç–µ–º–µ (–¥–ª—è –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ø—Ä–æ–ø—É—Å–∫–∞–µ–º)
    if callback.message.chat.type != "private" and not check_topic_permission(callback.message):
        await callback.answer("‚ö†Ô∏è –î–µ–π—Å—Ç–≤–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ —Ç–æ–ª—å–∫–æ –≤ —Ç–µ–º–µ ¬´–ò–≥—Ä–∞ –≤ ¬´–ú–∞—Ñ–∏—é¬ª¬ª!", show_alert=True)
        return
    
    user_id = callback.from_user.id
    parts = callback.data.split(":")
    group_chat_key = parts[1]  # –¢–µ–ø–µ—Ä—å —ç—Ç–æ chat_key, –∞ –Ω–µ chat_id
    target_id = int(parts[2])
    logger.debug(f"mafia_kill_action: —á–∞—Ç {group_chat_key}, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id}, —Ü–µ–ª—å {target_id}")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏–≥—Ä–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –≤ –Ω–æ—á–Ω–æ–π —Ñ–∞–∑–µ
    game = game_manager.get_game(group_chat_key)
    if not game:
        await callback.answer("‚ùå –ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!", show_alert=True)
        return
    
    if game.phase != GamePhase.NIGHT:
        await callback.answer("‚ùå –°–µ–π—á–∞—Å –Ω–µ –Ω–æ—á—å!", show_alert=True)
        return
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏–≥—Ä–æ–∫ –∂–∏–≤ –∏ –∏–º–µ–µ—Ç —Ä–æ–ª—å –º–∞—Ñ–∏–∏
    player = game.players.get(user_id)
    if not player or not player.is_alive:
        await callback.answer("‚ùå –í—ã –º–µ—Ä—Ç–≤—ã –∏–ª–∏ –Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç–µ –≤ –∏–≥—Ä–µ!", show_alert=True)
        return
    
    if player.role != PlayerRole.MAFIA:
        await callback.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç —Ä–æ–ª–∏ –º–∞—Ñ–∏–∏!", show_alert=True)
        return
    
    # –ë–ª–æ–∫–∏—Ä—É–µ–º –¥–µ–π—Å—Ç–≤–∏–µ, –µ—Å–ª–∏ –∏–≥—Ä–æ–∫ –æ—Ç–≤–ª–µ—á–µ–Ω –±–∞–±–æ—á–∫–æ–π
    if game.butterfly_distract_target is not None and user_id == game.butterfly_distract_target:
        await callback.answer("–í—ã –æ—Ç–≤–ª–µ—á–µ–Ω—ã –Ω–æ—á–Ω–æ–π –±–∞–±–æ—á–∫–æ–π –∏ –Ω–µ –º–æ–∂–µ—Ç–µ –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å —ç—Ç–æ–π –Ω–æ—á—å—é.", show_alert=True)
        return
        
    if game_manager.process_night_action(group_chat_key, user_id, "mafia_kill", target_id):
        target = game_manager.get_game(group_chat_key).players.get(target_id)
        target_mention = f"@{target.username}" if target and target.username else (target.first_name if target else "–∏–≥—Ä–æ–∫")
        await callback.bot.send_message(user_id, f"‚úÖ –ñ–µ—Ä—Ç–≤–∞ –≤—ã–±—Ä–∞–Ω–∞: {target_mention}")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≤–µ—Ä—à–µ–Ω—ã –ª–∏ –≤—Å–µ –Ω–æ—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è (–æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑)
        game = game_manager.get_game(group_chat_key)
        if game and game_manager.all_night_actions_completed(group_chat_key) and not game.all_actions_notified:
            game.all_actions_notified = True
            await callback.bot.send_message(
                get_chat_id_from_key(group_chat_key),
                "üåô –í—Å–µ –Ω–æ—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—É—á–µ–Ω—ã. –ù–æ—á—å –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –¥–æ —Ä–∞—Å—Å–≤–µ—Ç–∞.",
                message_thread_id=get_thread_id_from_key(group_chat_key)
            )
    else:
        logger.warning("process_night_action –≤–µ—Ä–Ω—É–ª False –¥–ª—è –º–∞—Ñ–∏–∏")
        await callback.answer("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∏–≥—Ä–∞ –≤ –Ω–æ—á–Ω–æ–π —Ñ–∞–∑–µ –∏ –≤—ã –∂–∏–≤—ã.", show_alert=True)
    
    await callback.answer()

@router.callback_query(F.data.startswith("doctor_save:"))
async def doctor_save_action(callback: CallbackQuery):
    """–î–æ–∫—Ç–æ—Ä –≤—ã–±–∏—Ä–∞–µ—Ç, –∫–æ–≥–æ –ª–µ—á–∏—Ç—å"""
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —Ä–∞–±–æ—Ç—É –≤ –¥–∞–Ω–Ω–æ–π —Ç–µ–º–µ (–¥–ª—è –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ø—Ä–æ–ø—É—Å–∫–∞–µ–º)
    if callback.message.chat.type != "private" and not check_topic_permission(callback.message):
        await callback.answer("‚ö†Ô∏è –î–µ–π—Å—Ç–≤–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ —Ç–æ–ª—å–∫–æ –≤ —Ç–µ–º–µ ¬´–ò–≥—Ä–∞ –≤ ¬´–ú–∞—Ñ–∏—é¬ª¬ª!", show_alert=True)
        return
    
    user_id = callback.from_user.id
    logger.debug(f"doctor_save_action: callback.data: {callback.data}")
    parts = callback.data.split(":")
    group_chat_key = parts[1]
    target_id = None if parts[2] == "skip" else int(parts[2])
    logger.debug(f"doctor_save_action: process_night_action params: chat_key={group_chat_key}, user_id={user_id}, action_type='doctor_save', target_id={target_id}")

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏–≥—Ä–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –≤ –Ω–æ—á–Ω–æ–π —Ñ–∞–∑–µ
    game = game_manager.get_game(group_chat_key)
    if not game:
        await callback.answer("‚ùå –ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!", show_alert=True)
        return
    
    if game.phase != GamePhase.NIGHT:
        await callback.answer("‚ùå –°–µ–π—á–∞—Å –Ω–µ –Ω–æ—á—å!", show_alert=True)
        return
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏–≥—Ä–æ–∫ –∂–∏–≤ –∏ –∏–º–µ–µ—Ç —Ä–æ–ª—å –¥–æ–∫—Ç–æ—Ä–∞
    player = game.players.get(user_id)
    if not player or not player.is_alive:
        await callback.answer("‚ùå –í—ã –º–µ—Ä—Ç–≤—ã –∏–ª–∏ –Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç–µ –≤ –∏–≥—Ä–µ!", show_alert=True)
        return
    
    if player.role != PlayerRole.DOCTOR:
        await callback.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç —Ä–æ–ª–∏ –¥–æ–∫—Ç–æ—Ä–∞!", show_alert=True)
        return
    
    if game.butterfly_distract_target is not None and user_id == game.butterfly_distract_target:
        await callback.answer("–í—ã –æ—Ç–≤–ª–µ—á–µ–Ω—ã –Ω–æ—á–Ω–æ–π –±–∞–±–æ—á–∫–æ–π –∏ –Ω–µ –º–æ–∂–µ—Ç–µ –ª–µ—á–∏—Ç—å —ç—Ç–æ–π –Ω–æ—á—å—é.", show_alert=True)
        return
        
    if game_manager.process_night_action(group_chat_key, user_id, "doctor_save", target_id):
        if target_id:
            target_player = game_manager.get_game(group_chat_key).players.get(target_id)
            mention = f"@{target_player.username}" if target_player and target_player.username else (target_player.first_name if target_player else "–∏–≥—Ä–æ–∫")
            await callback.bot.send_message(user_id, f"‚úÖ –í—ã —Ä–µ—à–∏–ª–∏ –ª–µ—á–∏—Ç—å {mention}! –í–æ–∑–º–æ–∂–Ω–æ, –≤—ã —Å–ø–∞—Å—ë—Ç–µ –µ–≥–æ –æ—Ç —Å–º–µ—Ä—Ç–∏.")
        else:
            await callback.bot.send_message(user_id, "‚úÖ –í—ã —Ä–µ—à–∏–ª–∏ –Ω–∏–∫–æ–≥–æ –Ω–µ –ª–µ—á–∏—Ç—å!")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≤–µ—Ä—à–µ–Ω—ã –ª–∏ –≤—Å–µ –Ω–æ—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è (–æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑)
        game = game_manager.get_game(group_chat_key)
        if game and game_manager.all_night_actions_completed(group_chat_key) and not game.all_actions_notified:
            game.all_actions_notified = True
            await callback.bot.send_message(
                get_chat_id_from_key(group_chat_key),
                "üåô –í—Å–µ –Ω–æ—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—É—á–µ–Ω—ã. –ù–æ—á—å –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –¥–æ —Ä–∞—Å—Å–≤–µ—Ç–∞.",
                message_thread_id=get_thread_id_from_key(group_chat_key)
            )
    else:
        logger.warning("process_night_action –≤–µ—Ä–Ω—É–ª False –¥–ª—è –¥–æ–∫—Ç–æ—Ä–∞")
        await callback.answer("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∏–≥—Ä–∞ –≤ –Ω–æ—á–Ω–æ–π —Ñ–∞–∑–µ –∏ –≤—ã –∂–∏–≤—ã.", show_alert=True)
    
    await callback.answer()

@router.callback_query(F.data.startswith("commissioner_check:"))
async def commissioner_check_action(callback: CallbackQuery):
    """–ö–æ–º–∏—Å—Å–∞—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∏–≥—Ä–æ–∫–∞"""
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —Ä–∞–±–æ—Ç—É –≤ –¥–∞–Ω–Ω–æ–π —Ç–µ–º–µ (–¥–ª—è –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ø—Ä–æ–ø—É—Å–∫–∞–µ–º)
    if callback.message.chat.type != "private" and not check_topic_permission(callback.message):
        await callback.answer("‚ö†Ô∏è –î–µ–π—Å—Ç–≤–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ —Ç–æ–ª—å–∫–æ –≤ —Ç–µ–º–µ ¬´–ò–≥—Ä–∞ –≤ ¬´–ú–∞—Ñ–∏—é¬ª¬ª!", show_alert=True)
        return
    
    user_id = callback.from_user.id
    parts = callback.data.split(":")
    group_chat_key = parts[1]
    target_id = int(parts[2])
    logger.debug(f"commissioner_check_action: —á–∞—Ç {group_chat_key}, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id}, —Ü–µ–ª—å {target_id}")

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏–≥—Ä–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –≤ –Ω–æ—á–Ω–æ–π —Ñ–∞–∑–µ
    game = game_manager.get_game(group_chat_key)
    if not game:
        await callback.answer("‚ùå –ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!", show_alert=True)
        return
    
    if game.phase != GamePhase.NIGHT:
        await callback.answer("‚ùå –°–µ–π—á–∞—Å –Ω–µ –Ω–æ—á—å!", show_alert=True)
        return
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏–≥—Ä–æ–∫ –∂–∏–≤ –∏ –∏–º–µ–µ—Ç —Ä–æ–ª—å –∫–æ–º–∏—Å—Å–∞—Ä–∞
    player = game.players.get(user_id)
    if not player or not player.is_alive:
        await callback.answer("‚ùå –í—ã –º–µ—Ä—Ç–≤—ã –∏–ª–∏ –Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç–µ –≤ –∏–≥—Ä–µ!", show_alert=True)
        return
    
    if player.role != PlayerRole.COMMISSIONER:
        await callback.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç —Ä–æ–ª–∏ –∫–æ–º–∏—Å—Å–∞—Ä–∞!", show_alert=True)
        return
    
    if game.butterfly_distract_target is not None and user_id == game.butterfly_distract_target:
        await callback.answer("–í—ã –æ—Ç–≤–ª–µ—á–µ–Ω—ã –Ω–æ—á–Ω–æ–π –±–∞–±–æ—á–∫–æ–π –∏ –Ω–µ –º–æ–∂–µ—Ç–µ –ø—Ä–æ–≤–µ—Ä—è—Ç—å —ç—Ç–æ–π –Ω–æ—á—å—é.", show_alert=True)
        return
        
    if game_manager.process_night_action(group_chat_key, user_id, "commissioner_check", target_id):
        game = game_manager.get_game(group_chat_key)
        target_player = game.players.get(target_id)
        
        # –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ä–∞–∑—É - —Ç–æ–ª—å–∫–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è
        checked_mention = f"@{target_player.username}" if target_player and target_player.username else (target_player.first_name if target_player else "–∏–≥—Ä–æ–∫")
        await callback.bot.send_message(user_id, f"‚úÖ –í—ã –ø—Ä–æ–≤–µ—Ä–∏–ª–∏ {checked_mention}. –†–µ–∑—É–ª—å—Ç–∞—Ç –±—É–¥–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω —É—Ç—Ä–æ–º.")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≤–µ—Ä—à–µ–Ω—ã –ª–∏ –≤—Å–µ –Ω–æ—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è (–æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑)
        game = game_manager.get_game(group_chat_key)
        if game and game_manager.all_night_actions_completed(group_chat_key) and not game.all_actions_notified:
            game.all_actions_notified = True
            await callback.bot.send_message(
                get_chat_id_from_key(group_chat_key),
                "üåô –í—Å–µ –Ω–æ—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—É—á–µ–Ω—ã. –ù–æ—á—å –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –¥–æ —Ä–∞—Å—Å–≤–µ—Ç–∞.",
                message_thread_id=get_thread_id_from_key(group_chat_key)
            )
    else:
        logger.warning("process_night_action –≤–µ—Ä–Ω—É–ª False –¥–ª—è –∫–æ–º–∏—Å—Å–∞—Ä–∞")
        await callback.answer("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∏–≥—Ä–∞ –≤ –Ω–æ—á–Ω–æ–π —Ñ–∞–∑–µ –∏ –≤—ã –∂–∏–≤—ã.", show_alert=True)
    
    await callback.answer()

@router.callback_query(F.data.startswith("butterfly_distract:"))
async def butterfly_distract_action(callback: CallbackQuery):
    """–ù–æ—á–Ω–∞—è –±–∞–±–æ—á–∫–∞ –æ—Ç–≤–ª–µ–∫–∞–µ—Ç –∏–≥—Ä–æ–∫–∞"""
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —Ä–∞–±–æ—Ç—É –≤ –¥–∞–Ω–Ω–æ–π —Ç–µ–º–µ (–¥–ª—è –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ø—Ä–æ–ø—É—Å–∫–∞–µ–º)
    if callback.message.chat.type != "private" and not check_topic_permission(callback.message):
        await callback.answer("‚ö†Ô∏è –î–µ–π—Å—Ç–≤–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ —Ç–æ–ª—å–∫–æ –≤ —Ç–µ–º–µ ¬´–ò–≥—Ä–∞ –≤ ¬´–ú–∞—Ñ–∏—é¬ª¬ª!", show_alert=True)
        return
    
    user_id = callback.from_user.id
    logger.debug(f"butterfly_distract_action: callback.data: {callback.data}")
    parts = callback.data.split(":")
    group_chat_key = parts[1]
    target_id = None if parts[2] == "skip" else int(parts[2])

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏–≥—Ä–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –≤ –Ω–æ—á–Ω–æ–π —Ñ–∞–∑–µ
    game = game_manager.get_game(group_chat_key)
    if not game:
        await callback.answer("‚ùå –ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!", show_alert=True)
        return
    
    if game.phase != GamePhase.NIGHT:
        await callback.answer("‚ùå –°–µ–π—á–∞—Å –Ω–µ –Ω–æ—á—å!", show_alert=True)
        return
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏–≥—Ä–æ–∫ –∂–∏–≤ –∏ –∏–º–µ–µ—Ç —Ä–æ–ª—å –Ω–æ—á–Ω–æ–π –±–∞–±–æ—á–∫–∏
    player = game.players.get(user_id)
    if not player or not player.is_alive:
        await callback.answer("‚ùå –í—ã –º–µ—Ä—Ç–≤—ã –∏–ª–∏ –Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç–µ –≤ –∏–≥—Ä–µ!", show_alert=True)
        return
    
    if player.role != PlayerRole.BUTTERFLY:
        await callback.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç —Ä–æ–ª–∏ –Ω–æ—á–Ω–æ–π –±–∞–±–æ—á–∫–∏!", show_alert=True)
        return

    if game_manager.process_night_action(group_chat_key, user_id, "butterfly_distract", target_id):
        if target_id:
            target_player = game_manager.get_game(group_chat_key).players.get(target_id)
            mention = f"@{target_player.username}" if target_player and target_player.username else (target_player.first_name if target_player else "–∏–≥—Ä–æ–∫")
            await callback.bot.send_message(user_id, f"‚úÖ –í—ã –æ—Ç–≤–ª–µ–∫–ª–∏ {mention}! –£ –Ω–µ–≥–æ –±—ã–ª–∞ –±—É—Ä–Ω–∞—è –Ω–æ—á—å.")
        else:
            await callback.bot.send_message(user_id, "‚úÖ –í—ã —Ä–µ—à–∏–ª–∏ –Ω–∏–∫–æ–≥–æ –Ω–µ –æ—Ç–≤–ª–µ–∫–∞—Ç—å!")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≤–µ—Ä—à–µ–Ω—ã –ª–∏ –≤—Å–µ –Ω–æ—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è (–æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑)
        game = game_manager.get_game(group_chat_key)
        if game and game_manager.all_night_actions_completed(group_chat_key) and not game.all_actions_notified:
            game.all_actions_notified = True
            await callback.bot.send_message(
                get_chat_id_from_key(group_chat_key),
                "üåô –í—Å–µ –Ω–æ—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—É—á–µ–Ω—ã. –ù–æ—á—å –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –¥–æ —Ä–∞—Å—Å–≤–µ—Ç–∞.",
                message_thread_id=get_thread_id_from_key(group_chat_key)
            )
    else:
        logger.warning("process_night_action –≤–µ—Ä–Ω—É–ª False –¥–ª—è –Ω–æ—á–Ω–æ–π –±–∞–±–æ—á–∫–∏")
        await callback.answer("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∏–≥—Ä–∞ –≤ –Ω–æ—á–Ω–æ–π —Ñ–∞–∑–µ –∏ –≤—ã –∂–∏–≤—ã.", show_alert=True)
    
    await callback.answer()

@router.callback_query(F.data.startswith("vote_"))
async def process_vote(callback: CallbackQuery):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≥–æ–ª–æ—Å –∏–≥—Ä–æ–∫–∞"""
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —Ä–∞–±–æ—Ç—É –≤ –¥–∞–Ω–Ω–æ–π —Ç–µ–º–µ
    if not check_topic_permission(callback.message):
        await callback.answer("‚ö†Ô∏è –î–µ–π—Å—Ç–≤–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ —Ç–æ–ª—å–∫–æ –≤ —Ç–µ–º–µ ¬´–ò–≥—Ä–∞ –≤ ¬´–ú–∞—Ñ–∏—é¬ª¬ª!", show_alert=True)
        return
    
    chat_key = get_chat_key(callback.message)
    user_id = callback.from_user.id
    
    if callback.data == "vote_skip":
        logger.debug(f"process_vote: –∏–≥—Ä–æ–∫ {user_id} –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –≥–æ–ª–æ—Å –≤ —á–∞—Ç–µ {chat_key}")
        game = game_manager.get_game(chat_key)
        if not game or game.phase != GamePhase.VOTING:
            try:
                await callback.answer("‚ùå –°–µ–π—á–∞—Å –Ω–µ –∏–¥—ë—Ç –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ.", show_alert=True)
            except TelegramBadRequest:
                pass
            return
        voter = game.players.get(user_id)
        if not voter or not voter.is_alive:
            try:
                await callback.answer("‚ùå –ì–æ–ª–æ—Å–æ–≤–∞—Ç—å –º–æ–≥—É—Ç —Ç–æ–ª—å–∫–æ –∂–∏–≤—ã–µ –∏–≥—Ä–æ–∫–∏.", show_alert=True)
            except TelegramBadRequest:
                pass
            return
        if voter.has_voted:
            try:
                await callback.answer("‚ùå –í—ã —É–∂–µ —Å–¥–µ–ª–∞–ª–∏ –≤—ã–±–æ—Ä –≤ —ç—Ç–æ–º –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–∏.", show_alert=True)
            except TelegramBadRequest:
                pass
            return
        # –û—Ç–º–µ—á–∞–µ–º –ø—Ä–æ–ø—É—Å–∫ –≥–æ–ª–æ—Å–∞
        try:
            game.skipped_voters.add(user_id)
        except Exception:
            pass
        voter.has_voted = True
        # –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º —Ç–∞–±–ª–æ
        vote_counts = {}
        for tid in game.votes.values():
            vote_counts[tid] = vote_counts.get(tid, 0) + 1
        lines = ["üó≥Ô∏è –¢–µ–∫—É—â–∏–µ –≥–æ–ª–æ—Å–∞:"]
        for p in game.get_alive_players():
            cnt = vote_counts.get(p.user_id, 0)
            uname = f"@{p.username}" if p.username else None
            disp = f"{p.first_name}{f' ({uname})' if uname else ''}"
            lines.append(f"- {disp}: {cnt}")
        # –û—Ç–¥–µ–ª—å–Ω—ã–π –±–ª–æ–∫ ‚Äî –∫—Ç–æ –ø—Ä–æ–ø—É—Å—Ç–∏–ª –≥–æ–ª–æ—Å
        if game.skipped_voters:
            skipped_lines = []
            for uid in sorted(game.skipped_voters):
                pl = game.players.get(uid)
                if pl:
                    uname = f"@{pl.username}" if pl.username else None
                    disp = f"{pl.first_name}{f' ({uname})' if uname else ''}"
                    skipped_lines.append(f"‚Ä¢ {disp}")
            if skipped_lines:
                lines.append("\nüö´ –ü—Ä–æ–ø—É—Å—Ç–∏–ª–∏ –≥–æ–ª–æ—Å:")
                lines.extend(skipped_lines)
        scoreboard = "\n".join(lines)
        # –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Ç–∞–±–ª–æ
        try:
            if getattr(game, "current_voting_message_id", None):
                await callback.message.bot.delete_message(chat_id=callback.message.chat.id, message_id=game.current_voting_message_id)
        except TelegramBadRequest as e:
            logger.debug(f"process_vote(skip): –Ω–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Ç–∞–±–ª–æ: {e}")
        # –ü–µ—Ä–µ–≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ: –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å—Ç—Ä–æ–∏—Ç—Å—è –ø–æ –≤—Å–µ–º –∂–∏–≤—ã–º
        alive_for_keyboard = game.get_alive_players()
        sent = await callback.message.answer(
            f"‚úÖ –ì–æ–ª–æ—Å –ø—Ä–æ–ø—É—â–µ–Ω!\n\n" + scoreboard,
            reply_markup=get_voting_keyboard(alive_for_keyboard)
        )
        try:
            game.current_voting_message_id = sent.message_id
        except Exception:
            pass
        try:
            await callback.answer()
        except TelegramBadRequest:
            pass
        return
    
    target_id = int(callback.data.split("_")[1])
    
    logger.debug(f"process_vote: –ø–æ–ø—ã—Ç–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –≥–æ–ª–æ—Å –∏–≥—Ä–æ–∫–∞ {user_id} –∑–∞ {target_id} –≤ —á–∞—Ç–µ {chat_key}")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏–≥—Ä–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –≤ —Ñ–∞–∑–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è
    game = game_manager.get_game(chat_key)
    if not game:
        await callback.answer("‚ùå –ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!", show_alert=True)
        return
    
    if game.phase != GamePhase.VOTING:
        await callback.answer("‚ùå –°–µ–π—á–∞—Å –Ω–µ –∏–¥—ë—Ç –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ!", show_alert=True)
        return
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏–≥—Ä–æ–∫ –∂–∏–≤ –∏ –Ω–µ –≥–æ–ª–æ—Å–æ–≤–∞–ª
    voter = game.players.get(user_id)
    if not voter or not voter.is_alive:
        await callback.answer("‚ùå –ì–æ–ª–æ—Å–æ–≤–∞—Ç—å –º–æ–≥—É—Ç —Ç–æ–ª—å–∫–æ –∂–∏–≤—ã–µ –∏–≥—Ä–æ–∫–∏!", show_alert=True)
        return
    
    if voter.has_voted:
        await callback.answer("‚ùå –í—ã —É–∂–µ —Å–¥–µ–ª–∞–ª–∏ –≤—ã–±–æ—Ä –≤ —ç—Ç–æ–º –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–∏!", show_alert=True)
        return
    
    if game_manager.process_vote(chat_key, user_id, target_id):
        logger.debug("process_vote: –≥–æ–ª–æ—Å –æ–±—Ä–∞–±–æ—Ç–∞–Ω —É—Å–ø–µ—à–Ω–æ")
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–æ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è: –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—á–µ—Ç
        game = game_manager.get_game(chat_key)
        target_player = game.players.get(target_id)
        # –°—á–∏—Ç–∞–µ–º —Ç–µ–∫—É—â–∏–µ –≥–æ–ª–æ—Å–∞
        vote_counts = {}
        for tid in game.votes.values():
            vote_counts[tid] = vote_counts.get(tid, 0) + 1
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É —Å–æ —Å—á–µ—Ç–æ–º
        lines = ["üó≥Ô∏è –¢–µ–∫—É—â–∏–µ –≥–æ–ª–æ—Å–∞:"]
        for p in game.get_alive_players():
            cnt = vote_counts.get(p.user_id, 0)
            uname = f"@{p.username}" if p.username else None
            disp = f"{p.first_name}{f' ({uname})' if uname else ''}"
            lines.append(f"- {disp}: {cnt}")
        # –û—Ç–¥–µ–ª—å–Ω—ã–π –±–ª–æ–∫ ‚Äî –∫—Ç–æ –ø—Ä–æ–ø—É—Å—Ç–∏–ª –≥–æ–ª–æ—Å
        if getattr(game, "skipped_voters", None) and game.skipped_voters:
            skipped_lines = []
            for uid in sorted(game.skipped_voters):
                pl = game.players.get(uid)
                if pl:
                    uname = f"@{pl.username}" if pl.username else None
                    disp = f"{pl.first_name}{f' ({uname})' if uname else ''}"
                    skipped_lines.append(f"‚Ä¢ {disp}")
            if skipped_lines:
                lines.append("\nüö´ –ü—Ä–æ–ø—É—Å—Ç–∏–ª–∏ –≥–æ–ª–æ—Å:")
                lines.extend(skipped_lines)
        scoreboard = "\n".join(lines)
        
        # –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ–º
        try:
            if getattr(game, "current_voting_message_id", None):
                await callback.message.bot.delete_message(chat_id=callback.message.chat.id, message_id=game.current_voting_message_id)
        except TelegramBadRequest as e:
            logger.debug(f"process_vote: –Ω–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è: {e}")
        
        # –ü–µ—Ä–µ–≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ: –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å—Ç—Ä–æ–∏—Ç—Å—è –ø–æ –≤—Å–µ–º –∂–∏–≤—ã–º
        alive_for_keyboard = game.get_alive_players()
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–º —Ç–∞–±–ª–æ
        target_mention = f"@{target_player.username}" if target_player and target_player.username else (target_player.first_name if target_player else "–∏–≥—Ä–æ–∫")
        sent = await callback.message.answer(
            f"‚úÖ –ì–æ–ª–æ—Å –∑–∞ {target_mention} —É—á—Ç—ë–Ω!\n\n" + scoreboard,
            reply_markup=get_voting_keyboard(alive_for_keyboard)
        )
        try:
            game.current_voting_message_id = sent.message_id
        except Exception:
            pass
    else:
        logger.warning("process_vote: –≥–æ–ª–æ—Å –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω")
        try:
            await callback.answer("‚ùå –û—à–∏–±–∫–∞! –í–æ–∑–º–æ–∂–Ω–æ, –≤—ã —É–∂–µ –≥–æ–ª–æ—Å–æ–≤–∞–ª–∏ –∏–ª–∏ –∏–≥—Ä–∞ –Ω–µ –≤ —Ñ–∞–∑–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è.", show_alert=True)
        except TelegramBadRequest:
            pass
        return

    try:
        await callback.answer()
    except TelegramBadRequest:
        pass

@router.callback_query(F.data == "back_to_main")
async def back_to_main_menu(callback: CallbackQuery):
    """–í–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"""
    # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏–∑ –º–∞—Å—Å–∏–≤–∞
    greeting = random.choice(DON_VITTE_GREETINGS)
    
    await callback.message.answer(
        greeting,
        reply_markup=get_main_menu_keyboard()
    )
    await callback.answer()
